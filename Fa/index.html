<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Brasileir√£o 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.08em; }
        body { background: #09090b; }
        .card { background: #141416; border: 1px solid rgba(255,255,255,0.06); }
        .card:hover { border-color: rgba(255,255,255,0.1); }
        .btn-primary { background: #16a34a; }
        .btn-primary:hover { background: #22c55e; }
        .campo-bg {
            background: 
                repeating-linear-gradient(
                    180deg,
                    #1a5c2e 0px,
                    #1a5c2e 40px,
                    #166b34 40px,
                    #166b34 80px
                );
            position: relative;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        /* Linhas do campo */
        .campo-linhas {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Linha do meio */
        .campo-linhas::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 8%;
            right: 8%;
            height: 2px;
            background: rgba(255,255,255,0.4);
        }
        
        /* C√≠rculo central */
        .campo-linhas::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 50%;
        }
        
        /* √Årea do goleiro (topo) */
        .area-gol-topo {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 45%;
            height: 18%;
            border: 2px solid rgba(255,255,255,0.4);
            border-top: none;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Pequena √°rea (topo) */
        .pequena-area-topo {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 22%;
            height: 8%;
            border: 2px solid rgba(255,255,255,0.4);
            border-top: none;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Meia lua √°rea (topo) */
        .meia-lua-topo {
            position: absolute;
            top: 16%;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 25px;
            border: 2px solid rgba(255,255,255,0.4);
            border-top: none;
            border-radius: 0 0 50px 50px;
            pointer-events: none;
            z-index: 1;
        }
        
        /* √Årea do ataque (baixo) */
        .area-ataque {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 45%;
            height: 18%;
            border: 2px solid rgba(255,255,255,0.4);
            border-bottom: none;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Pequena √°rea (baixo) */
        .pequena-area-baixo {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 22%;
            height: 8%;
            border: 2px solid rgba(255,255,255,0.4);
            border-bottom: none;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Meia lua √°rea (baixo) */
        .meia-lua-baixo {
            position: absolute;
            bottom: 16%;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 25px;
            border: 2px solid rgba(255,255,255,0.4);
            border-bottom: none;
            border-radius: 50px 50px 0 0;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Ponto central */
        .ponto-central {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
        }
        
        .player-slot { z-index: 10; }
        .sync-log { max-height: 300px; overflow-y: auto; }
        .sync-log::-webkit-scrollbar { width: 4px; }
        .sync-log::-webkit-scrollbar-thumb { background: #22c55e; border-radius: 2px; }
        body.modal-open { overflow: hidden; position: fixed; width: 100%; height: 100%; }
        .input-dark { background: #18181b; border: 1px solid rgba(255,255,255,0.08); }
        .input-dark:focus { outline: none; border-color: #22c55e; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>
    
    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyB92rpIZQsvDzWmOV2sb1bgRmeJl1spTEo",
            authDomain: "fantasy-brasileirao.firebaseapp.com",
            databaseURL: "https://fantasy-brasileirao-default-rtdb.firebaseio.com",
            projectId: "fantasy-brasileirao",
            storageBucket: "fantasy-brasileirao.firebasestorage.app",
            messagingSenderId: "296468877202",
            appId: "1:296468877202:web:34ecb181755f7e88a93b4b"
        };

        // Inicializar Firebase
        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('üî• Firebase conectado!');
        } catch (e) {
            console.log('Firebase n√£o configurado, usando localStorage');
        }

        // ==================== CONFIGURA√á√ÉO API ====================
        const API_KEY = "7323cf974437eebed0866f3138cea56d";
        const API_BASE = "https://v3.football.api-sports.io";
        const FIREBASE_URL = "https://fantasy-brasileirao-default-rtdb.firebaseio.com";
        const LEAGUE_ID = 71; // Brasileir√£o S√©rie A
        const SEASON = 2026;
        const SEASON_FALLBACK = 2025;

        // ==================== T√âCNICOS 2026 ====================
        const TECNICOS_2026 = [
            { id: 1, name: "Abel Ferreira", team: "Palmeiras", teamId: 121, country: "üáµüáπ", photo: "https://media.api-sports.io/football/coachs/15939.png" },
            { id: 2, name: "Filipe Lu√≠s", team: "Flamengo", teamId: 127, country: "üáßüá∑", photo: "https://media.api-sports.io/football/players/161889.png" },
            { id: 3, name: "Dorival J√∫nior", team: "Corinthians", teamId: 131, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/3051.png" },
            { id: 4, name: "Hern√°n Crespo", team: "S√£o Paulo", teamId: 126, country: "üá¶üá∑", photo: "https://media.api-sports.io/football/coachs/2878.png" },
            { id: 5, name: "Mart√≠n Anselmi", team: "Botafogo", teamId: 120, country: "üá¶üá∑", photo: "https://media.api-sports.io/football/coachs/16577.png" },
            { id: 6, name: "Luis Zubeld√≠a", team: "Fluminense", teamId: 124, country: "üá¶üá∑", photo: "https://media.api-sports.io/football/coachs/5971.png" },
            { id: 7, name: "Jorge Sampaoli", team: "Atl√©tico-MG", teamId: 1062, country: "üá¶üá∑", photo: "https://media.api-sports.io/football/coachs/1504.png" },
            { id: 8, name: "Paulo Pezzolano", team: "Internacional", teamId: 119, country: "üá∫üáæ", photo: "https://media.api-sports.io/football/coachs/14809.png" },
            { id: 9, name: "Lu√≠s Castro", team: "Gr√™mio", teamId: 130, country: "üáµüáπ", photo: "https://media.api-sports.io/football/coachs/11451.png" },
            { id: 10, name: "Tite", team: "Cruzeiro", teamId: 129, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/316.png" },
            { id: 11, name: "Rog√©rio Ceni", team: "Bahia", teamId: 118, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/1520.png" },
            { id: 12, name: "Juan Pablo Vojvoda", team: "Santos", teamId: 128, country: "üá¶üá∑", photo: "https://media.api-sports.io/football/coachs/5969.png" },
            { id: 13, name: "Fernando Diniz", team: "Vasco", teamId: 133, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/12802.png" },
            { id: 14, name: "Odair Hellmann", team: "Athletico-PR", teamId: 134, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/15935.png" },
            { id: 15, name: "Vagner Mancini", team: "Bragantino", teamId: 1193, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/3052.png" },
            { id: 16, name: "Jair Ventura", team: "Vit√≥ria", teamId: 2129, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/15937.png" },
            { id: 17, name: "Fernando Seabra", team: "Coritiba", teamId: 123, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/17046.png" },
            { id: 18, name: "Gilmar Dal Pozzo", team: "Chapecoense", teamId: 1196, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/15917.png" },
            { id: 19, name: "Rafael Guanaes", team: "Mirassol", teamId: 7848, country: "üáßüá∑", photo: "https://media.api-sports.io/football/coachs/17689.png" },
            { id: 20, name: "Juan Carlos Osorio", team: "Remo", teamId: 1186, country: "üá®üá¥", photo: "https://media.api-sports.io/football/coachs/3049.png" }
        ];

        // ==================== STATE ====================
        let state = {
            screen: 'auth',
            authMode: 'login',
            currentUser: null,
            users: {},
            teamName: '',
            teamLogo: null,
            formation: '4-3-3',
            starters: Array(11).fill(null),
            reserves: Array(7).fill(null),
            coach: null,
            isConfirmed: false,
            selectedRound: 1,
            currentRound: 1, // Rodada atual do campeonato (detectada automaticamente)
            
            // Sistema de Draft
            draftParticipants: [], // Lista de inscritos no draft
            draftOrder: [], // Ordem do snake draft
            draftCurrentPick: 0, // Pick atual
            draftRound: 1, // Rodada do draft
            draftStarted: false,
            draftCompleted: false,
            selectedDraftUser: null, // Usu√°rio selecionado para adicionar jogadores
            draftedPlayers: [], // IDs dos jogadores j√° escolhidos
            draftFilterPos: '', // Filtro de posi√ß√£o no draft
            draftFilterTeam: '', // Filtro de time no draft
            draftSearch: '', // Busca no draft
            draftTab: 'players', // Aba atual no draft (players/coaches)
            viewingDraftUser: null, // Usu√°rio sendo visualizado na aba draft
            draftSlotType: null, // Tipo de slot selecionado (starter/reserve)
            draftSlotIndex: null, // √çndice do slot selecionado
            isAdmin: false, // Se √© admin
            draftChatMessages: [], // Mensagens do chat do draft
            draftPicks: [], // Hist√≥rico de picks do draft
            players: [],
            teams: [],
            coaches: TECNICOS_2026,
            isLoading: false,
            syncStatus: '',
            syncLogs: [],
            modal: null,
            slotIndex: null,
            slotType: null,
            scores: {},
            filterTeam: '',
            filterPosition: '',
            searchName: '',
            scrollY: 0,
            isUpdatingScores: false,
            autoSyncInterval: null,
            scoreUpdateInterval: null,
            // Sistema de Mercado de Transfer√™ncias
            offers: [],
            selectedPlayerForOffer: null,
            offerTargetUser: null,
            marketPlayerToSell: null,
            marketPlayerToBuy: null,
            // Sistema de visualiza√ß√£o de times
            viewingUser: null,
            // Sistema de substitui√ß√µes
            substitutionMode: false,
            selectedForSubstitution: null,
            secondSelection: null,
            // Sistema de pre√ßos do mercado
            playerPrices: {},
            marketFilter: 'all',
            marketSearch: '',
            marketTab: 'buy',
            buyingPlayerId: null,
            swapPlayerId: null,
            // Jogos ao vivo
            liveFixtures: [],
            isLoadingFixtures: false,
            fixturesLastUpdate: null,
            // Pontua√ß√£o ao vivo
            liveScoresUpdating: false,
            hasLiveGames: false,
            // Chat
            chatMessages: [],
            chatInput: '',
            // Perfil
            favoriteTeam: null, // Time que torce
            userBio: '', // Bio/descri√ß√£o
            // Mensagens privadas
            privateMessages: [],
            selectedChatUser: null, // Usu√°rio selecionado para chat privado
            viewingProfile: null // Perfil sendo visualizado
        };

        // ==================== FUN√á√ïES AUXILIARES ====================
        
        // Logos dos times do Brasileir√£o
        const TEAM_LOGOS = {
            'Flamengo': 'https://media.api-sports.io/football/teams/127.png',
            'Palmeiras': 'https://media.api-sports.io/football/teams/121.png',
            'S√£o Paulo': 'https://media.api-sports.io/football/teams/126.png',
            'Corinthians': 'https://media.api-sports.io/football/teams/131.png',
            'Fluminense': 'https://media.api-sports.io/football/teams/124.png',
            'Botafogo': 'https://media.api-sports.io/football/teams/120.png',
            'Vasco': 'https://media.api-sports.io/football/teams/133.png',
            'Gr√™mio': 'https://media.api-sports.io/football/teams/130.png',
            'Internacional': 'https://media.api-sports.io/football/teams/119.png',
            'Atl√©tico-MG': 'https://media.api-sports.io/football/teams/1062.png',
            'Cruzeiro': 'https://media.api-sports.io/football/teams/129.png',
            'Santos': 'https://media.api-sports.io/football/teams/128.png',
            'Bahia': 'https://media.api-sports.io/football/teams/118.png',
            'Vit√≥ria': 'https://media.api-sports.io/football/teams/2129.png',
            'Athletico-PR': 'https://media.api-sports.io/football/teams/134.png',
            'Coritiba': 'https://media.api-sports.io/football/teams/123.png',
            'Bragantino': 'https://media.api-sports.io/football/teams/1193.png',
            'Fortaleza': 'https://media.api-sports.io/football/teams/1189.png',
            'Cear√°': 'https://media.api-sports.io/football/teams/2304.png',
            'Sport': 'https://media.api-sports.io/football/teams/137.png',
            'Juventude': 'https://media.api-sports.io/football/teams/1185.png',
            'Cuiab√°': 'https://media.api-sports.io/football/teams/1200.png',
            'Am√©rica-MG': 'https://media.api-sports.io/football/teams/1191.png',
            'Goi√°s': 'https://media.api-sports.io/football/teams/1195.png',
            'Ava√≠': 'https://media.api-sports.io/football/teams/1198.png',
            'Mirassol': 'https://media.api-sports.io/football/teams/7848.png',
            'Chapecoense': 'https://media.api-sports.io/football/teams/1196.png',
            'Remo': 'https://media.api-sports.io/football/teams/1186.png'
        };
        
        // Fun√ß√£o para obter logo do time
        function getTeamLogo(teamName) {
            if (!teamName) return null;
            return TEAM_LOGOS[teamName] || null;
        }
        
        // Garante que um valor seja um array (Firebase pode retornar objetos)
        function ensureArray(value, defaultLength = 0) {
            if (!value) return Array(defaultLength).fill(null);
            if (Array.isArray(value)) return value;
            // Se for objeto, converter para array
            if (typeof value === 'object') {
                const arr = [];
                Object.keys(value).forEach(key => {
                    const idx = parseInt(key);
                    if (!isNaN(idx)) {
                        arr[idx] = value[key];
                    }
                });
                while (arr.length < defaultLength) arr.push(null);
                return arr;
            }
            return Array(defaultLength).fill(null);
        }

        // ==================== SISTEMA DE PRE√áOS ====================
        
        // Pre√ßo BASE igual para todos - o desempenho √© que muda o pre√ßo!
        const BASE_PRICE = 100;

        // Calcula pre√ßo do jogador baseado no desempenho (pontos acumulados)
        function getPlayerPrice(playerId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return BASE_PRICE;
            
            // Calcular pontos TOTAIS acumulados deste jogador em todas as rodadas
            let totalPoints = 0;
            let roundsPlayed = 0;
            
            // Verificar pontua√ß√µes de todos os usu√°rios para este jogador
            Object.values(state.users).forEach(user => {
                if (user.scores) {
                    Object.entries(user.scores).forEach(([key, round]) => {
                        if (key !== 'market' && round.players && round.players[playerId] !== undefined) {
                            totalPoints += round.players[playerId];
                            roundsPlayed++;
                        }
                    });
                }
            });
            
            // Se n√£o tem dados de rodadas, pre√ßo base
            if (roundsPlayed === 0) {
                return BASE_PRICE;
            }
            
            // Calcular m√©dia de pontos por rodada
            const avgPoints = totalPoints / roundsPlayed;
            
            // PRE√áO = BASE + (m√©dia √ó multiplicador)
            // Quanto melhor a m√©dia, mais caro!
            // M√©dia 10+ = craque = muito caro
            // M√©dia 0 ou negativa = ruim = barato
            
            let price;
            if (avgPoints >= 12) {
                // Craque absoluto - melhor do campeonato
                price = BASE_PRICE + (avgPoints * 50); // Ex: avg 12 = 100 + 600 = 700
            } else if (avgPoints >= 8) {
                // Estrela - muito bom
                price = BASE_PRICE + (avgPoints * 40); // Ex: avg 8 = 100 + 320 = 420
            } else if (avgPoints >= 5) {
                // Bom jogador
                price = BASE_PRICE + (avgPoints * 30); // Ex: avg 5 = 100 + 150 = 250
            } else if (avgPoints >= 2) {
                // Regular
                price = BASE_PRICE + (avgPoints * 20); // Ex: avg 2 = 100 + 40 = 140
            } else if (avgPoints >= 0) {
                // Abaixo da m√©dia
                price = BASE_PRICE + (avgPoints * 10); // Ex: avg 1 = 100 + 10 = 110
            } else {
                // Negativo - jogando mal = mais barato pra apostar
                price = Math.max(50, BASE_PRICE + (avgPoints * 10)); // Ex: avg -2 = 100 - 20 = 80
            }
            
            return Math.round(price);
        }

        // ==================== JOGOS AO VIVO ====================
        
        // Traduz status do jogo para portugu√™s
        function getMatchStatus(status) {
            const statusMap = {
                'TBD': { text: 'A definir', color: 'text-zinc-500', live: false },
                'NS': { text: 'N√£o iniciado', color: 'text-zinc-500', live: false },
                '1H': { text: '1¬∫ TEMPO', color: 'text-green-400', live: true },
                'HT': { text: 'INTERVALO', color: 'text-yellow-400', live: true },
                '2H': { text: '2¬∫ TEMPO', color: 'text-green-400', live: true },
                'ET': { text: 'PRORROGA√á√ÉO', color: 'text-orange-400', live: true },
                'BT': { text: 'INTERVALO PRORR.', color: 'text-yellow-400', live: true },
                'P': { text: 'P√äNALTIS', color: 'text-red-400', live: true },
                'SUSP': { text: 'Suspenso', color: 'text-red-500', live: false },
                'INT': { text: 'Interrompido', color: 'text-red-500', live: true },
                'FT': { text: 'Encerrado', color: 'text-zinc-400', live: false },
                'AET': { text: 'Encerrado (Prorr.)', color: 'text-zinc-400', live: false },
                'PEN': { text: 'Encerrado (Pen.)', color: 'text-zinc-400', live: false },
                'PST': { text: 'Adiado', color: 'text-orange-500', live: false },
                'CANC': { text: 'Cancelado', color: 'text-red-500', live: false },
                'ABD': { text: 'Abandonado', color: 'text-red-500', live: false },
                'AWD': { text: 'W.O.', color: 'text-zinc-500', live: false },
                'WO': { text: 'W.O.', color: 'text-zinc-500', live: false },
                'LIVE': { text: 'AO VIVO', color: 'text-green-400', live: true }
            };
            return statusMap[status] || { text: status, color: 'text-zinc-500', live: false };
        }
        
        // CACHE_TIME: tempo em ms que os dados ficam v√°lidos (2 minutos)
        const FIXTURES_CACHE_TIME = 2 * 60 * 1000;
        
        // Detectar rodada atual/pr√≥xima do campeonato
        async function detectCurrentRound() {
            try {
                // Primeiro tentar cache do Firebase
                const cacheRes = await fetch(`${FIREBASE_URL}/cache/current_round.json`);
                const cacheData = await cacheRes.json();
                
                // Cache v√°lido por 30 minutos
                if (cacheData && cacheData.round && cacheData.updatedAt) {
                    const cacheAge = Date.now() - cacheData.updatedAt;
                    if (cacheAge < 30 * 60 * 1000) { // 30 minutos
                        state.currentRound = cacheData.round;
                        state.selectedRound = cacheData.round;
                        console.log(`üìÖ Rodada atual: ${cacheData.round} (cache)`);
                        return;
                    }
                }
                
                // Buscar da API - jogos de hoje ou pr√≥ximos
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                let currentRound = 1;
                let foundRound = false;
                
                // 1. Verificar se tem jogo AO VIVO agora
                try {
                    const liveRes = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON}&live=all`);
                    if (liveRes.response && liveRes.response.length > 0) {
                        const roundStr = liveRes.response[0].league.round;
                        const match = roundStr.match(/Regular Season - (\d+)/);
                        if (match) {
                            currentRound = parseInt(match[1]);
                            foundRound = true;
                            console.log(`üî¥ Jogo ao vivo! Rodada ${currentRound}`);
                        }
                    }
                } catch (e) {
                    console.log('Sem jogos ao vivo');
                }
                
                // 2. Se n√£o tem ao vivo, buscar jogos de HOJE
                if (!foundRound) {
                    try {
                        const todayRes = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON}&date=${today}`);
                        if (todayRes.response && todayRes.response.length > 0) {
                            const roundStr = todayRes.response[0].league.round;
                            const match = roundStr.match(/Regular Season - (\d+)/);
                            if (match) {
                                currentRound = parseInt(match[1]);
                                foundRound = true;
                                console.log(`üìÖ Jogos hoje! Rodada ${currentRound}`);
                            }
                        }
                    } catch (e) {
                        console.log('Sem jogos hoje');
                    }
                }
                
                // 3. Se n√£o tem hoje, buscar PR√ìXIMO jogo
                if (!foundRound) {
                    try {
                        const nextRes = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON}&next=1`);
                        if (nextRes.response && nextRes.response.length > 0) {
                            const roundStr = nextRes.response[0].league.round;
                            const match = roundStr.match(/Regular Season - (\d+)/);
                            if (match) {
                                currentRound = parseInt(match[1]);
                                foundRound = true;
                                console.log(`‚è≠Ô∏è Pr√≥ximo jogo: Rodada ${currentRound}`);
                            }
                        }
                    } catch (e) {
                        console.log('Erro ao buscar pr√≥ximo jogo');
                    }
                }
                
                // 4. Se ainda n√£o achou, buscar √∫ltimo jogo encerrado
                if (!foundRound) {
                    try {
                        const lastRes = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON}&last=1`);
                        if (lastRes.response && lastRes.response.length > 0) {
                            const roundStr = lastRes.response[0].league.round;
                            const match = roundStr.match(/Regular Season - (\d+)/);
                            if (match) {
                                currentRound = parseInt(match[1]);
                                console.log(`‚úÖ √öltima rodada jogada: ${currentRound}`);
                            }
                        }
                    } catch (e) {
                        console.log('Erro ao buscar √∫ltimo jogo');
                    }
                }
                
                // Salvar no Firebase
                await fetch(`${FIREBASE_URL}/cache/current_round.json`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        round: currentRound,
                        updatedAt: Date.now()
                    })
                });
                
                state.currentRound = currentRound;
                state.selectedRound = currentRound;
                console.log(`üìÖ Rodada definida: ${currentRound}`);
                
            } catch (e) {
                console.error('Erro ao detectar rodada:', e);
                state.currentRound = 1;
                state.selectedRound = 1;
            }
        }
        
        // Buscar jogos da rodada - COM CACHE NO FIREBASE
        async function fetchLiveFixtures() {
            if (state.isLoadingFixtures) return;
            state.isLoadingFixtures = true;
            
            const cacheKey = `fixtures_round_${state.selectedRound}`;
            
            try {
                // 1. Primeiro, tentar ler do Firebase (cache compartilhado)
                const cacheRes = await fetch(`${FIREBASE_URL}/cache/${cacheKey}.json`);
                const cacheData = await cacheRes.json();
                
                if (cacheData && cacheData.fixtures && cacheData.fixtures.length > 0 && cacheData.updatedAt) {
                    const cacheAge = Date.now() - cacheData.updatedAt;
                    
                    // Se o cache √© recente (< 2 min), usar ele
                    if (cacheAge < FIXTURES_CACHE_TIME) {
                        console.log(`üìã Usando cache do Firebase (${Math.round(cacheAge/1000)}s atr√°s)`);
                        // Filtrar fixtures v√°lidos (todos os campos necess√°rios)
                        state.liveFixtures = (cacheData.fixtures || []).filter(f => 
                            f && f.fixture && f.fixture.status && f.teams && f.teams.home && f.teams.away && f.goals !== undefined
                        );
                        
                        // Se filtrou tudo, cache est√° corrompido - buscar da API
                        if (state.liveFixtures.length === 0 && cacheData.fixtures.length > 0) {
                            console.log('‚ö†Ô∏è Cache corrompido, buscando da API...');
                        } else {
                            state.fixturesLastUpdate = cacheData.updatedAt;
                            state.isLoadingFixtures = false;
                            render();
                            return;
                        }
                    }
                }
                
                // 2. Cache velho ou inexistente - buscar da API
                console.log('üåê Buscando da API-Football...');
                let fixtures = [];
                
                // Tentar buscar por rodada
                try {
                    const res = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON}&round=Regular Season - ${state.selectedRound}`);
                    if (res.response && res.response.length > 0) {
                        fixtures = res.response;
                        console.log(`‚úÖ Encontrados ${fixtures.length} jogos da rodada ${state.selectedRound}`);
                    }
                } catch (e) {
                    console.log('Erro ao buscar por rodada:', e);
                }
                
                // Se n√£o achou, tentar temporada fallback
                if (fixtures.length === 0) {
                    try {
                        const res2 = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON_FALLBACK}&round=Regular Season - ${state.selectedRound}`);
                        if (res2.response && res2.response.length > 0) {
                            fixtures = res2.response;
                            console.log(`‚úÖ Encontrados ${fixtures.length} jogos (fallback 2025)`);
                        }
                    } catch (e) {
                        console.log('Erro ao buscar fallback:', e);
                    }
                }
                
                // Se ainda n√£o achou, buscar jogos de HOJE
                if (fixtures.length === 0) {
                    try {
                        const today = new Date().toISOString().split('T')[0];
                        const res3 = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON}&date=${today}`);
                        if (res3.response && res3.response.length > 0) {
                            fixtures = res3.response;
                            console.log(`‚úÖ Encontrados ${fixtures.length} jogos de hoje`);
                        }
                    } catch (e) {
                        console.log('Erro ao buscar jogos de hoje:', e);
                    }
                }
                
                // 3. Salvar no Firebase para outros usu√°rios usarem
                if (fixtures.length > 0) {
                    const cachePayload = {
                        fixtures: fixtures,
                        updatedAt: Date.now(),
                        round: state.selectedRound
                    };
                    
                    await fetch(`${FIREBASE_URL}/cache/${cacheKey}.json`, {
                        method: 'PUT',
                        body: JSON.stringify(cachePayload)
                    });
                    
                    console.log('üíæ Cache salvo no Firebase');
                }
                
                // Filtrar fixtures v√°lidos (todos os campos necess√°rios)
                state.liveFixtures = (fixtures || []).filter(f => 
                    f && f.fixture && f.fixture.status && f.teams && f.teams.home && f.teams.away && f.goals !== undefined
                );
                state.fixturesLastUpdate = Date.now();
                render();
                
            } catch (e) {
                console.error('Erro ao buscar jogos:', e);
            }
            
            state.isLoadingFixtures = false;
        }
        
        // Renderiza card de jogos
        function renderFixturesCard() {
            if (!state.liveFixtures || state.liveFixtures.length === 0) {
                return `
                    <div class="card rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-zinc-400 text-sm font-medium">JOGOS DA RODADA ${state.selectedRound}</h3>
                            <button onclick="fetchLiveFixtures()" class="text-zinc-500 hover:text-white p-1" title="Carregar jogos">
                                <svg class="w-4 h-4 ${state.isLoadingFixtures ? 'animate-spin' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                        </div>
                        <div class="text-center py-4">
                            <p class="text-zinc-500 text-sm mb-2">
                                ${state.isLoadingFixtures ? '‚è≥ Carregando...' : 'Clique para carregar os jogos'}
                            </p>
                            <button onclick="fetchLiveFixtures()" class="px-4 py-2 bg-green-500 hover:bg-green-400 text-white text-sm rounded-lg transition">
                                ${state.isLoadingFixtures ? 'Carregando...' : '‚öΩ Carregar Jogos'}
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Filtrar fixtures v√°lidos e ordenar: ao vivo primeiro, depois por hor√°rio
            const validFixtures = (state.liveFixtures || []).filter(f => 
                f && f.fixture && f.fixture.status && f.teams && f.teams.home && f.teams.away && f.goals !== undefined
            );
            
            const sorted = validFixtures.sort((a, b) => {
                const statusA = getMatchStatus(a.fixture?.status?.short || 'NS');
                const statusB = getMatchStatus(b.fixture?.status?.short || 'NS');
                if (statusA.live && !statusB.live) return -1;
                if (!statusA.live && statusB.live) return 1;
                return new Date(a.fixture?.date || 0) - new Date(b.fixture?.date || 0);
            });
            
            const hasLiveGames = sorted.some(f => getMatchStatus(f.fixture?.status?.short || 'NS').live);
            
            return `
                <div class="card rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-zinc-400 text-sm font-medium flex items-center gap-2">
                            JOGOS DA RODADA ${state.selectedRound}
                            ${hasLiveGames ? '<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>' : ''}
                        </h3>
                        <button onclick="fetchLiveFixtures()" class="text-zinc-500 hover:text-white p-1" title="Atualizar">
                            <svg class="w-4 h-4 ${state.isLoadingFixtures ? 'animate-spin' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${sorted.filter(f => f && f.fixture && f.teams && f.teams.home && f.teams.away && f.goals).map(f => {
                            const status = getMatchStatus(f.fixture?.status?.short || 'NS');
                            const elapsed = f.fixture?.status?.elapsed;
                            const date = new Date(f.fixture?.date || Date.now());
                            const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                            const homeName = f.teams?.home?.name || 'Time A';
                            const awayName = f.teams?.away?.name || 'Time B';
                            const homeLogo = f.teams?.home?.logo || '';
                            const awayLogo = f.teams?.away?.logo || '';
                            const homeGoals = f.goals?.home;
                            const awayGoals = f.goals?.away;
                            
                            return `
                                <div class="bg-zinc-800/50 rounded-lg p-2 ${status.live ? 'border border-green-500/30' : ''}">
                                    <div class="flex items-center justify-between text-xs mb-1">
                                        <span class="${status.color} font-medium">
                                            ${status.live && elapsed ? `${elapsed}'` : status.text}
                                        </span>
                                        ${!status.live && f.fixture?.status?.short === 'NS' ? `
                                            <span class="text-zinc-500">${dateStr} ${timeStr}</span>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 flex items-center gap-1.5 justify-end">
                                            <span class="text-white text-xs truncate">${homeName.split(' ').slice(-1)[0]}</span>
                                            <img src="${homeLogo}" class="w-5 h-5 object-contain" onerror="this.style.display='none'">
                                        </div>
                                        <div class="px-2 py-1 bg-zinc-900 rounded text-center min-w-[45px]">
                                            <span class="text-white font-bold text-sm">
                                                ${homeGoals !== null && homeGoals !== undefined ? homeGoals : '-'} - ${awayGoals !== null && awayGoals !== undefined ? awayGoals : '-'}
                                            </span>
                                        </div>
                                        <div class="flex-1 flex items-center gap-1.5">
                                            <img src="${awayLogo}" class="w-5 h-5 object-contain" onerror="this.style.display='none'">
                                            <span class="text-white text-xs truncate">${awayName.split(' ').slice(-1)[0]}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${state.fixturesLastUpdate ? `
                        <p class="text-zinc-600 text-xs text-center mt-2">
                            Atualizado ${getTimeAgo(state.fixturesLastUpdate)}
                        </p>
                    ` : ''}
                </div>
            `;
        }
        
        // Fun√ß√£o para mostrar tempo relativo
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'agora';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `h√° ${minutes} min`;
            const hours = Math.floor(minutes / 60);
            return `h√° ${hours}h`;
        }

        // Obt√©m todos os jogadores no mercado (n√£o escolhidos por nenhum usu√°rio)
        function getMarketPlayers() {
            // IDs de todos os jogadores j√° escalados por algu√©m
            const usedPlayerIds = new Set();
            
            Object.values(state.users).forEach(user => {
                if (user.starters) {
                    user.starters.forEach(p => { if (p) usedPlayerIds.add(p.id); });
                }
                if (user.reserves) {
                    user.reserves.forEach(p => { if (p) usedPlayerIds.add(p.id); });
                }
            });
            
            // Retornar jogadores dispon√≠veis
            return state.players.filter(p => !usedPlayerIds.has(p.id));
        }

        // Comprar jogador do mercado
        function buyPlayer(playerId, slotType, slotIndex) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return false;
            
            const price = getPlayerPrice(playerId);
            const userTotal = getTotalScore();
            
            if (price > userTotal) {
                alert(`Pontos insuficientes! Voc√™ tem ${userTotal} pts e o jogador custa ${price} pts.`);
                return false;
            }
            
            // Deduzir pontos (adicionar transa√ß√£o negativa)
            if (!state.scores['market']) {
                state.scores['market'] = { players: {}, coach: 0, purchases: [] };
            }
            state.scores['market'].purchases = state.scores['market'].purchases || [];
            state.scores['market'].purchases.push({
                type: 'buy',
                playerId: playerId,
                playerName: player.name,
                price: -price,
                date: new Date().toISOString()
            });
            
            // Adicionar jogador ao time
            if (slotType === 'starter') {
                state.starters[slotIndex] = player;
            } else {
                state.reserves[slotIndex] = player;
            }
            
            saveState();
            return true;
        }

        // Vender jogador
        function sellPlayer(slotType, slotIndex) {
            const player = slotType === 'starter' ? state.starters[slotIndex] : state.reserves[slotIndex];
            if (!player) return false;
            
            const price = getPlayerPrice(player.id);
            
            // Adicionar pontos de volta
            if (!state.scores['market']) {
                state.scores['market'] = { players: {}, coach: 0, purchases: [] };
            }
            state.scores['market'].purchases = state.scores['market'].purchases || [];
            state.scores['market'].purchases.push({
                type: 'sell',
                playerId: player.id,
                playerName: player.name,
                price: price,
                date: new Date().toISOString()
            });
            
            // Remover jogador do time
            if (slotType === 'starter') {
                state.starters[slotIndex] = null;
            } else {
                state.reserves[slotIndex] = null;
            }
            
            saveState();
            return true;
        }

        // Calcula o saldo de transa√ß√µes do mercado
        function getMarketBalance() {
            if (!state.scores['market'] || !state.scores['market'].purchases) return 0;
            return state.scores['market'].purchases.reduce((sum, t) => sum + t.price, 0);
        }

        // ==================== MERCADO DE TRANSFER√äNCIAS ====================
        
        function isMarketOpen() {
            const today = new Date();
            const day = today.getDate();
            return day === 1 || day === 2;
        }

        function getTimeUntilMarketOpens() {
            const now = new Date();
            const currentDay = now.getDate();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let nextMarketDate;
            
            if (currentDay > 2) {
                // Pr√≥ximo m√™s, dia 1
                if (currentMonth === 11) {
                    nextMarketDate = new Date(currentYear + 1, 0, 1, 0, 0, 0);
                } else {
                    nextMarketDate = new Date(currentYear, currentMonth + 1, 1, 0, 0, 0);
                }
            } else if (currentDay < 1) {
                // Este m√™s, dia 1
                nextMarketDate = new Date(currentYear, currentMonth, 1, 0, 0, 0);
            } else {
                // J√° est√° aberto
                return null;
            }
            
            const diff = nextMarketDate - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            return { days, hours, minutes, seconds, total: diff };
        }

        function getMarketCloseTime() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Mercado fecha no dia 2 √†s 23:59:59
            const closeDate = new Date(currentYear, currentMonth, 2, 23, 59, 59);
            
            const diff = closeDate - now;
            if (diff <= 0) return null;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            return { days, hours, minutes };
        }

        // Carregar ofertas do Firebase
        function listenToOffers() {
            if (!db) return;
            db.ref('offers').on('value', (snapshot) => {
                const offers = snapshot.val();
                state.offers = offers ? Object.values(offers) : [];
                render();
            });
        }

        // Enviar oferta
        function sendOffer(fromUser, toUser, playerOffered, playerWanted) {
            if (!db) return;
            const offerId = Date.now().toString();
            const offer = {
                id: offerId,
                from: fromUser,
                to: toUser,
                playerOffered: playerOffered,
                playerWanted: playerWanted,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            db.ref('offers/' + offerId).set(offer);
        }

        // Aceitar oferta
        function acceptOffer(offerId) {
            if (!db) return;
            const offer = state.offers.find(o => o.id === offerId);
            if (!offer || offer.to !== state.currentUser) return;
            
            // Trocar jogadores
            const fromUserData = state.users[offer.from];
            const toUserData = state.users[offer.to];
            
            // Remover jogador oferecido do time de origem e adicionar no destino
            // Remover jogador pedido do time de destino e adicionar na origem
            
            db.ref('offers/' + offerId).update({ status: 'accepted' });
            
            // Atualizar times no Firebase
            saveState();
            alert('Oferta aceita! Os jogadores foram trocados.');
        }

        // Recusar oferta
        function rejectOffer(offerId) {
            if (!db) return;
            db.ref('offers/' + offerId).update({ status: 'rejected' });
        }

        // Iniciar contador do mercado
        function startMarketCountdown() {
            // Atualiza√ß√£o r√°pida para o modal (1 segundo)
            setInterval(() => {
                if (state.modal === 'marketClosed') {
                    render();
                }
            }, 1000);
            
            // Atualiza√ß√£o lenta para o painel (30 segundos)
            setInterval(() => {
                if (state.screen === 'lineup' && !state.modal && state.isConfirmed) {
                    render();
                }
            }, 30000);
        }

        // ==================== STORAGE COM FIREBASE ====================
        
        // Salvar usu√°rio na nuvem
        function saveUserToCloud(nickname, userData) {
            if (!db) return;
            try {
                const dataToSave = {
                    password: userData.password || null, // Salvar senha para login
                    teamName: userData.teamName || '',
                    teamLogo: userData.teamLogo || null,
                    coach: userData.coach || null,
                    isConfirmed: userData.isConfirmed || false,
                    scores: userData.scores || {},
                    favoriteTeam: userData.favoriteTeam || null,
                    userBio: userData.userBio || '',
                    titles: userData.titles || [],
                    lastUpdate: new Date().toISOString()
                };
                db.ref('users/' + nickname).set(dataToSave);
                console.log('‚òÅÔ∏è Salvo na nuvem:', nickname);
            } catch (e) {
                console.error('Erro ao salvar na nuvem:', e);
            }
        }

        // Escutar mudan√ßas em tempo real (para ranking)
        function listenToUsers() {
            if (!db) return;
            db.ref('users').on('value', (snapshot) => {
                const cloudUsers = snapshot.val();
                if (cloudUsers) {
                    Object.keys(cloudUsers).forEach(nick => {
                        if (!state.users[nick]) {
                            state.users[nick] = {};
                        }
                        // Mesclar dados da nuvem (incluindo starters e reserves para o draft)
                        // Usar ensureArray para garantir que s√£o arrays
                        state.users[nick] = {
                            ...state.users[nick],
                            // Carregar senha da nuvem se n√£o tiver localmente
                            password: state.users[nick].password || cloudUsers[nick].password,
                            teamName: cloudUsers[nick].teamName || state.users[nick].teamName,
                            teamLogo: cloudUsers[nick].teamLogo || state.users[nick].teamLogo,
                            coach: cloudUsers[nick].coach || state.users[nick].coach,
                            starters: ensureArray(cloudUsers[nick].starters || state.users[nick].starters, 11),
                            reserves: ensureArray(cloudUsers[nick].reserves || state.users[nick].reserves, 7),
                            formation: cloudUsers[nick].formation || state.users[nick].formation || '4-3-3',
                            isConfirmed: cloudUsers[nick].isConfirmed || state.users[nick].isConfirmed,
                            scores: cloudUsers[nick].scores || state.users[nick].scores || {},
                            favoriteTeam: cloudUsers[nick].favoriteTeam || null,
                            userBio: cloudUsers[nick].userBio || '',
                            titles: cloudUsers[nick].titles || []
                        };
                    });
                    console.log('‚òÅÔ∏è Usu√°rios atualizados da nuvem:', Object.keys(cloudUsers).length);
                    
                    // Salvar no localStorage para ter os usu√°rios da nuvem dispon√≠veis
                    localStorage.setItem('fantasyBrasileirao2026', JSON.stringify({
                        users: state.users,
                        currentUser: state.currentUser
                    }));
                    
                    if (state.screen === 'draft') {
                        render();
                    }
                }
            });
        }
        
        // ==================== CHAT ====================
        
        // Enviar mensagem no chat
        function sendChatMessage(text) {
            if (!db || !text.trim() || !state.currentUser) return;
            
            const message = {
                user: state.currentUser,
                teamName: state.teamName || state.currentUser,
                teamLogo: state.teamLogo || null,
                text: text.trim(),
                timestamp: Date.now()
            };
            
            db.ref('chat').push(message);
            console.log('üí¨ Mensagem enviada');
        }
        
        // Escutar mensagens do chat em tempo real
        function listenToChat() {
            if (!db) return;
            
            // Pegar apenas as √∫ltimas 200 mensagens
            db.ref('chat').orderByChild('timestamp').limitToLast(200).on('value', (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    state.chatMessages = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                } else {
                    state.chatMessages = [];
                }
                
                // Atualizar s√≥ o chat se estiver na tela de ranking
                if (state.screen === 'ranking') {
                    updateChatMessages();
                }
            });
            
            // Limpar mensagens com mais de 30 dias (executa uma vez ao carregar)
            cleanOldChatMessages();
        }
        
        // Limpar mensagens do chat com mais de 30 dias
        function cleanOldChatMessages() {
            if (!db) return;
            
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000); // 30 dias em milissegundos
            
            db.ref('chat').orderByChild('timestamp').endAt(thirtyDaysAgo).once('value', (snapshot) => {
                const oldMessages = snapshot.val();
                if (oldMessages) {
                    const updates = {};
                    Object.keys(oldMessages).forEach(key => {
                        updates[key] = null; // Marcar para deletar
                    });
                    db.ref('chat').update(updates);
                    console.log('üßπ Limpeza do chat: ' + Object.keys(oldMessages).length + ' mensagens antigas removidas');
                }
            });
        }
        
        // Atualizar apenas as mensagens do chat (sem re-render completo)
        function updateChatMessages() {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            container.innerHTML = state.chatMessages.length === 0 ? 
                `<p class="text-zinc-600 text-center text-sm py-8">Nenhuma mensagem ainda. Comece a zoeira! üî•</p>` :
                state.chatMessages.map(m => {
                    const isMe = m.user === state.currentUser;
                    const time = new Date(m.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="flex gap-2 ${isMe ? 'flex-row-reverse' : ''}">
                            ${m.teamLogo ? 
                                `<img src="${m.teamLogo}" class="w-8 h-8 rounded-full object-cover flex-shrink-0">` :
                                `<div class="w-8 h-8 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-400 text-xs font-bold flex-shrink-0">${(m.user || 'U')[0].toUpperCase()}</div>`
                            }
                            <div class="${isMe ? 'bg-green-500/20 border-green-500/30' : 'bg-zinc-800/80'} rounded-xl px-3 py-2 max-w-[75%] border border-transparent">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <span class="text-xs font-medium ${isMe ? 'text-green-400' : 'text-zinc-400'}">@${m.user}</span>
                                    <span class="text-zinc-600 text-xs">${time}</span>
                                </div>
                                <p class="text-white text-sm break-words">${escapeHtml(m.text)}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            
            // Scroll para o final
            container.scrollTop = container.scrollHeight;
        }
        
        // Escape HTML para evitar XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            let escaped = div.innerHTML;
            
            // Substituir [NomeDoTime] pelo escudo
            const teamLogos = {
                'Flamengo': 'https://media.api-sports.io/football/teams/127.png',
                'Palmeiras': 'https://media.api-sports.io/football/teams/121.png',
                'S√£o Paulo': 'https://media.api-sports.io/football/teams/126.png',
                'Corinthians': 'https://media.api-sports.io/football/teams/131.png',
                'Fluminense': 'https://media.api-sports.io/football/teams/124.png',
                'Botafogo': 'https://media.api-sports.io/football/teams/120.png',
                'Vasco': 'https://media.api-sports.io/football/teams/133.png',
                'Gr√™mio': 'https://media.api-sports.io/football/teams/130.png',
                'Internacional': 'https://media.api-sports.io/football/teams/119.png',
                'Atl√©tico-MG': 'https://media.api-sports.io/football/teams/1062.png',
                'Cruzeiro': 'https://media.api-sports.io/football/teams/129.png',
                'Santos': 'https://media.api-sports.io/football/teams/128.png',
                'Bahia': 'https://media.api-sports.io/football/teams/118.png',
                'Vit√≥ria': 'https://media.api-sports.io/football/teams/2129.png',
                'Athletico-PR': 'https://media.api-sports.io/football/teams/134.png',
                'Coritiba': 'https://media.api-sports.io/football/teams/123.png',
                'Bragantino': 'https://media.api-sports.io/football/teams/1193.png',
                'Mirassol': 'https://media.api-sports.io/football/teams/7848.png',
                'Chapecoense': 'https://media.api-sports.io/football/teams/1196.png',
                'Remo': 'https://media.api-sports.io/football/teams/1186.png'
            };
            
            // Substituir [NomeTime] por imagem do escudo
            Object.keys(teamLogos).forEach(team => {
                const regex = new RegExp(`\\[${team}\\]`, 'gi');
                escaped = escaped.replace(regex, `<img src="${teamLogos[team]}" class="inline-block w-5 h-5 mx-0.5 align-middle" title="${team}">`);
            });
            
            return escaped;
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('fantasyBrasileirao2026');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.users = data.users || {};
                    state.currentUser = data.currentUser || null;
                    
                    if (state.currentUser && state.users[state.currentUser]) {
                        const userData = state.users[state.currentUser];
                        state.teamName = userData.teamName || '';
                        state.teamLogo = userData.teamLogo || null;
                        state.formation = userData.formation || '4-3-3';
                        state.starters = ensureArray(userData.starters, 11);
                        state.reserves = ensureArray(userData.reserves, 7);
                        state.coach = userData.coach || null;
                        state.isConfirmed = userData.isConfirmed || false;
                        state.scores = userData.scores || {};
                        state.favoriteTeam = userData.favoriteTeam || null;
                        state.userBio = userData.userBio || '';
                        state.screen = userData.teamName ? 'lineup' : 'createTeam';
                    }
                }
                
                // Carregar jogadores do cache
                const cachedPlayers = localStorage.getItem('fantasyPlayers2026');
                if (cachedPlayers) {
                    const parsed = JSON.parse(cachedPlayers);
                    state.players = parsed.players || [];
                    state.teams = parsed.teams || [];
                }

                // Escutar ranking da nuvem
                try { listenToUsers(); } catch(e) { console.error('Erro listenToUsers:', e); }
                
                // Escutar chat em tempo real
                try { listenToChat(); } catch(e) { console.error('Erro listenToChat:', e); }
                
                // Escutar chat do draft
                try { listenToDraftChat(); } catch(e) { console.error('Erro listenToDraftChat:', e); }
                
                // Escutar status do draft
                try { listenToDraftStatus(); } catch(e) { console.error('Erro listenToDraftStatus:', e); }
                
                // Escutar mensagens privadas
                try { listenToPrivateMessages(); } catch(e) { console.error('Erro listenToPrivateMessages:', e); }

            } catch (e) {
                console.error('Erro ao carregar estado:', e);
            }
        }

        function saveState() {
            try {
                if (state.currentUser) {
                    state.users[state.currentUser] = {
                        ...state.users[state.currentUser],
                        teamName: state.teamName,
                        teamLogo: state.teamLogo,
                        formation: state.formation,
                        starters: state.starters,
                        reserves: state.reserves,
                        coach: state.coach,
                        isConfirmed: state.isConfirmed,
                        scores: state.scores,
                        favoriteTeam: state.favoriteTeam,
                        userBio: state.userBio,
                        lastUpdate: new Date().toISOString()
                    };
                    
                    // Salvar na nuvem para ranking compartilhado
                    saveUserToCloud(state.currentUser, state.users[state.currentUser]);
                }
                
                localStorage.setItem('fantasyBrasileirao2026', JSON.stringify({
                    users: state.users,
                    currentUser: state.currentUser
                }));
            } catch (e) {
                console.error('Erro ao salvar:', e);
            }
        }

        function savePlayers() {
            try {
                localStorage.setItem('fantasyPlayers2026', JSON.stringify({
                    players: state.players,
                    teams: state.teams,
                    lastSync: new Date().toISOString()
                }));
            } catch (e) {
                console.error('Erro ao salvar jogadores:', e);
            }
        }

        // ==================== API FUNCTIONS ====================
        async function apiCall(endpoint) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method: 'GET',
                headers: {
                    'x-apisports-key': API_KEY
                }
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            return await response.json();
        }

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            state.syncLogs.unshift({ time, message, type });
            if (state.syncLogs.length > 50) state.syncLogs.pop();
            render();
        }

        async function syncAllData() {
            state.isLoading = true;
            state.syncLogs = [];
            state.scrollY = window.scrollY;
            state.modal = 'sync';
            document.body.classList.add('modal-open');
            document.body.style.top = `-${state.scrollY}px`;
            render();

            try {
                // 1. Buscar times da S√©rie A
                addLog('üîç Buscando times do Brasileir√£o 2026...', 'info');
                
                let teamsData;
                let usedSeason = SEASON;
                
                try {
                    teamsData = await apiCall(`/teams?league=${LEAGUE_ID}&season=${SEASON}`);
                    
                    if (!teamsData.response || teamsData.response.length === 0) {
                        addLog('‚ö†Ô∏è Temporada 2026 sem dados, usando 2025...', 'warning');
                        teamsData = await apiCall(`/teams?league=${LEAGUE_ID}&season=${SEASON_FALLBACK}`);
                        usedSeason = SEASON_FALLBACK;
                    }
                } catch (e) {
                    addLog('‚ö†Ô∏è Erro na API, usando temporada 2025...', 'warning');
                    teamsData = await apiCall(`/teams?league=${LEAGUE_ID}&season=${SEASON_FALLBACK}`);
                    usedSeason = SEASON_FALLBACK;
                }

                if (!teamsData.response || teamsData.response.length === 0) {
                    addLog('‚ùå Nenhum time encontrado!', 'error');
                    state.isLoading = false;
                    render();
                    return;
                }

                state.teams = teamsData.response.map(t => ({
                    id: t.team.id,
                    name: t.team.name,
                    logo: t.team.logo
                }));

                addLog(`‚úÖ ${state.teams.length} times encontrados! (temporada ${usedSeason})`, 'success');

                // 2. Buscar jogadores de cada time
                const allPlayers = [];
                
                for (let i = 0; i < state.teams.length; i++) {
                    const team = state.teams[i];
                    addLog(`‚öΩ [${i + 1}/${state.teams.length}] Carregando ${team.name}...`, 'info');
                    
                    try {
                        // Primeiro tentar buscar o squad atual
                        let squadData = await apiCall(`/players/squads?team=${team.id}`);
                        
                        if (squadData.response && squadData.response[0]?.players && squadData.response[0].players.length > 0) {
                            squadData.response[0].players.forEach(p => {
                                allPlayers.push({
                                    id: p.id,
                                    name: p.name,
                                    photo: p.photo || `https://media.api-sports.io/football/players/${p.id}.png`,
                                    position: translatePosition(p.position),
                                    team: team.name,
                                    teamId: team.id,
                                    teamLogo: team.logo,
                                    number: p.number
                                });
                            });
                            addLog(`   ‚úì ${squadData.response[0].players.length} jogadores (squad)`, 'success');
                        } else {
                            // Se n√£o encontrar squad, tentar players da temporada
                            let playersData = await apiCall(`/players?team=${team.id}&season=${usedSeason}`);
                            
                            if (playersData.response && playersData.response.length > 0) {
                                playersData.response.forEach(p => {
                                    allPlayers.push({
                                        id: p.player.id,
                                        name: p.player.name,
                                        photo: p.player.photo,
                                        position: translatePosition(p.statistics[0]?.games?.position),
                                        team: team.name,
                                        teamId: team.id,
                                        teamLogo: team.logo,
                                        age: p.player.age,
                                        nationality: p.player.nationality
                                    });
                                });
                                addLog(`   ‚úì ${playersData.response.length} jogadores (season)`, 'success');
                            } else {
                                addLog(`   ‚ö†Ô∏è Nenhum jogador encontrado`, 'warning');
                            }
                        }
                        
                        // Delay para n√£o exceder rate limit (API permite ~10 requests/min no plano free)
                        await new Promise(r => setTimeout(r, 400));
                        
                    } catch (e) {
                        addLog(`   ‚ùå Erro: ${e.message}`, 'error');
                    }
                }

                state.players = allPlayers;
                savePlayers();
                
                // Salvar data da √∫ltima sincroniza√ß√£o
                localStorage.setItem('fantasy_last_sync', new Date().toISOString());

                addLog(`üéâ Sincroniza√ß√£o completa!`, 'success');
                addLog(`üìä Total: ${allPlayers.length} jogadores de ${state.teams.length} times`, 'success');
                
            } catch (e) {
                addLog(`‚ùå Erro geral: ${e.message}`, 'error');
            }

            state.isLoading = false;
            render();
        }

        function translatePosition(pos) {
            const map = {
                'Goalkeeper': 'GOL',
                'Defender': 'DEF',
                'Midfielder': 'MEI',
                'Attacker': 'ATA',
                'G': 'GOL',
                'D': 'DEF',
                'M': 'MEI',
                'F': 'ATA'
            };
            return map[pos] || 'MEI';
        }

        // ==================== PONTUA√á√ÉO ====================
        
        // Buscar fixtures da rodada
        async function getFixturesForRound(round) {
            try {
                const res = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON}&round=Regular Season - ${round}`);
                if (!res.response || res.response.length === 0) {
                    // Tentar temporada anterior
                    const res2 = await apiCall(`/fixtures?league=${LEAGUE_ID}&season=${SEASON_FALLBACK}&round=Regular Season - ${round}`);
                    return res2.response || [];
                }
                return res.response || [];
            } catch (e) {
                console.error('Erro ao buscar fixtures:', e);
                return [];
            }
        }

        // Buscar estat√≠sticas dos jogadores em uma partida
        // Cache de estat√≠sticas de jogadores no Firebase (10 minutos)
        async function getPlayerStats(fixtureId) {
            try {
                // Verificar cache no Firebase primeiro
                if (db) {
                    const cacheSnapshot = await db.ref('statsCache/' + fixtureId).once('value');
                    const cache = cacheSnapshot.val();
                    
                    if (cache && cache.updatedAt) {
                        const cacheAge = Date.now() - cache.updatedAt;
                        // Cache v√°lido por 10 minutos
                        if (cacheAge < 10 * 60 * 1000) {
                            console.log(`üì¶ Stats do jogo ${fixtureId} (cache Firebase)`);
                            return cache.data || [];
                        }
                    }
                }
                
                // Buscar da API
                console.log(`üåê Buscando stats do jogo ${fixtureId} (API)`);
                const res = await apiCall(`/fixtures/players?fixture=${fixtureId}`);
                const data = res.response || [];
                
                // Salvar no cache do Firebase
                if (db && data.length > 0) {
                    db.ref('statsCache/' + fixtureId).set({
                        data: data,
                        updatedAt: Date.now()
                    });
                    console.log(`üíæ Stats salvos no cache Firebase`);
                }
                
                return data;
            } catch (e) {
                console.error('Erro ao buscar stats:', e);
                return [];
            }
        }

        // Calcular pontua√ß√£o de um jogador
        function calculatePlayerScore(stats, fixture = null) {
            let score = 0;
            
            if (!stats || !stats.statistics || !stats.statistics[0]) return 0;
            
            const s = stats.statistics[0];
            const position = stats.player?.position; // G = Goleiro, D = Defensor, M = Meia, F = Atacante
            
            // ==================== TODOS OS JOGADORES ====================
            
            // Jogou (+2)
            if (s.games?.minutes > 0) score += 2;
            
            // Nota do jogo (rating)
            const rating = parseFloat(s.games?.rating) || 0;
            if (rating >= 8.0) score += 2;
            else if (rating >= 7.0) score += 1;
            
            // Assist√™ncias (+4 para todos)
            score += (s.goals?.assists || 0) * 4;
            
            // Cart√£o amarelo (-1)
            score -= (s.cards?.yellow || 0) * 1;
            
            // Cart√£o vermelho (-3)
            score -= (s.cards?.red || 0) * 3;
            
            // Segundo amarelo = vermelho (-3)
            score -= (s.cards?.yellowred || 0) * 3;
            
            // Gol contra (-3)
            score -= (s.goals?.own || 0) * 3;
            
            // P√™nalti perdido (-3)
            score -= (s.penalty?.missed || 0) * 3;
            
            // ==================== GOLS (por posi√ß√£o) ====================
            const goals = s.goals?.total || 0;
            if (goals > 0) {
                if (position === 'G') score += goals * 10;      // Goleiro - raridade!
                else if (position === 'D') score += goals * 6;  // Defensor
                else score += goals * 5;                         // Meia e Atacante
            }
            
            // ==================== GOLEIRO (G) ====================
            if (position === 'G') {
                // Defesas
                const saves = s.goals?.saves || 0;
                if (saves >= 6) score += 4;
                else if (saves >= 3) score += 2;
                else if (saves >= 1) score += 1;
                
                // P√™nalti defendido (+7)
                score += (s.penalty?.saved || 0) * 7;
                
                // Saldo de gols (SG)
                const conceded = s.goals?.conceded || 0;
                if (conceded === 0) score += 4;        // N√£o sofreu gol
                else if (conceded >= 2) score -= 1;    // Sofreu 2+ gols
                
                // P√™nalti sofrido (+1)
                score += (s.penalty?.won || 0) * 1;
                
                // Precis√£o de passe (goleiro que sai jogando)
                const passAccuracy = parseInt(s.passes?.accuracy) || 0;
                if (passAccuracy >= 85) score += 1;
            }
            
            // ==================== DEFENSOR (D) ====================
            if (position === 'D') {
                // Desarmes (+0.5 cada)
                const tackles = s.tackles?.total || 0;
                score += tackles * 0.5;
                
                // Intercepta√ß√µes (+0.5 cada)
                const interceptions = s.tackles?.interceptions || 0;
                score += interceptions * 0.5;
                
                // Bloqueios (+0.5 cada)
                const blocks = s.tackles?.blocks || 0;
                score += blocks * 0.5;
                
                // Dribles certos (+0.5 cada)
                const dribbles = s.dribbles?.success || 0;
                score += dribbles * 0.5;
                
                // Passe decisivo (+1)
                const keyPasses = s.passes?.key || 0;
                score += keyPasses * 1;
                
                // Duelos ganhos (+0.5 a cada 2)
                const duelsWon = s.duels?.won || 0;
                score += Math.floor(duelsWon / 2) * 0.5;
                
                // Saldo de gols (SG)
                const conceded = s.goals?.conceded || 0;
                if (conceded === 0) score += 3;        // N√£o sofreu gol
                else if (conceded >= 2) score -= 1;    // Sofreu 2+ gols
                
                // P√™nalti sofrido (+1)
                score += (s.penalty?.won || 0) * 1;
            }
            
            // ==================== MEIA (M) ====================
            if (position === 'M') {
                // Passe decisivo (+1 cada)
                const keyPasses = s.passes?.key || 0;
                score += keyPasses * 1;
                
                // Precis√£o de passe
                const accuracy = parseInt(s.passes?.accuracy) || 0;
                if (accuracy >= 85) score += 1;
                
                // Desarmes (+0.5 cada)
                const tackles = s.tackles?.total || 0;
                score += tackles * 0.5;
                
                // Dribles certos (+0.5 cada)
                const dribbles = s.dribbles?.success || 0;
                score += dribbles * 0.5;
                
                // Finaliza√ß√µes no gol (+0.5 cada)
                const shotsOn = s.shots?.on || 0;
                score += shotsOn * 0.5;
                
                // Faltas sofridas (+0.5 cada)
                const foulsDrawn = s.fouls?.drawn || 0;
                score += foulsDrawn * 0.5;
                
                // Duelos ganhos (+0.5 a cada 2)
                const duelsWon = s.duels?.won || 0;
                score += Math.floor(duelsWon / 2) * 0.5;
                
                // P√™nalti sofrido (+1)
                score += (s.penalty?.won || 0) * 1;
            }
            
            // ==================== ATACANTE (F) ====================
            if (position === 'F') {
                // Finaliza√ß√µes no gol (+1 cada)
                const shotsOn = s.shots?.on || 0;
                score += shotsOn * 1;
                
                // Passe decisivo (+1 cada)
                const keyPasses = s.passes?.key || 0;
                score += keyPasses * 1;
                
                // Dribles certos (+0.5 cada)
                const dribbles = s.dribbles?.success || 0;
                score += dribbles * 0.5;
                
                // Faltas sofridas (+0.5 cada)
                const foulsDrawn = s.fouls?.drawn || 0;
                score += foulsDrawn * 0.5;
                
                // Duelos ganhos (+0.5 a cada 2)
                const duelsWon = s.duels?.won || 0;
                score += Math.floor(duelsWon / 2) * 0.5;
                
                // P√™nalti sofrido (+2) - atacante ganha mais
                score += (s.penalty?.won || 0) * 2;
            }
            
            // Arredondar para evitar decimais estranhos
            return Math.round(score * 10) / 10;
        }

        // Calcular pontua√ß√£o do t√©cnico
        function calculateCoachScore(fixture, teamId) {
            let score = 0;
            
            const isHome = fixture.teams?.home?.id === teamId;
            const homeGoals = fixture.goals?.home || 0;
            const awayGoals = fixture.goals?.away || 0;
            const teamGoals = isHome ? homeGoals : awayGoals;
            const opponentGoals = isHome ? awayGoals : homeGoals;
            
            // Vit√≥ria
            if ((isHome && homeGoals > awayGoals) || (!isHome && awayGoals > homeGoals)) {
                score += 8;
            }
            // Empate
            else if (homeGoals === awayGoals) {
                score += 4;
            }
            
            // Clean sheet
            if (opponentGoals === 0) score += 3;
            
            // Gols marcados
            score += teamGoals;
            
            // B√¥nus 3+ gols
            if (teamGoals >= 3) score += 3;
            
            return score;
        }

        // Sincronizar pontua√ß√£o da rodada (silencioso) - INCLUI JOGOS AO VIVO!
        async function syncRoundScores() {
            if (state.isUpdatingScores) return;
            if (!state.isConfirmed) return;
            
            const round = state.selectedRound;
            state.isUpdatingScores = true;
            state.liveScoresUpdating = true;
            render();

            try {
                console.log(`üîç Buscando jogos da Rodada ${round}...`);
                
                const fixtures = await getFixturesForRound(round);
                
                if (fixtures.length === 0) {
                    console.log('Nenhum jogo encontrado para esta rodada');
                    state.isUpdatingScores = false;
                    state.liveScoresUpdating = false;
                    render();
                    return;
                }

                // Status de jogos que queremos processar:
                // FT = Finalizado, 1H = Primeiro tempo, HT = Intervalo, 2H = Segundo tempo
                const liveStatuses = ['1H', 'HT', '2H', 'ET', 'P', 'BT', 'LIVE'];
                const finishedStatuses = ['FT', 'AET', 'PEN'];
                
                // Jogos ao vivo
                const liveGames = fixtures.filter(f => {
                    const status = f.fixture?.status?.short;
                    return liveStatuses.includes(status);
                });
                
                // Jogos finalizados
                const finishedGames = fixtures.filter(f => {
                    const status = f.fixture?.status?.short;
                    return finishedStatuses.includes(status);
                });
                
                // Todos os jogos que vamos processar
                const gamesToProcess = [...liveGames, ...finishedGames];
                
                console.log(`üî¥ ${liveGames.length} jogos AO VIVO`);
                console.log(`‚úÖ ${finishedGames.length} jogos finalizados`);
                
                // Marcar se tem jogos ao vivo
                state.hasLiveGames = liveGames.length > 0;

                if (gamesToProcess.length === 0) {
                    state.isUpdatingScores = false;
                    state.liveScoresUpdating = false;
                    render();
                    return;
                }

                // Inicializar pontua√ß√£o da rodada
                if (!state.scores[round]) {
                    state.scores[round] = { players: {}, coach: 0, live: false };
                }
                
                // Marcar se a pontua√ß√£o √© ao vivo (ainda tem jogos rolando)
                state.scores[round].live = liveGames.length > 0;

                // Buscar estat√≠sticas de cada jogo
                for (let i = 0; i < gamesToProcess.length; i++) {
                    const fixture = gamesToProcess[i];
                    
                    // Verificar se fixture tem todos os dados necess√°rios
                    if (!fixture || !fixture.teams || !fixture.teams.home || !fixture.teams.away) {
                        console.log('‚ö†Ô∏è Fixture inv√°lido, pulando...');
                        continue;
                    }
                    
                    console.log(`‚öΩ ${fixture.teams.home.name} x ${fixture.teams.away.name}`);
                    
                    const playerStats = await getPlayerStats(fixture.fixture.id);
                    
                    // Processar cada time
                    playerStats.forEach(team => {
                        team.players?.forEach(playerData => {
                            const playerId = playerData.player?.id;
                            
                            // Verificar se o jogador est√° escalado
                            const isStarter = state.starters.some(p => p?.id === playerId);
                            const isReserve = state.reserves.some(p => p?.id === playerId);
                            
                            if (isStarter || isReserve) {
                                let score = calculatePlayerScore(playerData);
                                
                                // Reservas ganham apenas 50% da pontua√ß√£o
                                if (isReserve) {
                                    score = Math.round(score * 0.5);
                                    console.log(`   ‚úì ${playerData.player.name}: ${score} pts (reserva 50%)`);
                                } else {
                                    console.log(`   ‚úì ${playerData.player.name}: ${score} pts`);
                                }
                                
                                state.scores[round].players[playerId] = score;
                            }
                        });
                    });

                    // Calcular pontua√ß√£o do t√©cnico
                    if (state.coach && fixture.teams && fixture.teams.home && fixture.teams.away) {
                        const coachTeamId = state.coach.teamId;
                        if (fixture.teams.home.id === coachTeamId || fixture.teams.away.id === coachTeamId) {
                            const coachScore = calculateCoachScore(fixture, coachTeamId);
                            state.scores[round].coach = coachScore;
                            console.log(`   üëî ${state.coach.name}: ${coachScore} pts`);
                        }
                    }

                    await new Promise(r => setTimeout(r, 400));
                }

                saveState();
                console.log(`‚úÖ Pontua√ß√£o da Rodada ${round}: ${getRoundScore(round)} pontos`);

            } catch (e) {
                console.error('Erro ao atualizar pontua√ß√£o:', e);
            }

            state.isUpdatingScores = false;
            state.liveScoresUpdating = false;
            render();
        }

        function getTotalScore() {
            let total = 0;
            Object.entries(state.scores || {}).forEach(([key, round]) => {
                if (key === 'market') {
                    if (round && round.purchases) {
                        round.purchases.forEach(t => total += (t.price || 0));
                    }
                } else {
                    if (round && round.players) {
                        Object.values(round.players).forEach(s => total += (s || 0));
                    }
                    total += (round && round.coach) || 0;
                }
            });
            return total;
        }

        function getRoundScore(round) {
            if (!state.scores) return 0;
            const r = state.scores[round];
            if (!r) return 0;
            let total = 0;
            Object.values(r.players || {}).forEach(s => total += s);
            total += r.coach || 0;
            return total;
        }
        
        // ==================== RENDER ====================
        function render() {
            const root = document.getElementById('root');
            
            try {
                switch(state.screen) {
                    case 'auth':
                        root.innerHTML = renderAuth();
                        break;
                    case 'createTeam':
                        root.innerHTML = renderCreateTeam();
                        break;
                    case 'lineup':
                        root.innerHTML = renderLineup();
                        break;
                    case 'ranking':
                        root.innerHTML = renderRanking();
                        break;
                    case 'draft':
                        root.innerHTML = renderDraft();
                        break;
                    case 'userDraft':
                        root.innerHTML = renderUserDraft();
                        break;
                    default:
                        state.screen = 'auth';
                        root.innerHTML = renderAuth();
                        break;
                }
                
                attachEventListeners();
            } catch(e) {
                console.error('Erro no render (' + state.screen + '):', e);
                root.innerHTML = '<div style="color:white;padding:20px;"><h1>Erro ao renderizar</h1><p>Tela: ' + state.screen + '</p><p>' + e.message + '</p><button onclick="localStorage.clear();location.reload()">Limpar dados e recarregar</button></div>';
            }
        }

        function renderAuth() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="card rounded-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="font-display text-5xl text-white mb-1">FANTASY</h1>
                            <p class="text-zinc-500 text-sm tracking-widest uppercase">Brasileir√£o S√©rie A 2026</p>
                        </div>
                        
                        <div class="flex mb-8 bg-zinc-900 rounded-lg p-1">
                            <button onclick="setAuthMode('login')" class="flex-1 py-2.5 rounded-md text-sm font-medium transition ${state.authMode === 'login' ? 'bg-zinc-800 text-white' : 'text-zinc-500 hover:text-zinc-300'}">
                                Entrar
                            </button>
                            <button onclick="setAuthMode('register')" class="flex-1 py-2.5 rounded-md text-sm font-medium transition ${state.authMode === 'register' ? 'bg-zinc-800 text-white' : 'text-zinc-500 hover:text-zinc-300'}">
                                Cadastrar
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-zinc-400 text-sm mb-2">Nickname</label>
                                <input type="text" id="nickname" placeholder="Seu apelido" 
                                    class="w-full px-4 py-3 input-dark rounded-lg text-white text-sm"
                                    onkeypress="if(event.key==='Enter')document.getElementById('password').focus()">
                            </div>
                            
                            <div>
                                <label class="block text-zinc-400 text-sm mb-2">Senha</label>
                                <input type="password" id="password" placeholder="Sua senha" 
                                    class="w-full px-4 py-3 input-dark rounded-lg text-white text-sm"
                                    onkeypress="if(event.key==='Enter'){${state.authMode === 'register' ? "document.getElementById('accessCode').focus()" : 'handleAuth()'}}">
                            </div>
                            
                            ${state.authMode === 'register' ? `
                                <div>
                                    <label class="block text-zinc-400 text-sm mb-2">C√≥digo de Acesso</label>
                                    <input type="text" id="accessCode" placeholder="C√≥digo para entrar" 
                                        class="w-full px-4 py-3 input-dark rounded-lg text-white text-sm"
                                        onkeypress="if(event.key==='Enter')handleAuth()">
                                </div>
                            ` : ''}
                            
                            <button onclick="handleAuth()" 
                                class="w-full py-3.5 btn-primary text-white font-semibold rounded-lg text-sm mt-6 transition">
                                ${state.authMode === 'login' ? 'Entrar' : 'Criar Conta'}
                            </button>
                            
                            ${state.authMode === 'login' ? `
                                <button onclick="setAuthMode('recover')" 
                                    class="w-full text-zinc-500 hover:text-zinc-300 text-xs mt-4 transition">
                                    Esqueci minha senha
                                </button>
                            ` : ''}
                            
                            ${state.authMode === 'recover' ? `
                                <div class="mt-4 p-4 bg-zinc-800/50 rounded-lg">
                                    <p class="text-zinc-400 text-xs mb-3">Digite o c√≥digo de acesso para resetar sua senha:</p>
                                    <input type="text" id="recoverCode" placeholder="C√≥digo de acesso" 
                                        class="w-full px-4 py-2 input-dark rounded-lg text-white text-sm mb-3">
                                    <button onclick="recoverPassword()" 
                                        class="w-full py-2 bg-yellow-500 hover:bg-yellow-400 text-black font-semibold rounded-lg text-sm transition">
                                        Resetar Senha
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <p id="authError" class="text-red-500 text-center text-sm mt-4 hidden"></p>
                    </div>
                </div>
            `;
        }

        function renderCreateTeam() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="card rounded-2xl p-8 w-full max-w-md">
                        <h2 class="font-display text-3xl text-white text-center mb-2">CRIAR TIME</h2>
                        <p class="text-zinc-500 text-sm text-center mb-8">Configure seu time para a temporada</p>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-zinc-400 text-sm mb-2">Nome do Time</label>
                                <input type="text" id="teamName" placeholder="Ex: Os Craques FC" 
                                    class="w-full px-4 py-3 input-dark rounded-lg text-white text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-zinc-400 text-sm mb-2">Escudo do Time</label>
                                <div id="logoUpload" class="border border-dashed border-zinc-700 rounded-lg p-8 text-center cursor-pointer hover:border-zinc-500 transition">
                                    ${state.teamLogo ? 
                                        `<img src="${state.teamLogo}" class="w-20 h-20 mx-auto rounded-lg object-cover">` :
                                        `<div class="text-zinc-500">
                                            <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                            <p class="text-sm">Clique para upload</p>
                                        </div>`
                                    }
                                </div>
                                <input type="file" id="logoInput" accept="image/*" class="hidden">
                            </div>
                            
                            <button onclick="createTeam()" 
                                class="w-full py-3.5 btn-primary text-white font-semibold rounded-lg text-sm mt-2 transition">
                                Criar Time
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLineup() {
            const fieldPositions = getFieldPositions();

            const pendingOffers = (state.offers || []).filter(o => o.to === state.currentUser && o.status === 'pending').length;

            return `
                <div class="min-h-screen">
                    <!-- Top Navigation -->
                    <nav class="border-b border-zinc-800/50 bg-zinc-900/50 backdrop-blur-sm sticky top-0 z-50">
                        <div class="max-w-6xl mx-auto px-4">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center gap-6">
                                    <h1 class="font-display text-2xl text-white">FANTASY</h1>
                                    <div class="hidden sm:flex items-center gap-1">
                                        <button onclick="state.screen='lineup';render()" class="px-4 py-2 text-sm font-medium ${state.screen === 'lineup' ? 'text-white' : 'text-zinc-500 hover:text-white'} transition">
                                            Escala√ß√£o
                                        </button>
                                        <button onclick="state.screen='userDraft';render()" class="px-4 py-2 text-sm font-medium ${state.screen === 'userDraft' ? 'text-white bg-purple-500/20 rounded-lg' : 'text-purple-400 hover:text-purple-300'} transition flex items-center gap-1">
                                            üéØ Draft
                                        </button>
                                        <button onclick="openMarketModal()" class="px-4 py-2 text-sm font-medium text-zinc-500 hover:text-white transition flex items-center gap-2">
                                            Mercado
                                            ${!isMarketOpen() ? '<span class="w-2 h-2 bg-red-500 rounded-full"></span>' : '<span class="w-2 h-2 bg-green-500 rounded-full"></span>'}
                                        </button>
                                        <button onclick="openTeamsModal()" class="px-4 py-2 text-sm font-medium text-zinc-500 hover:text-white transition">
                                            Times
                                        </button>
                                        <button onclick="goToRanking()" class="px-4 py-2 text-sm font-medium ${state.screen === 'ranking' ? 'text-white' : 'text-zinc-500 hover:text-white'} transition">
                                            Ranking/Chat
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    ${pendingOffers > 0 ? `
                                        <button onclick="openOffersModal()" class="relative p-2 text-zinc-400 hover:text-white transition">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                                            <span class="absolute -top-1 -right-1 w-5 h-5 bg-green-500 text-white text-xs flex items-center justify-center rounded-full">${pendingOffers}</span>
                                        </button>
                                    ` : ''}
                                    
                                    <!-- Bot√£o de Mensagens -->
                                    <button onclick="openMessagesModal()" class="relative p-2 text-zinc-400 hover:text-white transition" title="Mensagens">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                        ${getUnreadMessagesCount() > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 text-white text-xs flex items-center justify-center rounded-full">${getUnreadMessagesCount()}</span>` : ''}
                                    </button>
                                    
                                    <div class="flex items-center gap-3">
                                        <div class="relative cursor-pointer" onclick="openSettingsModal()">
                                            ${state.teamLogo ? 
                                                `<img src="${state.teamLogo}" class="w-8 h-8 rounded-full object-cover border-2 border-green-500 hover:opacity-80 transition">` :
                                                `<div class="w-8 h-8 bg-zinc-800 rounded-full flex items-center justify-center text-zinc-500 text-sm font-bold hover:bg-zinc-700 transition">${(state.currentUser || 'U')[0].toUpperCase()}</div>`
                                            }
                                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-zinc-700 rounded-full flex items-center justify-center">
                                                <svg class="w-2.5 h-2.5 text-zinc-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                            </div>
                                        </div>
                                        <div class="hidden sm:block">
                                            <p class="text-sm font-medium text-white">${state.teamName || 'Meu Time'}</p>
                                            <p class="text-xs text-zinc-500">@${state.currentUser}</p>
                                        </div>
                                    </div>
                                    <button onclick="logout()" class="p-2 text-zinc-500 hover:text-white transition">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <!-- Mobile Nav -->
                    <div class="sm:hidden fixed bottom-0 left-0 right-0 bg-zinc-900 border-t border-zinc-800 z-50">
                        <div class="flex justify-around py-2">
                            <button onclick="state.screen='lineup';render()" class="flex flex-col items-center py-2 px-2 ${state.screen === 'lineup' ? 'text-white' : 'text-zinc-500'}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span class="text-xs mt-1">Time</span>
                            </button>
                            <button onclick="state.screen='userDraft';render()" class="flex flex-col items-center py-2 px-2 ${state.screen === 'userDraft' ? 'text-purple-400' : 'text-purple-400/60'}">
                                <span class="text-lg">üéØ</span>
                                <span class="text-xs mt-0.5">Draft</span>
                            </button>
                            <button onclick="openMarketModal()" class="flex flex-col items-center py-2 px-2 text-zinc-500 relative">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                                <span class="text-xs mt-1">Mercado</span>
                                ${!isMarketOpen() ? '<span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>' : '<span class="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full"></span>'}
                            </button>
                            <button onclick="openTeamsModal()" class="flex flex-col items-center py-2 px-2 text-zinc-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                <span class="text-xs mt-1">Times</span>
                            </button>
                            <button onclick="goToRanking()" class="flex flex-col items-center py-2 px-2 ${state.screen === 'ranking' ? 'text-white' : 'text-zinc-500'}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                <span class="text-xs mt-1">Rank</span>
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="max-w-6xl mx-auto p-4 pb-24 sm:pb-4">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Campo -->
                        <div class="lg:col-span-2">
                            <div class="card rounded-xl p-4 relative" style="min-height: 520px;">
                                <!-- Seletor de Forma√ß√£o -->
                                <div class="absolute top-2 right-2 z-10">
                                    <select onchange="changeFormation(this.value)" 
                                        class="px-3 py-1.5 bg-black/70 border border-white/20 rounded-lg text-white text-sm font-medium cursor-pointer hover:bg-black/90 transition">
                                        <option value="4-3-3" ${state.formation === '4-3-3' ? 'selected' : ''}>4-3-3</option>
                                        <option value="4-4-2" ${state.formation === '4-4-2' ? 'selected' : ''}>4-4-2</option>
                                    </select>
                                </div>
                                <div class="campo-bg rounded-xl relative" style="min-height: 500px;">
                                
                                <!-- Linhas do campo -->
                                <div class="campo-linhas"></div>
                                <div class="area-gol-topo"></div>
                                <div class="pequena-area-topo"></div>
                                <div class="meia-lua-topo"></div>
                                <div class="area-ataque"></div>
                                <div class="pequena-area-baixo"></div>
                                <div class="meia-lua-baixo"></div>
                                <div class="ponto-central"></div>
                                
                                <!-- Jogadores no campo -->
                                ${fieldPositions.map((pos, i) => `
                                    <div class="player-slot absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer"
                                        style="top: ${pos.top}; left: ${pos.left};"
                                        onclick="openPlayerModal(${i}, 'starter')">
                                        ${state.starters[i] ? `
                                            <div class="relative text-center">
                                                <img src="${state.starters[i].photo}" 
                                                    class="w-16 h-16 rounded-full border-2 border-white/80 object-cover mx-auto"
                                                    onerror="this.src='https://via.placeholder.com/64/1a1a1a/ffffff?text=${state.starters[i].name.charAt(0)}'">
                                                ${state.scores[state.selectedRound]?.players?.[state.starters[i].id] !== undefined ? `
                                                    <div class="absolute -top-1 -right-1 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
                                                        ${state.scores[state.selectedRound].players[state.starters[i].id] >= 0 ? 'bg-green-500' : 'bg-red-500'} text-white
                                                        ${state.scores[state.selectedRound]?.live ? 'animate-pulse ring-2 ring-white/50' : ''}">
                                                        ${state.scores[state.selectedRound].players[state.starters[i].id]}
                                                    </div>
                                                ` : ''}
                                                <p class="text-white text-xs font-medium mt-1 bg-black/70 rounded px-2 py-0.5">
                                                    ${state.starters[i].name.split(' ').pop()}
                                                </p>
                                            </div>
                                        ` : `
                                            <div class="text-center">
                                                <div class="w-16 h-16 mx-auto rounded-full border-2 border-dashed border-white/30 flex items-center justify-center bg-black/20 hover:bg-black/40 transition">
                                                    <svg class="w-6 h-6 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                                </div>
                                                <p class="text-white/50 text-xs mt-1">${getSlotLabel(i)}</p>
                                            </div>
                                        `}
                                    </div>
                                `).join('')}
                                
                                </div>
                            </div>
                        </div>

                        <!-- Painel Lateral -->
                        <div class="space-y-4">
                            <!-- Pontua√ß√£o Total -->
                            <div class="card rounded-xl p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-zinc-400 text-sm font-medium">PONTUA√á√ÉO TOTAL</span>
                                    <span class="text-2xl font-bold text-white">${getTotalScore()}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <select onchange="changeRound(this.value)" class="flex-1 px-3 py-2 input-dark rounded-lg text-white text-sm">
                                        ${Array.from({length: state.currentRound || 1}, (_, i) => `
                                            <option value="${i+1}" ${state.selectedRound === i+1 ? 'selected' : ''}>Rodada ${i+1}${i+1 === state.currentRound ? ' ‚öΩ' : ''}</option>
                                        `).join('')}
                                    </select>
                                    <div class="flex items-center gap-1">
                                        ${state.hasLiveGames || state.scores[state.selectedRound]?.live ? `
                                            <span class="px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded-lg animate-pulse flex items-center gap-1">
                                                <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                                                AO VIVO
                                            </span>
                                        ` : ''}
                                        <span class="px-3 py-2 bg-zinc-800 rounded-lg text-green-400 font-semibold">${getRoundScore(state.selectedRound || 1)} pts</span>
                                        <button onclick="syncRoundScores()" 
                                            class="p-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-zinc-400 hover:text-white transition ${state.liveScoresUpdating ? 'animate-spin' : ''}"
                                            title="Atualizar pontua√ß√£o">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Jogos da Rodada -->
                            ${renderFixturesCard()}

                            <!-- T√©cnico -->
                            <div class="card rounded-xl p-4">
                                <h3 class="text-zinc-400 text-sm font-medium mb-3">T√âCNICO</h3>
                                <div onclick="openCoachModal()" class="cursor-pointer">
                                    ${state.coach ? `
                                        <div class="flex items-center gap-3 bg-zinc-800/50 rounded-lg p-3 hover:bg-zinc-800 transition">
                                            <div class="w-14 h-14 rounded-lg bg-orange-500/20 flex items-center justify-center text-lg font-bold text-orange-400 flex-shrink-0 border-2 border-orange-500/50">
                                                ${state.coach.name.split(' ').map(n => n[0]).join('').slice(0,2)}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-white font-medium text-sm">${state.coach.name}</p>
                                                <p class="text-zinc-500 text-xs">${state.coach.team}</p>
                                                ${state.scores[state.selectedRound]?.coach !== undefined ? `
                                                    <p class="text-green-400 text-sm font-semibold">+${state.scores[state.selectedRound].coach} pts</p>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="flex items-center justify-center h-16 border border-dashed border-zinc-700 rounded-lg hover:border-zinc-500 transition">
                                            <span class="text-zinc-500 text-sm">+ Selecionar T√©cnico</span>
                                        </div>
                                    `}
                                </div>
                            </div>

                            <!-- Reservas -->
                            <div class="card rounded-xl p-4">
                                <h3 class="text-zinc-400 text-sm font-medium mb-3">RESERVAS <span class="text-zinc-600">${ensureArray(state.reserves, 7).filter(r => r).length}/7</span></h3>
                                ${(() => {
                                    const reservePositions = [
                                        { pos: 'GOL', label: 'Goleiro' },
                                        { pos: 'DEF', label: 'Defensor' },
                                        { pos: 'DEF', label: 'Defensor' },
                                        { pos: 'MEI', label: 'Meia' },
                                        { pos: 'MEI', label: 'Meia' },
                                        { pos: 'ATA', label: 'Atacante' },
                                        { pos: 'ATA', label: 'Atacante' }
                                    ];
                                    return `
                                        <div class="space-y-2">
                                            <!-- Goleiro -->
                                            <div class="flex items-center gap-2">
                                                <span class="text-zinc-600 text-xs w-12">GOL</span>
                                                <div onclick="openPlayerModal(0, 'reserve')" class="cursor-pointer flex-1">
                                                    ${state.reserves[0] ? `
                                                        <div class="flex items-center gap-2 bg-zinc-800/50 rounded-lg p-2">
                                                            <img src="${state.reserves[0].photo}" class="w-8 h-8 rounded-md object-cover"
                                                                onerror="this.src='https://via.placeholder.com/32/1a1a1a/ffffff?text=${state.reserves[0].name.charAt(0)}'">
                                                            <span class="text-white text-sm truncate">${state.reserves[0].name.split(' ').pop()}</span>
                                                        </div>
                                                    ` : `
                                                        <div class="h-10 rounded-lg border border-dashed border-zinc-700 flex items-center justify-center hover:border-zinc-500 transition">
                                                            <span class="text-zinc-600 text-xs">+ Goleiro</span>
                                                        </div>
                                                    `}
                                                </div>
                                            </div>
                                            <!-- Defensores -->
                                            <div class="flex items-center gap-2">
                                                <span class="text-zinc-600 text-xs w-12">DEF</span>
                                                <div class="flex-1 grid grid-cols-2 gap-2">
                                                    ${[1, 2].map(i => `
                                                        <div onclick="openPlayerModal(${i}, 'reserve')" class="cursor-pointer">
                                                            ${state.reserves[i] ? `
                                                                <div class="flex items-center gap-2 bg-zinc-800/50 rounded-lg p-2">
                                                                    <img src="${state.reserves[i].photo}" class="w-8 h-8 rounded-md object-cover"
                                                                        onerror="this.src='https://via.placeholder.com/32/1a1a1a/ffffff?text=${state.reserves[i].name.charAt(0)}'">
                                                                    <span class="text-white text-xs truncate">${state.reserves[i].name.split(' ').pop()}</span>
                                                                </div>
                                                            ` : `
                                                                <div class="h-10 rounded-lg border border-dashed border-zinc-700 flex items-center justify-center hover:border-zinc-500 transition">
                                                                    <span class="text-zinc-600 text-xs">+ Defensor</span>
                                                                </div>
                                                            `}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            <!-- Meias -->
                                            <div class="flex items-center gap-2">
                                                <span class="text-zinc-600 text-xs w-12">MEI</span>
                                                <div class="flex-1 grid grid-cols-2 gap-2">
                                                    ${[3, 4].map(i => `
                                                        <div onclick="openPlayerModal(${i}, 'reserve')" class="cursor-pointer">
                                                            ${state.reserves[i] ? `
                                                                <div class="flex items-center gap-2 bg-zinc-800/50 rounded-lg p-2">
                                                                    <img src="${state.reserves[i].photo}" class="w-8 h-8 rounded-md object-cover"
                                                                        onerror="this.src='https://via.placeholder.com/32/1a1a1a/ffffff?text=${state.reserves[i].name.charAt(0)}'">
                                                                    <span class="text-white text-xs truncate">${state.reserves[i].name.split(' ').pop()}</span>
                                                                </div>
                                                            ` : `
                                                                <div class="h-10 rounded-lg border border-dashed border-zinc-700 flex items-center justify-center hover:border-zinc-500 transition">
                                                                    <span class="text-zinc-600 text-xs">+ Meia</span>
                                                                </div>
                                                            `}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            <!-- Atacantes -->
                                            <div class="flex items-center gap-2">
                                                <span class="text-zinc-600 text-xs w-12">ATA</span>
                                                <div class="flex-1 grid grid-cols-2 gap-2">
                                                    ${[5, 6].map(i => `
                                                        <div onclick="openPlayerModal(${i}, 'reserve')" class="cursor-pointer">
                                                            ${state.reserves[i] ? `
                                                                <div class="flex items-center gap-2 bg-zinc-800/50 rounded-lg p-2">
                                                                    <img src="${state.reserves[i].photo}" class="w-8 h-8 rounded-md object-cover"
                                                                        onerror="this.src='https://via.placeholder.com/32/1a1a1a/ffffff?text=${state.reserves[i].name.charAt(0)}'">
                                                                    <span class="text-white text-xs truncate">${state.reserves[i].name.split(' ').pop()}</span>
                                                                </div>
                                                            ` : `
                                                                <div class="h-10 rounded-lg border border-dashed border-zinc-700 flex items-center justify-center hover:border-zinc-500 transition">
                                                                    <span class="text-zinc-600 text-xs">+ Atacante</span>
                                                                </div>
                                                            `}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                })()}
                            </div>

                            <!-- Status do Time -->
                            ${(() => {
                                const totalPlayers = ensureArray(state.starters, 11).filter(p => p).length + ensureArray(state.reserves, 7).filter(p => p).length;
                                const hasCoach = !!state.coach;
                                const isTeamComplete = totalPlayers === 18 && hasCoach;
                                
                                // Verificar se est√° perto do jogo (menos de 30 min)
                                const marketOpen = isMarketOpen();
                                
                                if (!isTeamComplete) {
                                    return `
                                        <div class="card rounded-xl p-4 border border-purple-500/30 bg-purple-500/5">
                                            <div class="flex items-center gap-2 text-purple-400 mb-2">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                                <span class="text-sm font-medium">üìù Modo Esbo√ßo</span>
                                            </div>
                                            <p class="text-zinc-400 text-xs mb-2">Monte um rascunho dos seus picks favoritos!</p>
                                            <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-2 mb-3">
                                                <p class="text-yellow-400 text-xs">‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Este √© apenas um esbo√ßo para voc√™ n√£o esquecer seus picks. A escala√ß√£o oficial ser√° definida no Draft!</p>
                                            </div>
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="text-zinc-500">Jogadores: ${totalPlayers}/18</span>
                                                <span class="text-zinc-500">${hasCoach ? '‚úì T√©cnico' : '‚úó Sem t√©cnico'}</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                if (marketOpen) {
                                    return `
                                        <div class="card rounded-xl p-4 border border-green-500/30">
                                            <div class="flex items-center gap-2 text-green-400 mb-2">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                <span class="text-sm font-medium">‚úÖ Time Completo</span>
                                            </div>
                                            <p class="text-zinc-500 text-xs">Voc√™ pode trocar titulares e reservas at√© 30 min antes do primeiro jogo</p>
                                        </div>
                                        
                                        <!-- Substitui√ß√µes -->
                                        <div class="card rounded-xl p-4">
                                            <h3 class="text-zinc-400 text-sm font-medium mb-3">üîÑ SUBSTITUI√á√ïES</h3>
                                            <p class="text-zinc-500 text-xs mb-3">Troque titulares por reservas da mesma posi√ß√£o</p>
                                            <button onclick="openSubstitutionModal()" class="w-full py-2.5 bg-green-500 hover:bg-green-400 text-white rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                                                Fazer Substitui√ß√£o
                                            </button>
                                        </div>
                                    `;
                                }
                                
                                // Mercado fechado = escala√ß√£o travada
                                return `
                                    <div class="card rounded-xl p-4 border border-green-500/30">
                                        <div class="flex items-center gap-2 text-green-400 mb-2">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="text-sm font-medium">üîí Escala√ß√£o Confirmada</span>
                                        </div>
                                        <p class="text-zinc-500 text-xs">Rodada em andamento - aguarde o fim dos jogos</p>
                                    </div>
                                `;
                            })()}

                            <!-- Status -->
                            ${state.players.length > 0 ? `
                                <div class="card rounded-xl p-3">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-zinc-500">${state.players.length} jogadores</span>
                                        <span class="text-green-500">Sincronizado</span>
                                    </div>
                                </div>
                            ` : state.isLoading ? `
                                <div class="card rounded-xl p-3">
                                    <p class="text-zinc-500 text-sm text-center">Carregando jogadores...</p>
                                </div>
                            ` : ''}
                            
                            <!-- Acesso R√°pido ao Draft -->
                            <button onclick="state.screen='userDraft';render()" 
                                class="w-full card rounded-xl p-4 border border-purple-500/30 bg-purple-500/5 hover:bg-purple-500/10 transition text-left">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üéØ</span>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-purple-400 text-sm">Sala do Draft</h3>
                                        <p class="text-zinc-500 text-xs">Chat e acompanhamento ao vivo</p>
                                    </div>
                                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                                ${(state.draftChatMessages || []).length > 0 ? `
                                    <div class="mt-2 pt-2 border-t border-purple-500/20">
                                        <p class="text-zinc-500 text-xs">${state.draftChatMessages.length} mensagens no chat</p>
                                    </div>
                                ` : ''}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal Jogadores -->
                ${state.modal === 'player' ? renderPlayerModal() : ''}
                
                <!-- Modal T√©cnico -->
                ${state.modal === 'coach' ? renderCoachModal() : ''}

                <!-- Modal Sync -->
                ${state.modal === 'sync' ? renderSyncModal() : ''}

                <!-- Modal Mercado Fechado -->
                ${state.modal === 'marketClosed' ? renderMarketClosedModal() : ''}

                <!-- Modal Mercado -->
                ${state.modal === 'market' ? renderMarketModal() : ''}

                <!-- Modal Comprar -->
                ${state.modal === 'buy' ? renderBuyModal() : ''}

                <!-- Modal Ofertas -->
                ${state.modal === 'offers' ? renderOffersModal() : ''}

                <!-- Modal Fazer Oferta -->
                ${state.modal === 'makeOffer' ? renderMakeOfferModal() : ''}

                <!-- Modal Times -->
                ${state.modal === 'teams' ? renderTeamsModal() : ''}

                <!-- Modal Ver Time -->
                ${state.modal === 'viewTeam' ? renderViewTeamModal() : ''}

                <!-- Modal Substitui√ß√£o -->
                ${state.modal === 'substitution' ? renderSubstitutionModal() : ''}

                <!-- Modal Configura√ß√µes -->
                ${state.modal === 'settings' ? renderSettingsModal() : ''}
                
                <!-- Modal Perfil de Usu√°rio -->
                ${state.modal === 'profile' ? renderProfileModal() : ''}
                
                <!-- Modal Mensagens Privadas -->
                ${state.modal === 'privateChat' ? renderPrivateChatModal() : ''}
                
                <!-- Modal Lista de Mensagens -->
                ${state.modal === 'messagesList' ? renderMessagesListModal() : ''}
            `;
        }

        function renderSettingsModal() {
            const brazilianTeams = [
                'Flamengo', 'Palmeiras', 'S√£o Paulo', 'Corinthians', 'Fluminense', 
                'Botafogo', 'Vasco', 'Gr√™mio', 'Internacional', 'Atl√©tico-MG',
                'Cruzeiro', 'Santos', 'Bahia', 'Fortaleza', 'Athletico-PR',
                'Sport', 'Vit√≥ria', 'Cear√°', 'Goi√°s', 'Coritiba'
            ].sort();
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-zinc-800">
                            <div class="flex justify-between items-center">
                                <h3 class="font-display text-xl text-white">CONFIGURA√á√ïES</h3>
                                <button onclick="closeModalDirect()" class="text-zinc-500 hover:text-white p-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-5 overflow-y-auto max-h-[60vh]">
                            <!-- Foto do Perfil / Escudo -->
                            <div>
                                <label class="block text-zinc-400 text-sm mb-3">Sua Foto / Escudo do Time</label>
                                <div class="flex items-center gap-4">
                                    <div id="settingsLogoPreview" class="relative">
                                        ${state.teamLogo ? 
                                            `<img src="${state.teamLogo}" class="w-20 h-20 rounded-full object-cover border-2 border-green-500">` :
                                            `<div class="w-20 h-20 bg-zinc-800 rounded-full flex items-center justify-center text-zinc-500 text-2xl font-bold border-2 border-zinc-700">
                                                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                            </div>`
                                        }
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <button onclick="document.getElementById('settingsLogoInput').click()" 
                                            class="w-full py-2.5 bg-green-500 hover:bg-green-400 text-white rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                            ${state.teamLogo ? 'Trocar Foto' : 'Adicionar Foto'}
                                        </button>
                                        ${state.teamLogo ? `
                                            <button onclick="removeTeamLogo()" 
                                                class="w-full py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm transition">
                                                Remover Foto
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                                <input type="file" id="settingsLogoInput" accept="image/*" class="hidden" onchange="handleSettingsLogoUpload(event)">
                            </div>
                            
                            <!-- Nome do Time -->
                            <div>
                                <label class="block text-zinc-400 text-sm mb-2">Nome do Time</label>
                                <input type="text" id="settingsTeamName" value="${state.teamName || ''}" 
                                    class="w-full px-4 py-3 input-dark rounded-lg text-white" 
                                    placeholder="Nome do seu time">
                            </div>
                            
                            <!-- Time que Torce -->
                            <div>
                                <label class="block text-zinc-400 text-sm mb-2">‚öΩ Time que voc√™ torce</label>
                                <select id="settingsFavoriteTeam" 
                                    class="w-full px-4 py-3 input-dark rounded-lg text-white">
                                    <option value="">Selecione seu time...</option>
                                    ${brazilianTeams.map(t => `
                                        <option value="${t}" ${state.favoriteTeam === t ? 'selected' : ''}>${t}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <!-- Bio -->
                            <div>
                                <label class="block text-zinc-400 text-sm mb-2">üìù Sobre voc√™</label>
                                <textarea id="settingsBio" 
                                    class="w-full px-4 py-3 input-dark rounded-lg text-white resize-none" 
                                    rows="3"
                                    maxlength="150"
                                    placeholder="Escreva algo sobre voc√™...">${state.userBio || ''}</textarea>
                                <p class="text-zinc-600 text-xs mt-1 text-right">${(state.userBio || '').length}/150</p>
                            </div>
                            
                            <!-- Info do Usu√°rio -->
                            <div class="bg-zinc-800/50 rounded-lg p-4">
                                <p class="text-zinc-500 text-xs mb-1">Usu√°rio</p>
                                <p class="text-white font-medium">@${state.currentUser}</p>
                            </div>
                            
                            <!-- Zerar Pontua√ß√µes (Admin) -->
                            <div class="border-t border-zinc-700 pt-4">
                                <p class="text-zinc-500 text-xs mb-2">√Årea de Teste</p>
                                <button onclick="zerarPontuacoes()" 
                                    class="w-full py-2 bg-red-500/20 hover:bg-red-500/40 text-red-400 rounded-lg text-sm font-medium border border-red-500/30 transition">
                                    üóëÔ∏è Zerar Todas as Pontua√ß√µes
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-4 border-t border-zinc-800 flex gap-3">
                            <button onclick="closeModalDirect()" class="flex-1 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-lg font-medium transition">
                                Cancelar
                            </button>
                            <button onclick="saveSettings()" class="flex-1 py-3 btn-primary text-white rounded-lg font-medium transition">
                                Salvar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMarketModal() {
            const userTotal = getTotalScore();
            const marketPlayers = getMarketPlayers();
            
            // Filtrar jogadores do mercado
            let filteredPlayers = marketPlayers;
            if (state.marketFilter && state.marketFilter !== 'all') {
                filteredPlayers = marketPlayers.filter(p => p.position === state.marketFilter);
            }
            if (state.marketSearch) {
                const search = state.marketSearch.toLowerCase();
                filteredPlayers = filteredPlayers.filter(p => 
                    p.name.toLowerCase().includes(search) || 
                    p.team.toLowerCase().includes(search)
                );
            }
            
            // Ordenar por pre√ßo (mais caros primeiro)
            filteredPlayers = filteredPlayers.map(p => ({...p, price: getPlayerPrice(p.id)}))
                .sort((a, b) => b.price - a.price);
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-zinc-800">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="font-display text-2xl text-white">MERCADO</h3>
                                    <p class="text-zinc-500 text-sm">${filteredPlayers.length} jogadores dispon√≠veis</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p class="text-zinc-500 text-xs">Seus pontos</p>
                                        <p class="text-xl font-bold text-green-400">${userTotal} pts</p>
                                    </div>
                                    <button onclick="closeModalDirect()" class="text-zinc-500 hover:text-white p-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtros -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <input type="text" placeholder="Buscar jogador ou time..." 
                                    id="marketSearchInput"
                                    value="${state.marketSearch || ''}"
                                    oninput="updateMarketSearch(this.value)"
                                    class="flex-1 min-w-[200px] px-3 py-2 input-dark rounded-lg text-white text-sm">
                                <div class="flex gap-1">
                                    <button onclick="state.marketFilter='all';render()" 
                                        class="px-3 py-2 rounded-lg text-sm ${!state.marketFilter || state.marketFilter === 'all' ? 'bg-green-500 text-white' : 'bg-zinc-800 text-zinc-400'}">
                                        Todos
                                    </button>
                                    <button onclick="state.marketFilter='GOL';render()" 
                                        class="px-3 py-2 rounded-lg text-sm ${state.marketFilter === 'GOL' ? 'bg-green-500 text-white' : 'bg-zinc-800 text-zinc-400'}">
                                        GOL
                                    </button>
                                    <button onclick="state.marketFilter='DEF';render()" 
                                        class="px-3 py-2 rounded-lg text-sm ${state.marketFilter === 'DEF' ? 'bg-green-500 text-white' : 'bg-zinc-800 text-zinc-400'}">
                                        DEF
                                    </button>
                                    <button onclick="state.marketFilter='MEI';render()" 
                                        class="px-3 py-2 rounded-lg text-sm ${state.marketFilter === 'MEI' ? 'bg-green-500 text-white' : 'bg-zinc-800 text-zinc-400'}">
                                        MEI
                                    </button>
                                    <button onclick="state.marketFilter='ATA';render()" 
                                        class="px-3 py-2 rounded-lg text-sm ${state.marketFilter === 'ATA' ? 'bg-green-500 text-white' : 'bg-zinc-800 text-zinc-400'}">
                                        ATA
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tabs -->
                            <div class="flex gap-2">
                                <button onclick="state.marketTab='buy';render()" 
                                    class="flex-1 py-2 rounded-lg text-sm font-medium ${!state.marketTab || state.marketTab === 'buy' ? 'bg-green-500 text-white' : 'bg-zinc-800/50 text-zinc-500'}">
                                    üõí Comprar
                                </button>
                                <button onclick="state.marketTab='sell';render()" 
                                    class="flex-1 py-2 rounded-lg text-sm font-medium ${state.marketTab === 'sell' ? 'bg-green-500 text-white' : 'bg-zinc-800/50 text-zinc-500'}">
                                    üí∞ Vender
                                </button>
                            </div>
                        </div>
                        
                        <div id="marketListContainer" class="p-4 overflow-y-auto" style="max-height: calc(90vh - 250px);">
                            ${!state.marketTab || state.marketTab === 'buy' ? `
                                <!-- Lista de jogadores para comprar -->
                                ${filteredPlayers.length === 0 ? `
                                    <p class="text-zinc-500 text-center py-8">Nenhum jogador dispon√≠vel</p>
                                ` : `
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                        ${filteredPlayers.slice(0, 60).map(p => `
                                            <div class="bg-zinc-800/50 rounded-lg p-3 flex items-center gap-3">
                                                <img src="${p.photo}" class="w-12 h-12 rounded-lg object-cover"
                                                    onerror="this.src='https://via.placeholder.com/48/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-white text-sm font-medium truncate">${p.name}</p>
                                                    <p class="text-zinc-500 text-xs truncate">${p.team}</p>
                                                    <span class="text-xs px-1.5 py-0.5 bg-zinc-700 text-zinc-400 rounded">${p.position}</span>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-green-400 font-bold">${p.price}</p>
                                                    <p class="text-zinc-600 text-xs">pts</p>
                                                    <button onclick="openBuyModal(${p.id})" 
                                                        class="mt-1 px-2 py-1 bg-green-500 hover:bg-green-400 text-white text-xs rounded">
                                                        Comprar
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${filteredPlayers.length > 60 ? `
                                        <p class="text-zinc-600 text-center text-sm mt-4">Mostrando 60 de ${filteredPlayers.length}. Use os filtros.</p>
                                    ` : ''}
                                `}
                            ` : `
                                <!-- Lista de jogadores do meu time para vender -->
                                <div class="mb-4">
                                    <h4 class="text-zinc-400 text-sm mb-2">TITULARES</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                        ${state.starters.map((p, i) => p ? `
                                            <div class="bg-zinc-800/50 rounded-lg p-3 flex items-center gap-3">
                                                <img src="${p.photo}" class="w-10 h-10 rounded-lg object-cover"
                                                    onerror="this.src='https://via.placeholder.com/40/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-white text-sm font-medium truncate">${p.name}</p>
                                                    <p class="text-zinc-500 text-xs">${p.position} - ${p.team}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-green-400 font-bold text-sm">+${getPlayerPrice(p.id)}</p>
                                                    <button onclick="confirmSellPlayer('starter', ${i})" 
                                                        class="mt-1 px-2 py-1 bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white text-xs rounded transition">
                                                        Vender
                                                    </button>
                                                </div>
                                            </div>
                                        ` : '').join('')}
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-zinc-400 text-sm mb-2">RESERVAS</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                        ${state.reserves.map((p, i) => p ? `
                                            <div class="bg-zinc-800/50 rounded-lg p-3 flex items-center gap-3">
                                                <img src="${p.photo}" class="w-10 h-10 rounded-lg object-cover"
                                                    onerror="this.src='https://via.placeholder.com/40/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-white text-sm font-medium truncate">${p.name}</p>
                                                    <p class="text-zinc-500 text-xs">${p.position} - ${p.team}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-green-400 font-bold text-sm">+${getPlayerPrice(p.id)}</p>
                                                    <button onclick="confirmSellPlayer('reserve', ${i})" 
                                                        class="mt-1 px-2 py-1 bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white text-xs rounded transition">
                                                        Vender
                                                    </button>
                                                </div>
                                            </div>
                                        ` : '').join('')}
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <!-- Legenda de pre√ßos -->
                        <div class="p-4 border-t border-zinc-800 bg-zinc-900/50">
                            <p class="text-zinc-500 text-xs mb-2">Pre√ßo = 100 + (m√©dia de pts √ó multiplicador)</p>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <span class="px-2 py-1 bg-yellow-500/20 rounded text-yellow-400">Craque (+12 avg) = 700+</span>
                                <span class="px-2 py-1 bg-green-500/20 rounded text-green-400">Bom (+5 avg) = 250+</span>
                                <span class="px-2 py-1 bg-zinc-700 rounded text-zinc-400">Sem dados = 100</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBuyModal() {
            const player = state.players.find(p => p.id === state.buyingPlayerId);
            if (!player) return '';
            
            const price = getPlayerPrice(player.id);
            const userTotal = getTotalScore();
            const playerNormalizedPos = normalizePosition(player.position);
            
            // Pegar todos os meus jogadores da MESMA POSI√á√ÉO para escolher quem sai
            const myPlayersToRemove = [];
            state.starters.forEach((p, i) => {
                if (p && normalizePosition(p.position) === playerNormalizedPos) {
                    myPlayersToRemove.push({ ...p, slotType: 'starter', slotIndex: i });
                }
            });
            state.reserves.forEach((p, i) => {
                if (p && normalizePosition(p.position) === playerNormalizedPos) {
                    myPlayersToRemove.push({ ...p, slotType: 'reserve', slotIndex: i });
                }
            });
            
            const posLabel = playerNormalizedPos === 'GOL' ? 'Goleiro' : playerNormalizedPos === 'DEF' ? 'Defensor' : playerNormalizedPos === 'MEI' ? 'Meio-campista' : 'Atacante';
            const canBuy = price <= userTotal;
            
            // Jogador selecionado para sair
            const selectedToRemove = state.swapPlayerId ? myPlayersToRemove.find(p => p.id === state.swapPlayerId) : null;
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-lg overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-zinc-800">
                            <h3 class="font-display text-xl text-white">CONTRATAR JOGADOR</h3>
                        </div>
                        <div class="p-4 max-h-[70vh] overflow-y-auto">
                            
                            <!-- Jogador que quer comprar -->
                            <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 mb-4">
                                <p class="text-green-400 text-xs mb-2">‚¨áÔ∏è ENTRANDO NO SEU TIME</p>
                                <div class="flex items-center gap-4">
                                    <img src="${player.photo}" class="w-14 h-14 rounded-xl object-cover"
                                        onerror="this.src='https://via.placeholder.com/56/1a1a1a/ffffff?text=${player.name.charAt(0)}'">
                                    <div class="flex-1">
                                        <p class="text-white font-medium">${player.name}</p>
                                        <p class="text-zinc-500 text-sm">${player.team}</p>
                                        <span class="text-xs px-2 py-0.5 bg-zinc-700 text-zinc-400 rounded">${posLabel}</span>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-bold text-green-400">${price}</p>
                                        <p class="text-zinc-500 text-xs">pontos</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Seus pontos -->
                            <div class="bg-zinc-800/50 rounded-lg p-3 mb-4 flex justify-between items-center">
                                <span class="text-zinc-400">Seus pontos:</span>
                                <span class="${canBuy ? 'text-green-400' : 'text-red-400'} font-bold">${userTotal} pts</span>
                            </div>
                            
                            ${!canBuy ? `
                                <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4 text-center">
                                    <p class="text-red-400">‚ùå Pontos insuficientes!</p>
                                    <p class="text-zinc-500 text-sm">Voc√™ precisa de ${price} pts</p>
                                </div>
                            ` : `
                                <!-- Selecionar jogador para sair -->
                                <div class="mb-4">
                                    <p class="text-red-400 text-xs mb-2">‚¨ÜÔ∏è ESCOLHA QUEM SAI DO TIME (${posLabel})</p>
                                    
                                    ${myPlayersToRemove.length === 0 ? `
                                        <p class="text-zinc-500 text-center py-4">Voc√™ n√£o tem ${posLabel} no time</p>
                                    ` : `
                                        <div class="space-y-2">
                                            ${myPlayersToRemove.map(p => `
                                                <button onclick="state.swapPlayerId=${p.id};render()" 
                                                    class="w-full p-3 rounded-lg text-left transition flex items-center gap-3 ${state.swapPlayerId === p.id ? 'bg-red-500/20 border-2 border-red-500' : 'bg-zinc-800 hover:bg-zinc-700 border border-zinc-700'}">
                                                    <img src="${p.photo}" class="w-10 h-10 rounded-lg object-cover">
                                                    <div class="flex-1">
                                                        <p class="text-white text-sm">${p.name}</p>
                                                        <p class="text-zinc-500 text-xs">${p.team}</p>
                                                    </div>
                                                    <span class="text-xs px-2 py-1 ${p.slotType === 'starter' ? 'bg-green-500/20 text-green-400' : 'bg-zinc-700 text-zinc-400'} rounded">
                                                        ${p.slotType === 'starter' ? 'Titular' : 'Reserva'}
                                                    </span>
                                                </button>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                                
                                ${selectedToRemove ? `
                                    <!-- Resumo -->
                                    <div class="bg-zinc-800 rounded-xl p-4 mb-4">
                                        <div class="flex items-center justify-center gap-4">
                                            <div class="text-center">
                                                <img src="${selectedToRemove.photo}" class="w-12 h-12 rounded-lg mx-auto mb-1">
                                                <p class="text-red-400 text-xs">SAI</p>
                                                <p class="text-white text-sm">${selectedToRemove.name}</p>
                                            </div>
                                            <div class="text-2xl">‚û°Ô∏è</div>
                                            <div class="text-center">
                                                <img src="${player.photo}" class="w-12 h-12 rounded-lg mx-auto mb-1">
                                                <p class="text-green-400 text-xs">ENTRA</p>
                                                <p class="text-white text-sm">${player.name}</p>
                                            </div>
                                        </div>
                                        <div class="border-t border-zinc-700 mt-3 pt-3 text-center">
                                            <span class="text-zinc-400">Custo:</span>
                                            <span class="text-red-400 font-bold ml-2">-${price} pts</span>
                                        </div>
                                    </div>
                                    
                                    <button onclick="executeSwapSimple(${player.id}, '${selectedToRemove.slotType}', ${selectedToRemove.slotIndex})" 
                                        class="w-full py-3 bg-green-500 hover:bg-green-400 text-white rounded-lg font-medium mb-2">
                                        ‚úÖ Confirmar Contrata√ß√£o
                                    </button>
                                ` : ''}
                            `}
                            
                            <button onclick="state.modal='market';state.buyingPlayerId=null;state.swapPlayerId=null;render()" 
                                class="w-full py-3 bg-zinc-700 hover:bg-zinc-600 text-white rounded-lg text-sm font-medium">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayerModal() {
            const positionForSlot = state.slotType === 'starter' 
                ? getPositionForSlot(state.slotIndex) 
                : getReservePosition(state.slotIndex);
            const usedIds = [...state.starters, ...state.reserves].filter(p => p).map(p => p.id);
            
            let filtered = state.players.filter(p => !usedIds.includes(p.id));
            
            // Filtrar por posi√ß√£o do slot automaticamente (usando compatibilidade)
            if (positionForSlot) {
                filtered = filtered.filter(p => isPositionCompatible(p.position, positionForSlot));
            }
            
            if (state.filterTeam) {
                filtered = filtered.filter(p => p.team === state.filterTeam);
            }
            
            // Filtro manual de posi√ß√£o (sobrescreve se selecionado)
            if (state.filterPosition) {
                filtered = state.players.filter(p => !usedIds.includes(p.id) && isPositionCompatible(p.position, state.filterPosition));
                if (state.filterTeam) {
                    filtered = filtered.filter(p => p.team === state.filterTeam);
                }
            }
            
            if (state.searchName) {
                const search = state.searchName.toLowerCase();
                filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
            }

            const uniqueTeams = [...new Set(state.players.map(p => p.team))].sort();
            const posLabel = positionForSlot === 'GOL' ? 'Goleiro' : positionForSlot === 'DEF' ? 'Defensor' : positionForSlot === 'MEI' ? 'Meio-campo' : 'Atacante';

            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="font-display text-xl text-white tracking-wider">SELECIONAR JOGADOR</h3>
                                    <p class="text-white/40 text-sm">${state.slotType === 'starter' ? 'Titular' : 'Reserva'} - ${posLabel}</p>
                                </div>
                                <button onclick="closeModalDirect()" class="text-white/40 hover:text-white p-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <input type="text" placeholder="Buscar jogador..." 
                                    id="searchPlayerInput"
                                    value="${state.searchName}"
                                    oninput="state.searchName=this.value;renderPlayerList()"
                                    class="px-3 py-2.5 input-dark rounded-lg text-white text-sm placeholder-white/30">
                                
                                <select onchange="state.filterTeam=this.value;render()" 
                                    class="px-3 py-2.5 input-dark text-white rounded-lg text-sm">
                                    <option value="">Todos os times</option>
                                    ${uniqueTeams.map(t => `
                                        <option value="${t}" ${state.filterTeam === t ? 'selected' : ''}>${t}</option>
                                    `).join('')}
                                </select>
                                
                                <select onchange="state.filterPosition=this.value;render()"
                                    class="px-3 py-2.5 input-dark text-white rounded-lg text-sm">
                                    <option value="" ${state.filterPosition === '' ? 'selected' : ''}>Todas posi√ß√µes</option>
                                    <option value="GOL" ${state.filterPosition === 'GOL' ? 'selected' : ''}>Goleiro</option>
                                    <option value="DEF" ${state.filterPosition === 'DEF' ? 'selected' : ''}>Defensor</option>
                                    <option value="MEI" ${state.filterPosition === 'MEI' ? 'selected' : ''}>Meio-campo</option>
                                    <option value="ATA" ${state.filterPosition === 'ATA' ? 'selected' : ''}>Atacante</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="playerListContainer" class="p-4 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                            ${state.players.length === 0 ? `
                                <div class="text-center py-12">
                                    <p class="text-white/40 mb-4">Nenhum jogador carregado</p>
                                    <button onclick="state.modal=null;syncAllData()" 
                                        class="px-6 py-3 btn-primary text-white rounded-lg text-sm font-medium">
                                        Carregar Jogadores
                                    </button>
                                </div>
                            ` : filtered.length === 0 ? `
                                <p class="text-center text-white/40 py-8">Nenhum jogador encontrado</p>
                            ` : `
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    ${filtered.slice(0, 99).map(p => `
                                        <div onclick="selectPlayer(${p.id})" 
                                            class="bg-white/5 hover:bg-white/10 rounded-lg p-3 cursor-pointer transition">
                                            <div class="flex items-center gap-3">
                                                <img src="${p.photo}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0" 
                                                    onerror="this.src='https://via.placeholder.com/48/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-white text-sm font-medium truncate">${p.name}</p>
                                                    <p class="text-white/40 text-xs truncate">${p.team}</p>
                                                    <span class="text-xs px-1.5 py-0.5 bg-green-500/20 text-green-400 rounded">${p.position}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${filtered.length > 99 ? `
                                    <p class="text-center text-white/30 text-sm mt-4">Mostrando 99 de ${filtered.length}. Use os filtros.</p>
                                ` : ''}
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal de Perfil de Usu√°rio
        function renderProfileModal() {
            const user = state.users[state.viewingProfile];
            if (!user) return '';
            
            const nick = state.viewingProfile;
            const isMe = nick === state.currentUser;
            
            // Calcular pontua√ß√£o total
            let totalPoints = 0;
            if (user.scores) {
                Object.values(user.scores).forEach(round => {
                    if (round && round.total) totalPoints += round.total;
                });
            }
            
            // T√≠tulos do usu√°rio
            const titles = user.titles || [];
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-md overflow-hidden" onclick="event.stopPropagation()">
                        <!-- Header com foto -->
                        <div class="relative">
                            <div class="h-24 bg-gradient-to-br from-green-500/30 to-blue-500/30"></div>
                            <div class="absolute -bottom-12 left-1/2 transform -translate-x-1/2">
                                ${user.teamLogo ? 
                                    `<img src="${user.teamLogo}" class="w-24 h-24 rounded-full object-cover border-4 border-zinc-900">` :
                                    `<div class="w-24 h-24 rounded-full bg-zinc-800 border-4 border-zinc-900 flex items-center justify-center text-3xl font-bold text-white">${nick[0].toUpperCase()}</div>`
                                }
                            </div>
                            <button onclick="closeModalDirect()" class="absolute top-3 right-3 text-white/60 hover:text-white p-2 bg-black/30 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        
                        <div class="pt-14 pb-6 px-6 text-center">
                            <!-- Nome e usu√°rio -->
                            <h3 class="text-xl font-bold text-white">${user.teamName || nick}</h3>
                            <p class="text-zinc-500 text-sm">@${nick}</p>
                            
                            <!-- T√≠tulos -->
                            ${titles.length > 0 ? `
                                <div class="flex flex-wrap justify-center gap-2 mt-3">
                                    ${titles.map(t => `
                                        <span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs rounded-full">üèÜ ${t}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <!-- Time que torce -->
                            ${user.favoriteTeam ? `
                                <div class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-zinc-800 rounded-full">
                                    ${getTeamLogo(user.favoriteTeam) ? 
                                        `<img src="${getTeamLogo(user.favoriteTeam)}" class="w-6 h-6 object-contain">` : 
                                        `<span class="text-lg">‚öΩ</span>`
                                    }
                                    <span class="text-white text-sm font-medium">Torce para ${user.favoriteTeam}</span>
                                </div>
                            ` : ''}
                            
                            <!-- Bio -->
                            ${user.userBio ? `
                                <p class="mt-4 text-zinc-400 text-sm italic">"${user.userBio}"</p>
                            ` : ''}
                            
                            <!-- Stats -->
                            <div class="grid grid-cols-2 gap-4 mt-6">
                                <div class="bg-zinc-800/50 rounded-xl p-4">
                                    <p class="text-2xl font-bold text-green-400">${totalPoints}</p>
                                    <p class="text-zinc-500 text-xs">Pontos Totais</p>
                                </div>
                                <div class="bg-zinc-800/50 rounded-xl p-4">
                                    <p class="text-2xl font-bold text-purple-400">${titles.length}</p>
                                    <p class="text-zinc-500 text-xs">T√≠tulos</p>
                                </div>
                            </div>
                            
                            <!-- Bot√µes -->
                            <div class="mt-6 space-y-2">
                                ${!isMe ? `
                                    <button onclick="openPrivateChat('${nick}')" 
                                        class="w-full py-3 bg-blue-500 hover:bg-blue-400 text-white rounded-lg font-medium transition flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                        Enviar Mensagem
                                    </button>
                                ` : `
                                    <button onclick="state.modal='settings';render()" 
                                        class="w-full py-3 bg-zinc-700 hover:bg-zinc-600 text-white rounded-lg font-medium transition">
                                        ‚öôÔ∏è Editar Perfil
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Modal de Chat Privado
        function renderPrivateChatModal() {
            const otherUser = state.users[state.selectedChatUser];
            if (!otherUser) return '';
            
            const nick = state.selectedChatUser;
            
            // Filtrar mensagens entre os dois usu√°rios
            const chatKey = [state.currentUser, nick].sort().join('_');
            const messages = (state.privateMessages || []).filter(m => m.chatKey === chatKey);
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-md h-[80vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div class="p-4 border-b border-zinc-800 flex items-center gap-3">
                            <button onclick="closeModalDirect()" class="text-zinc-500 hover:text-white p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            ${otherUser.teamLogo ? 
                                `<img src="${otherUser.teamLogo}" class="w-10 h-10 rounded-full object-cover">` :
                                `<div class="w-10 h-10 rounded-full bg-zinc-700 flex items-center justify-center text-white font-bold">${nick[0].toUpperCase()}</div>`
                            }
                            <div class="flex-1 min-w-0">
                                <p class="text-white font-medium truncate">${otherUser.teamName || nick}</p>
                                <p class="text-zinc-500 text-xs">@${nick}</p>
                            </div>
                            <button onclick="viewProfile('${nick}')" class="text-zinc-500 hover:text-white p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            </button>
                        </div>
                        
                        <!-- Mensagens -->
                        <div id="privateChatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
                            ${messages.length === 0 ? `
                                <div class="text-center py-8">
                                    <p class="text-zinc-600 text-4xl mb-2">üí¨</p>
                                    <p class="text-zinc-500 text-sm">Nenhuma mensagem ainda</p>
                                    <p class="text-zinc-600 text-xs">Comece a conversar!</p>
                                </div>
                            ` : messages.map(m => {
                                const isMe = m.from === state.currentUser;
                                const time = new Date(m.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                return `
                                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                                        <div class="max-w-[80%] ${isMe ? 'bg-green-500 text-white' : 'bg-zinc-800 text-white'} rounded-2xl px-4 py-2">
                                            <p class="text-sm">${m.text}</p>
                                            <p class="text-xs ${isMe ? 'text-green-200' : 'text-zinc-500'} text-right mt-1">${time}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Input -->
                        <div class="p-4 border-t border-zinc-800">
                            <div class="flex gap-2">
                                <input type="text" id="privateMsgInput" 
                                    class="flex-1 px-4 py-3 input-dark rounded-full text-white" 
                                    placeholder="Digite sua mensagem..."
                                    onkeypress="if(event.key==='Enter')sendPrivateMessage()">
                                <button onclick="sendPrivateMessage()" 
                                    class="px-4 py-3 bg-green-500 hover:bg-green-400 rounded-full transition">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Modal de Lista de Mensagens
        function renderMessagesListModal() {
            // Agrupar mensagens por conversa
            const conversations = {};
            (state.privateMessages || []).forEach(m => {
                const otherUser = m.from === state.currentUser ? m.to : m.from;
                if (!conversations[otherUser]) {
                    conversations[otherUser] = {
                        user: otherUser,
                        messages: [],
                        lastMessage: null,
                        unread: 0
                    };
                }
                conversations[otherUser].messages.push(m);
                if (!conversations[otherUser].lastMessage || m.timestamp > conversations[otherUser].lastMessage.timestamp) {
                    conversations[otherUser].lastMessage = m;
                }
                if (m.to === state.currentUser && !m.read) {
                    conversations[otherUser].unread++;
                }
            });
            
            // Ordenar por √∫ltima mensagem
            const sortedConversations = Object.values(conversations)
                .sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-md max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-zinc-800 flex justify-between items-center">
                            <h3 class="font-display text-xl text-white">üí¨ MENSAGENS</h3>
                            <button onclick="closeModalDirect()" class="text-zinc-500 hover:text-white p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        
                        <div class="overflow-y-auto max-h-[60vh]">
                            ${sortedConversations.length === 0 ? `
                                <div class="text-center py-12 px-4">
                                    <p class="text-zinc-600 text-5xl mb-3">üí¨</p>
                                    <p class="text-zinc-500 text-sm">Nenhuma conversa ainda</p>
                                    <p class="text-zinc-600 text-xs mt-1">Clique em um usu√°rio no ranking para iniciar uma conversa</p>
                                </div>
                            ` : sortedConversations.map(conv => {
                                const userData = state.users[conv.user] || {};
                                const time = conv.lastMessage ? new Date(conv.lastMessage.timestamp).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) : '';
                                const preview = conv.lastMessage ? (conv.lastMessage.text.length > 30 ? conv.lastMessage.text.substring(0, 30) + '...' : conv.lastMessage.text) : '';
                                
                                return `
                                    <button onclick="openPrivateChat('${conv.user}')" 
                                        class="w-full p-4 border-b border-zinc-800 text-left hover:bg-zinc-800/50 transition flex items-center gap-3">
                                        ${userData.teamLogo ? 
                                            `<img src="${userData.teamLogo}" class="w-12 h-12 rounded-full object-cover flex-shrink-0">` :
                                            `<div class="w-12 h-12 rounded-full bg-zinc-700 flex items-center justify-center text-white font-bold text-lg flex-shrink-0">${conv.user[0].toUpperCase()}</div>`
                                        }
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-center">
                                                <p class="text-white font-medium truncate">${userData.teamName || conv.user}</p>
                                                <span class="text-zinc-500 text-xs">${time}</span>
                                            </div>
                                            <p class="text-zinc-500 text-sm truncate">${preview}</p>
                                        </div>
                                        ${conv.unread > 0 ? `
                                            <span class="w-6 h-6 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center">${conv.unread}</span>
                                        ` : ''}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCoachModal() {
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-white/5 flex justify-between items-center">
                            <h3 class="font-display text-xl text-white tracking-wider">SELECIONAR T√âCNICO</h3>
                            <button onclick="closeModalDirect()" class="text-white/40 hover:text-white p-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="p-4 overflow-y-auto max-h-[60vh]">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                ${state.coaches.map(c => `
                                    <div onclick="selectCoach(${c.id})" 
                                        class="bg-white/5 hover:bg-white/10 rounded-lg p-3 cursor-pointer transition flex items-center gap-3 ${state.coach?.id === c.id ? 'border border-green-500/50' : 'border border-transparent'}">
                                        <div class="w-12 h-12 rounded-lg bg-white/10 flex items-center justify-center text-sm font-bold text-white flex-shrink-0">
                                            ${c.name.split(' ').map(n => n[0]).join('').slice(0,2)}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-white text-sm font-medium">${c.name}</p>
                                            <p class="text-white/40 text-xs">${c.team}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para atualizar apenas a lista de jogadores (sem perder foco do input)
        function renderPlayerList() {
            const container = document.getElementById('playerListContainer');
            if (!container) return;

            const positionForSlot = state.slotType === 'starter' 
                ? getPositionForSlot(state.slotIndex) 
                : getReservePosition(state.slotIndex);
            const usedIds = [...state.starters, ...state.reserves].filter(p => p).map(p => p.id);
            
            let filtered = state.players.filter(p => !usedIds.includes(p.id));
            
            // Filtrar por posi√ß√£o do slot automaticamente (usando compatibilidade)
            if (positionForSlot) {
                filtered = filtered.filter(p => isPositionCompatible(p.position, positionForSlot));
            }
            
            if (state.filterTeam) {
                filtered = filtered.filter(p => p.team === state.filterTeam);
            }
            
            // Filtro manual de posi√ß√£o (sobrescreve se selecionado)
            if (state.filterPosition) {
                filtered = state.players.filter(p => !usedIds.includes(p.id) && isPositionCompatible(p.position, state.filterPosition));
                if (state.filterTeam) {
                    filtered = filtered.filter(p => p.team === state.filterTeam);
                }
            }
            
            if (state.searchName) {
                const search = state.searchName.toLowerCase();
                filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
            }

            let html = '';
            if (state.players.length === 0) {
                html = `
                    <div class="text-center py-12">
                        <p class="text-white/40 mb-4">Nenhum jogador carregado</p>
                        <button onclick="state.modal=null;syncAllData()" 
                            class="px-6 py-3 btn-primary text-white rounded-lg text-sm font-medium">
                            Carregar Jogadores
                        </button>
                    </div>
                `;
            } else if (filtered.length === 0) {
                html = `<p class="text-center text-white/40 py-8">Nenhum jogador encontrado</p>`;
            } else {
                html = `
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        ${filtered.slice(0, 99).map(p => `
                            <div onclick="selectPlayer(${p.id})" 
                                class="bg-white/5 hover:bg-white/10 rounded-lg p-3 cursor-pointer transition">
                                <div class="flex items-center gap-3">
                                    <img src="${p.photo}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0" 
                                        onerror="this.src='https://via.placeholder.com/48/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-white text-sm font-medium truncate">${p.name}</p>
                                        <p class="text-white/40 text-xs truncate">${p.team}</p>
                                        <span class="text-xs px-1.5 py-0.5 bg-green-500/20 text-green-400 rounded">${p.position}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${filtered.length > 99 ? `
                        <p class="text-center text-white/30 text-sm mt-4">Mostrando 99 de ${filtered.length}. Use os filtros.</p>
                    ` : ''}
                `;
            }
            
            container.innerHTML = html;
        }

        function renderSyncModal() {
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
                    <div class="card rounded-2xl w-full max-w-lg overflow-hidden">
                        <div class="p-4 border-b border-white/5 flex justify-between items-center">
                            <h3 class="font-display text-xl text-white tracking-wider">SINCRONIZANDO</h3>
                            ${!state.isLoading ? `
                                <button onclick="closeModalDirect()" class="text-white/40 hover:text-white p-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            ` : ''}
                        </div>
                        <div class="p-4">
                            <div class="sync-log bg-black/50 rounded-lg p-4 font-mono text-xs">
                                ${state.syncLogs.map(log => `
                                    <div class="mb-1 ${log.type === 'error' ? 'text-red-400' : log.type === 'success' ? 'text-green-400' : log.type === 'warning' ? 'text-yellow-400' : 'text-white/60'}">
                                        <span class="text-white/30">[${log.time}]</span> ${log.message}
                                    </div>
                                `).join('')}
                                ${state.syncLogs.length === 0 ? '<div class="text-white/30">Iniciando...</div>' : ''}
                            </div>
                            
                            ${state.isLoading ? `
                                <div class="mt-4 flex items-center justify-center gap-3">
                                    <div class="w-5 h-5 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span class="text-white/60 text-sm">Processando...</span>
                                </div>
                            ` : `
                                <div class="mt-4 text-center">
                                    <p class="text-green-400 text-sm font-medium mb-2">Sincroniza√ß√£o finalizada</p>
                                    <p class="text-white/40 text-xs">${state.players.length} jogadores de ${state.teams.length} times</p>
                                    <button onclick="closeModalDirect()" 
                                        class="mt-4 px-6 py-2.5 btn-primary text-white rounded-lg text-sm font-medium">
                                        Fechar
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMarketClosedModal() {
            const timeLeft = getTimeUntilMarketOpens();
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-sm overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-zinc-800 flex items-center justify-center">
                                <svg class="w-8 h-8 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-2">Mercado Fechado</h3>
                            <p class="text-zinc-500 text-sm mb-6">Abre nos dias 1 e 2 de cada m√™s</p>
                            
                            ${timeLeft ? `
                                <div class="bg-zinc-800/50 rounded-xl p-4 mb-6">
                                    <p class="text-zinc-500 text-xs mb-3 uppercase tracking-wider">Abre em</p>
                                    <div class="flex justify-center gap-3">
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-white">${timeLeft.days}</div>
                                            <div class="text-xs text-zinc-500">dias</div>
                                        </div>
                                        <div class="text-xl text-zinc-700">:</div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-white">${String(timeLeft.hours).padStart(2, '0')}</div>
                                            <div class="text-xs text-zinc-500">horas</div>
                                        </div>
                                        <div class="text-xl text-zinc-700">:</div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-white">${String(timeLeft.minutes).padStart(2, '0')}</div>
                                            <div class="text-xs text-zinc-500">min</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <button onclick="closeModalDirect()" class="w-full py-3 btn-primary text-white rounded-lg text-sm font-medium">
                                Entendi
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOffersModal() {
            const myOffers = state.offers.filter(o => o.to === state.currentUser && o.status === 'pending');
            const sentOffers = state.offers.filter(o => o.from === state.currentUser && o.status === 'pending');
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-zinc-800 flex justify-between items-center">
                            <h3 class="font-display text-xl text-white">OFERTAS</h3>
                            <button onclick="closeModalDirect()" class="text-zinc-500 hover:text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="p-4 overflow-y-auto max-h-[60vh]">
                            <h4 class="text-sm font-medium text-zinc-400 mb-3 uppercase tracking-wider">Recebidas</h4>
                            ${myOffers.length === 0 ? `
                                <p class="text-zinc-600 text-sm text-center py-4">Nenhuma oferta recebida</p>
                            ` : `
                                <div class="space-y-3 mb-6">
                                    ${myOffers.map(o => `
                                        <div class="bg-zinc-800/50 rounded-lg p-4">
                                            <div class="mb-3">
                                                <p class="text-white font-medium text-sm">${o.from} quer trocar:</p>
                                                <p class="text-zinc-400 text-xs mt-1">Oferece: <span class="text-green-400">${o.playerOffered?.name || 'Jogador'}</span></p>
                                                <p class="text-zinc-400 text-xs">Quer: <span class="text-amber-400">${o.playerWanted?.name || 'Jogador'}</span></p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="acceptOffer('${o.id}')" class="flex-1 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-xs font-medium">
                                                    Aceitar
                                                </button>
                                                <button onclick="rejectOffer('${o.id}')" class="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 text-white rounded-lg text-xs font-medium">
                                                    Recusar
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                            
                            <h4 class="text-sm font-medium text-zinc-400 mb-3 uppercase tracking-wider">Enviadas</h4>
                            ${sentOffers.length === 0 ? `
                                <p class="text-zinc-600 text-sm text-center py-4">Nenhuma oferta enviada</p>
                            ` : `
                                <div class="space-y-3">
                                    ${sentOffers.map(o => `
                                        <div class="bg-zinc-800/50 rounded-lg p-4">
                                            <p class="text-white font-medium text-sm">Para: ${o.to}</p>
                                            <p class="text-zinc-400 text-xs mt-1">Oferecendo: <span class="text-green-400">${o.playerOffered?.name || 'Jogador'}</span></p>
                                            <p class="text-zinc-400 text-xs">Pedindo: <span class="text-amber-400">${o.playerWanted?.name || 'Jogador'}</span></p>
                                            <span class="inline-block mt-2 px-2 py-1 bg-zinc-700 text-zinc-400 text-xs rounded">Aguardando</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMakeOfferModal() {
            const otherUsers = Object.entries(state.users)
                .filter(([nick, u]) => nick !== state.currentUser && u.isConfirmed)
                .map(([nick, u]) => ({ nick, ...u }));
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-md overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-zinc-800 flex justify-between items-center">
                            <h3 class="font-display text-xl text-white">FAZER OFERTA</h3>
                            <button onclick="closeModalDirect()" class="text-zinc-500 hover:text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="p-4">
                            <div class="bg-zinc-800/50 rounded-lg p-3 mb-4">
                                <p class="text-zinc-500 text-xs uppercase tracking-wider mb-1">Oferecendo</p>
                                <p class="text-white font-medium">${state.selectedPlayerForOffer?.name || 'Jogador'}</p>
                            </div>
                            
                            <p class="text-white font-semibold mb-3">Escolha o usu√°rio:</p>
                            ${otherUsers.length === 0 ? `
                                <p class="text-gray-400 text-center py-4">Nenhum outro usu√°rio com time confirmado</p>
                            ` : `
                                <div class="space-y-2">
                                    ${otherUsers.map(u => `
                                        <button onclick="state.offerTargetUser='${u.nick}';render()" 
                                            class="w-full text-left p-3 rounded-lg ${state.offerTargetUser === u.nick ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                            <span class="text-white font-semibold">${u.nick}</span>
                                            <span class="text-gray-400 ml-2">(${u.teamName})</span>
                                        </button>
                                    `).join('')}
                                </div>
                            `}
                            
                            ${state.offerTargetUser ? `
                                <div class="mt-4 pt-4 border-t border-gray-700">
                                    <p class="text-white font-semibold mb-3">Qual jogador voc√™ quer em troca?</p>
                                    <p class="text-gray-400 text-sm mb-2">Digite o ID do jogador desejado:</p>
                                    <input type="number" id="wantedPlayerId" placeholder="ID do jogador" 
                                        class="w-full px-3 py-2 bg-gray-700 text-white rounded-lg mb-3">
                                    <button onclick="sendOfferToUser('${state.offerTargetUser}', parseInt(document.getElementById('wantedPlayerId').value))" 
                                        class="w-full py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold">
                                        üì§ Enviar Oferta
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTeamsModal() {
            const confirmedUsers = Object.entries(state.users)
                .filter(([nick, u]) => u.isConfirmed)
                .map(([nick, u]) => ({ nick, ...u }));
            
            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-white/5 flex justify-between items-center">
                            <h3 class="font-display text-xl text-white tracking-wider">TIMES</h3>
                            <button onclick="closeModalDirect()" class="text-white/40 hover:text-white p-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="p-4 overflow-y-auto max-h-[60vh]">
                            ${confirmedUsers.length === 0 ? `
                                <p class="text-white/40 text-center py-8">Nenhum time confirmado ainda</p>
                            ` : `
                                <div class="space-y-2">
                                    ${confirmedUsers.map(u => `
                                        <button onclick="viewUserTeam('${u.nick}')" 
                                            class="w-full bg-white/5 hover:bg-white/10 rounded-lg p-4 transition flex items-center gap-4 text-left">
                                            ${u.teamLogo ? 
                                                `<img src="${u.teamLogo}" class="w-12 h-12 rounded-lg object-cover">` :
                                                `<div class="w-12 h-12 rounded-lg bg-white/10 flex items-center justify-center text-white/30 font-medium">${(u.teamName || 'T')[0]}</div>`
                                            }
                                            <div class="flex-1 min-w-0">
                                                <p class="text-white font-medium">${u.teamName}</p>
                                                <p class="text-white/40 text-sm">@${u.nick}</p>
                                            </div>
                                            <svg class="w-5 h-5 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </button>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderViewTeamModal() {
            const user = state.users[state.viewingUser];
            if (!user) return '';
            
            // Posi√ß√µes padr√£o 4-3-3 para visualiza√ß√£o
            const viewPositions = [
                { top: '8%', left: '50%' },
                { top: '28%', left: '15%' },
                { top: '28%', left: '38%' },
                { top: '28%', left: '62%' },
                { top: '28%', left: '85%' },
                { top: '52%', left: '25%' },
                { top: '52%', left: '50%' },
                { top: '52%', left: '75%' },
                { top: '76%', left: '20%' },
                { top: '76%', left: '50%' },
                { top: '76%', left: '80%' },
            ];

            return `
                <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-white/5 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                ${user.teamLogo ? 
                                    `<img src="${user.teamLogo}" class="w-10 h-10 rounded-lg object-cover">` :
                                    `<div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center text-white/30 font-medium">${(user.teamName || 'T')[0]}</div>`
                                }
                                <div>
                                    <h3 class="font-display text-xl text-white tracking-wider">${user.teamName}</h3>
                                    <p class="text-white/40 text-xs">@${state.viewingUser}</p>
                                </div>
                            </div>
                            <button onclick="state.modal='teams';state.viewingUser=null;render()" class="text-white/40 hover:text-white p-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="p-4 overflow-y-auto" style="max-height: calc(90vh - 100px);">
                            <!-- Campo -->
                            <div class="campo-bg rounded-xl relative mb-4" style="min-height: 350px;">
                                <!-- Linhas do campo -->
                                <div class="campo-linhas"></div>
                                <div class="area-gol-topo"></div>
                                <div class="pequena-area-topo"></div>
                                <div class="meia-lua-topo"></div>
                                <div class="area-ataque"></div>
                                <div class="pequena-area-baixo"></div>
                                <div class="meia-lua-baixo"></div>
                                <div class="ponto-central"></div>
                                
                                ${viewPositions.map((pos, i) => `
                                    <div class="absolute transform -translate-x-1/2 -translate-y-1/2"
                                        style="top: ${pos.top}; left: ${pos.left};">
                                        ${user.starters && user.starters[i] ? `
                                            <div class="text-center">
                                                <img src="${user.starters[i].photo}" 
                                                    class="w-12 h-12 rounded-full border-2 border-white/60 object-cover mx-auto"
                                                    onerror="this.src='https://via.placeholder.com/48/1a1a1a/ffffff?text=${user.starters[i].name.charAt(0)}'">
                                                <p class="text-white text-xs mt-1 bg-black/70 rounded px-1.5 py-0.5">
                                                    ${user.starters[i].name.split(' ').pop()}
                                                </p>
                                            </div>
                                        ` : `
                                            <div class="w-12 h-12 rounded-full border-2 border-dashed border-white/20 bg-black/20"></div>
                                        `}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- T√©cnico -->
                            ${user.coach ? `
                                <div class="bg-white/5 rounded-lg p-3 mb-4 flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center text-sm font-bold text-white">
                                        ${user.coach.name.split(' ').map(n => n[0]).join('').slice(0,2)}
                                    </div>
                                    <div>
                                        <p class="text-white/40 text-xs">T√©cnico</p>
                                        <p class="text-white text-sm font-medium">${user.coach.name}</p>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Reservas -->
                            <div class="bg-white/5 rounded-lg p-3">
                                <p class="text-white/40 text-xs mb-3">Reservas</p>
                                <div class="space-y-2 text-xs">
                                    <div class="flex items-center gap-2">
                                        <span class="text-zinc-500 w-8">GOL</span>
                                        ${user.reserves && user.reserves[0] ? `
                                            <div class="flex items-center gap-2 bg-white/5 rounded px-2 py-1">
                                                <img src="${user.reserves[0].photo}" class="w-5 h-5 rounded object-cover">
                                                <span class="text-white">${user.reserves[0].name.split(' ').pop()}</span>
                                            </div>
                                        ` : '<span class="text-zinc-600">-</span>'}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-zinc-500 w-8">DEF</span>
                                        ${[1,2].map(i => user.reserves && user.reserves[i] ? `
                                            <div class="flex items-center gap-1 bg-white/5 rounded px-2 py-1">
                                                <img src="${user.reserves[i].photo}" class="w-5 h-5 rounded object-cover">
                                                <span class="text-white">${user.reserves[i].name.split(' ').pop()}</span>
                                            </div>
                                        ` : '').join('')}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-zinc-500 w-8">MEI</span>
                                        ${[3,4].map(i => user.reserves && user.reserves[i] ? `
                                            <div class="flex items-center gap-1 bg-white/5 rounded px-2 py-1">
                                                <img src="${user.reserves[i].photo}" class="w-5 h-5 rounded object-cover">
                                                <span class="text-white">${user.reserves[i].name.split(' ').pop()}</span>
                                            </div>
                                        ` : '').join('')}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-zinc-500 w-8">ATA</span>
                                        ${[5,6].map(i => user.reserves && user.reserves[i] ? `
                                            <div class="flex items-center gap-1 bg-white/5 rounded px-2 py-1">
                                                <img src="${user.reserves[i].photo}" class="w-5 h-5 rounded object-cover">
                                                <span class="text-white">${user.reserves[i].name.split(' ').pop()}</span>
                                            </div>
                                        ` : '').join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSubstitutionModal() {
            const starterSel = state.selectedForSubstitution?.type === 'starter' ? state.selectedForSubstitution.index : null;
            const reserveSel = state.selectedForSubstitution?.type === 'reserve' ? state.selectedForSubstitution.index : null;
            const secondStarterSel = state.secondSelection?.type === 'starter' ? state.secondSelection.index : null;
            const secondReserveSel = state.secondSelection?.type === 'reserve' ? state.secondSelection.index : null;
            
            // Jogadores selecionados para preview
            const selectedStarter = (starterSel !== null) ? state.starters[starterSel] : 
                                   (secondStarterSel !== null) ? state.starters[secondStarterSel] : null;
            const selectedReserve = (reserveSel !== null) ? state.reserves[reserveSel] : 
                                   (secondReserveSel !== null) ? state.reserves[secondReserveSel] : null;
            
            return `
                <div class="fixed inset-0 bg-black/95 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
                    <div class="card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-white/5 flex justify-between items-center sticky top-0 bg-[#141416] z-10">
                            <h3 class="font-display text-2xl text-white tracking-wider">SUBSTITUI√á√ÉO</h3>
                            <button onclick="closeModalDirect()" class="text-white/40 hover:text-white p-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        
                        <!-- Preview da Troca no CENTRO -->
                        <div class="p-6 bg-zinc-900/50">
                            <div class="flex items-center justify-center gap-4">
                                <!-- Titular selecionado -->
                                <div class="text-center flex-1">
                                    <p class="text-red-400 text-xs uppercase tracking-wider mb-2">SAI</p>
                                    ${selectedStarter ? `
                                        <div class="bg-red-500/20 border-2 border-red-500 rounded-xl p-4 inline-block">
                                            <img src="${selectedStarter.photo}" class="w-16 h-16 rounded-full object-cover mx-auto mb-2 border-2 border-red-500"
                                                onerror="this.src='https://via.placeholder.com/64/1a1a1a/ffffff?text=${selectedStarter.name.charAt(0)}'">
                                            <p class="text-white font-medium">${selectedStarter.name.split(' ').pop()}</p>
                                            <p class="text-red-400 text-xs">${selectedStarter.position}</p>
                                        </div>
                                    ` : `
                                        <div class="bg-zinc-800/50 border-2 border-dashed border-zinc-600 rounded-xl p-4 inline-block">
                                            <div class="w-16 h-16 rounded-full bg-zinc-700 mx-auto mb-2 flex items-center justify-center">
                                                <span class="text-zinc-500 text-2xl">?</span>
                                            </div>
                                            <p class="text-zinc-500">Selecione titular</p>
                                        </div>
                                    `}
                                </div>
                                
                                <!-- Seta Central -->
                                <div class="flex flex-col items-center gap-2">
                                    <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                    </svg>
                                </div>
                                
                                <!-- Reserva selecionado -->
                                <div class="text-center flex-1">
                                    <p class="text-green-400 text-xs uppercase tracking-wider mb-2">ENTRA</p>
                                    ${selectedReserve ? `
                                        <div class="bg-green-500/20 border-2 border-green-500 rounded-xl p-4 inline-block">
                                            <img src="${selectedReserve.photo}" class="w-16 h-16 rounded-full object-cover mx-auto mb-2 border-2 border-green-500"
                                                onerror="this.src='https://via.placeholder.com/64/1a1a1a/ffffff?text=${selectedReserve.name.charAt(0)}'">
                                            <p class="text-white font-medium">${selectedReserve.name.split(' ').pop()}</p>
                                            <p class="text-green-400 text-xs">${selectedReserve.position}</p>
                                        </div>
                                    ` : `
                                        <div class="bg-zinc-800/50 border-2 border-dashed border-zinc-600 rounded-xl p-4 inline-block">
                                            <div class="w-16 h-16 rounded-full bg-zinc-700 mx-auto mb-2 flex items-center justify-center">
                                                <span class="text-zinc-500 text-2xl">?</span>
                                            </div>
                                            <p class="text-zinc-500">Selecione reserva</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <!-- BOT√ÉO GRANDE DE CONFIRMAR -->
                            <button onclick="confirmSubstitution()" 
                                class="w-full mt-6 py-4 text-lg font-bold rounded-xl transition ${
                                    state.substitutionMode 
                                    ? 'bg-green-500 hover:bg-green-400 text-white shadow-lg shadow-green-500/30' 
                                    : 'bg-zinc-700 text-zinc-400 cursor-not-allowed'
                                }"
                                ${!state.substitutionMode ? 'disabled' : ''}>
                                ${state.substitutionMode ? '‚úì CONFIRMAR TROCA' : 'Selecione um titular e um reserva'}
                            </button>
                        </div>
                        
                        <div class="p-4">
                            <!-- Titulares -->
                            <div class="mb-6">
                                <p class="text-white text-sm font-medium mb-3 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                    TITULARES - Clique para selecionar quem SAI
                                </p>
                                <div class="grid grid-cols-4 sm:grid-cols-6 gap-2">
                                    ${state.starters.map((p, i) => p ? `
                                        <div onclick="selectForSubstitution('starter', ${i})" 
                                            draggable="true"
                                            ondragstart="handleDragStart(event, 'starter', ${i})"
                                            ondragover="handleDragOver(event)"
                                            ondrop="handleDrop(event, 'starter', ${i})"
                                            class="cursor-pointer p-2 rounded-xl transition text-center ${
                                                starterSel === i || secondStarterSel === i
                                                ? 'bg-red-500/30 border-2 border-red-500 scale-105' 
                                                : 'bg-zinc-800/50 border-2 border-transparent hover:border-zinc-600 hover:bg-zinc-700/50'}">
                                            <img src="${p.photo}" class="w-12 h-12 mx-auto rounded-full object-cover mb-1"
                                                onerror="this.src='https://via.placeholder.com/48/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                            <p class="text-white text-xs font-medium truncate">${p.name.split(' ').pop()}</p>
                                            <p class="text-zinc-500 text-xs">${p.position}</p>
                                        </div>
                                    ` : '').join('')}
                                </div>
                            </div>
                            
                            <!-- Reservas -->
                            <div>
                                <p class="text-white text-sm font-medium mb-3 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                    RESERVAS - Clique para selecionar quem ENTRA
                                </p>
                                <div class="grid grid-cols-4 sm:grid-cols-7 gap-2">
                                    ${state.reserves.map((p, i) => p ? `
                                        <div onclick="selectForSubstitution('reserve', ${i})" 
                                            draggable="true"
                                            ondragstart="handleDragStart(event, 'reserve', ${i})"
                                            ondragover="handleDragOver(event)"
                                            ondrop="handleDrop(event, 'reserve', ${i})"
                                            class="cursor-pointer p-2 rounded-xl transition text-center ${
                                                reserveSel === i || secondReserveSel === i
                                                ? 'bg-green-500/30 border-2 border-green-500 scale-105' 
                                                : 'bg-zinc-800/50 border-2 border-transparent hover:border-zinc-600 hover:bg-zinc-700/50'}">
                                            <img src="${p.photo}" class="w-10 h-10 mx-auto rounded-full object-cover mb-1"
                                                onerror="this.src='https://via.placeholder.com/40/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                            <p class="text-white text-xs font-medium truncate">${p.name.split(' ').pop()}</p>
                                            <p class="text-zinc-500 text-xs">${p.position}</p>
                                        </div>
                                    ` : `
                                        <div class="p-2 rounded-xl bg-zinc-800/30 border-2 border-dashed border-zinc-700 text-center opacity-50">
                                            <div class="w-10 h-10 mx-auto rounded-full bg-zinc-700 mb-1"></div>
                                            <p class="text-zinc-600 text-xs">Vazio</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Dica -->
                            <p class="text-zinc-500 text-xs text-center mt-4">
                                üí° Dica: Voc√™ pode arrastar um jogador e soltar sobre outro para trocar!
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRanking() {
            const rankings = Object.entries(state.users)
                .filter(([_, u]) => u.isConfirmed)
                .map(([nick, u]) => ({
                    nick,
                    team: u.teamName,
                    logo: u.teamLogo,
                    favoriteTeam: u.favoriteTeam,
                    score: calculateUserScore(u)
                }))
                .sort((a, b) => b.score - a.score);

            return `
                <div class="min-h-screen bg-[#09090b]">
                    <!-- Header -->
                    <nav class="border-b border-white/5 bg-[#0f0f10]">
                        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                            <h1 class="font-display text-2xl text-white tracking-wider">FANTASY</h1>
                            <button onclick="state.screen='lineup';render()" class="px-4 py-2 btn-secondary text-white/70 rounded-lg text-sm">
                                Voltar
                            </button>
                        </div>
                    </nav>

                    <div class="max-w-5xl mx-auto p-4">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Coluna do Ranking -->
                            <div>
                                <div class="mb-4">
                                    <h2 class="font-display text-2xl text-white tracking-wider">RANKING</h2>
                                    <p class="text-white/40 text-sm">${rankings.length} times confirmados</p>
                                </div>

                                ${rankings.length === 0 ? `
                                    <div class="card rounded-xl p-8 text-center">
                                        <p class="text-white/40">Nenhum time confirmado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                                        ${rankings.map((r, i) => `
                                            <div onclick="viewProfile('${r.nick}')" class="card rounded-xl p-3 flex items-center gap-3 cursor-pointer hover:bg-zinc-800/50 transition ${r.nick === state.currentUser ? 'border border-green-500/30' : ''}">
                                                <div class="w-8 h-8 flex items-center justify-center rounded-lg ${i === 0 ? 'bg-yellow-500/10 text-yellow-500' : i === 1 ? 'bg-white/5 text-white/60' : i === 2 ? 'bg-orange-500/10 text-orange-500' : 'bg-white/5 text-white/30'} font-bold text-sm">
                                                    ${i + 1}
                                                </div>
                                                ${r.logo ? 
                                                    `<img src="${r.logo}" class="w-10 h-10 rounded-full object-cover border-2 border-green-500/50">` :
                                                    `<div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-white/30 font-medium">${(r.nick || 'U')[0].toUpperCase()}</div>`
                                                }
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-center gap-2">
                                                        <p class="text-white font-medium truncate text-sm">${r.team}</p>
                                                        ${r.favoriteTeam && getTeamLogo(r.favoriteTeam) ? 
                                                            `<img src="${getTeamLogo(r.favoriteTeam)}" class="w-4 h-4 object-contain" title="Torce para ${r.favoriteTeam}">` : 
                                                            ''
                                                        }
                                                    </div>
                                                    <p class="text-white/40 text-xs">@${r.nick}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-xl font-bold text-white">${r.score}</p>
                                                    <p class="text-white/40 text-xs">pts</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <!-- Coluna do Chat -->
                            <div class="card rounded-xl overflow-hidden flex flex-col" style="height: 70vh;">
                                <div class="p-4 border-b border-zinc-800 flex items-center gap-2">
                                    <span class="text-lg">üí¨</span>
                                    <h3 class="font-display text-lg text-white">CHAT</h3>
                                </div>
                                
                                <!-- Mensagens -->
                                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
                                    ${state.chatMessages.length === 0 ? 
                                        `<p class="text-zinc-600 text-center text-sm py-8">Nenhuma mensagem ainda. Comece a zoeira! üî•</p>` :
                                        state.chatMessages.map(m => {
                                            const isMe = m.user === state.currentUser;
                                            const time = new Date(m.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                            
                                            return `
                                                <div class="flex gap-2 ${isMe ? 'flex-row-reverse' : ''}">
                                                    ${m.teamLogo ? 
                                                        `<img src="${m.teamLogo}" onclick="event.stopPropagation();viewProfile('${m.user}')" class="w-8 h-8 rounded-full object-cover flex-shrink-0 cursor-pointer hover:ring-2 hover:ring-green-500 transition">` :
                                                        `<div onclick="event.stopPropagation();viewProfile('${m.user}')" class="w-8 h-8 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-400 text-xs font-bold flex-shrink-0 cursor-pointer hover:ring-2 hover:ring-green-500 transition">${(m.user || 'U')[0].toUpperCase()}</div>`
                                                    }
                                                    <div class="${isMe ? 'bg-green-500/20 border-green-500/30' : 'bg-zinc-800/80'} rounded-xl px-3 py-2 max-w-[75%] border border-transparent">
                                                        <div class="flex items-center gap-2 mb-0.5">
                                                            <span onclick="event.stopPropagation();viewProfile('${m.user}')" class="text-xs font-medium ${isMe ? 'text-green-400' : 'text-zinc-400'} hover:underline cursor-pointer">@${m.user}</span>
                                                            <span class="text-zinc-600 text-xs">${time}</span>
                                                        </div>
                                                        <p class="text-white text-sm break-words">${escapeHtml(m.text)}</p>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')
                                    }
                                </div>
                                
                                <!-- Input -->
                                <div class="p-3 border-t border-zinc-800">
                                    <!-- Seletor de Escudos -->
                                    <div id="teamEmojiPicker" class="hidden mb-2 p-2 bg-zinc-800/80 rounded-xl">
                                        <p class="text-zinc-500 text-xs mb-2">Escudos dos Times:</p>
                                        <div class="flex flex-wrap gap-1">
                                            ${getTeamEmojis().map(t => `
                                                <button onclick="insertTeamEmoji('${t.name}', '${t.logo}')" 
                                                    class="w-8 h-8 rounded-lg hover:bg-zinc-700 transition flex items-center justify-center" 
                                                    title="${t.name}">
                                                    <img src="${t.logo}" class="w-6 h-6 object-contain">
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="toggleEmojiPicker()" 
                                            class="px-3 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl transition" title="Escudos">
                                            ‚öΩ
                                        </button>
                                        <input type="text" id="chatInput" 
                                            placeholder="Manda a zoeira..." 
                                            class="flex-1 px-4 py-2.5 input-dark rounded-xl text-white text-sm"
                                            onkeypress="if(event.key === 'Enter') sendMessage()"
                                            maxlength="200">
                                        <button onclick="sendMessage()" 
                                            class="px-4 py-2.5 bg-green-500 hover:bg-green-400 text-white rounded-xl transition flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== DRAFT SYSTEM (USER) ====================
        
        // Renderizar lista de participantes ou picks do usu√°rio selecionado
        function renderDraftParticipants() {
            if (!state.viewingDraftUser) {
                // Lista de participantes
                const participants = Object.entries(state.users)
                    .filter(([nick, _]) => nick !== 'admin' && nick !== state.currentUser)
                    .map(([nick, data]) => {
                        const userPicks = (state.draftPicks || []).filter(p => p.userName === nick);
                        return {
                            nick,
                            teamName: data.teamName || nick,
                            teamLogo: data.teamLogo,
                            picksCount: userPicks.length
                        };
                    });
                
                const myPicks = (state.draftPicks || []).filter(p => p.userName === state.currentUser);
                
                if (participants.length === 0 && myPicks.length === 0) {
                    return '<div class="text-center py-6 px-4"><p class="text-zinc-500 text-sm">Aguardando participantes...</p></div>';
                }
                
                let html = '';
                
                // Meu time primeiro
                const myInitial = (state.currentUser || 'U')[0].toUpperCase();
                html += '<button onclick="state.viewingDraftUser=\'' + state.currentUser + '\';render()" class="w-full p-3 border-b border-zinc-800 text-left hover:bg-green-500/10 transition flex items-center gap-3 bg-green-500/5">';
                html += '<div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white font-bold">' + myInitial + '</div>';
                html += '<div class="flex-1 min-w-0">';
                html += '<p class="text-green-400 font-medium truncate">' + (state.teamName || 'Meu Time') + '</p>';
                html += '<p class="text-zinc-500 text-xs">@' + state.currentUser + ' (voc√™)</p>';
                html += '</div>';
                html += '<div class="text-right">';
                html += '<p class="text-green-400 font-bold">' + myPicks.length + '</p>';
                html += '<p class="text-zinc-600 text-xs">picks</p>';
                html += '</div>';
                html += '<svg class="w-4 h-4 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
                html += '</button>';
                
                // Outros participantes
                participants.forEach(p => {
                    html += '<button onclick="state.viewingDraftUser=\'' + p.nick + '\';render()" class="w-full p-3 border-b border-zinc-800/50 text-left hover:bg-zinc-800/50 transition flex items-center gap-3">';
                    if (p.teamLogo) {
                        html += '<img src="' + p.teamLogo + '" class="w-10 h-10 rounded-full object-cover">';
                    } else {
                        html += '<div class="w-10 h-10 rounded-full bg-zinc-700 flex items-center justify-center text-white font-bold">' + p.nick[0].toUpperCase() + '</div>';
                    }
                    html += '<div class="flex-1 min-w-0">';
                    html += '<p class="text-white font-medium truncate">' + p.teamName + '</p>';
                    html += '<p class="text-zinc-500 text-xs">@' + p.nick + '</p>';
                    html += '</div>';
                    html += '<div class="text-right">';
                    html += '<p class="text-purple-400 font-bold">' + p.picksCount + '</p>';
                    html += '<p class="text-zinc-600 text-xs">picks</p>';
                    html += '</div>';
                    html += '<svg class="w-4 h-4 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
                    html += '</button>';
                });
                
                return html;
            } else {
                // Picks do usu√°rio selecionado
                const userPicks = (state.draftPicks || []).filter(p => p.userName === state.viewingDraftUser);
                const userData = state.users[state.viewingDraftUser] || {};
                const isMe = state.viewingDraftUser === state.currentUser;
                
                let html = '';
                html += '<div class="p-3 ' + (isMe ? 'bg-green-500/10' : 'bg-purple-500/10') + ' border-b border-zinc-800">';
                html += '<p class="' + (isMe ? 'text-green-400' : 'text-purple-400') + ' font-medium">' + (userData.teamName || state.viewingDraftUser) + '</p>';
                html += '<p class="text-zinc-500 text-xs">@' + state.viewingDraftUser + ' - ' + userPicks.length + ' picks</p>';
                html += '</div>';
                
                if (userPicks.length === 0) {
                    html += '<div class="text-center py-6"><p class="text-zinc-500 text-sm">Nenhum pick ainda</p></div>';
                } else {
                    userPicks.forEach(pick => {
                        const posColor = pick.player.position === 'TEC' ? 'bg-orange-500' :
                                        pick.player.position === 'GOL' ? 'bg-yellow-500' :
                                        pick.player.position === 'DEF' ? 'bg-blue-500' :
                                        pick.player.position === 'MEI' ? 'bg-green-500' : 'bg-red-500';
                        const pickBg = pick.isCoach ? 'bg-orange-500/20 text-orange-400' : 'bg-purple-500/20 text-purple-400';
                        html += '<div class="p-2 border-b border-zinc-800/30 flex items-center gap-2">';
                        html += '<span class="w-6 h-6 ' + pickBg + ' rounded text-xs font-bold flex items-center justify-center">#' + pick.number + '</span>';
                        if (pick.isCoach) {
                            const initials = pick.player.name.split(' ').map(n => n[0]).join('').slice(0,2);
                            html += '<div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-400 font-bold text-xs">' + initials + '</div>';
                        } else {
                            html += '<img src="' + pick.player.photo + '" class="w-8 h-8 rounded-full object-cover" onerror="this.src=\'https://via.placeholder.com/32\'">';
                        }
                        html += '<div class="flex-1 min-w-0">';
                        html += '<p class="text-white text-sm truncate">' + (pick.isCoach ? 'üëî ' : '') + pick.player.name + '</p>';
                        html += '<p class="text-zinc-500 text-xs">' + pick.player.team + '</p>';
                        html += '</div>';
                        html += '<span class="w-3 h-3 rounded-full ' + posColor + '"></span>';
                        html += '</div>';
                    });
                }
                
                return html;
            }
        }
        
        function renderUserDraft() {
            // Garantir que s√£o arrays
            const safeStarters = ensureArray(state.starters, 11);
            const safeReserves = ensureArray(state.reserves, 7);
            const totalPlayers = safeStarters.filter(p => p).length + safeReserves.filter(p => p).length;
            const isTeamComplete = totalPlayers === 18 && !!state.coach;
            
            return `
                <div class="min-h-screen bg-[#09090b]">
                    <!-- Header -->
                    <nav class="border-b border-purple-500/20 bg-purple-500/5">
                        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <h1 class="font-display text-2xl text-white tracking-wider">FANTASY</h1>
                                <span class="px-3 py-1 bg-purple-500/20 text-purple-400 text-xs font-bold rounded-full">üéØ DRAFT</span>
                            </div>
                            <button onclick="state.screen='lineup';render()" class="px-4 py-2 btn-secondary text-white/70 rounded-lg text-sm flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                Voltar
                            </button>
                        </div>
                    </nav>

                    <div class="max-w-5xl mx-auto p-4">
                        <!-- Aviso Principal -->
                        <div class="card rounded-2xl p-8 mb-6 border-2 ${state.draftStarted ? 'border-green-500/30 bg-gradient-to-br from-green-500/10' : 'border-purple-500/30 bg-gradient-to-br from-purple-500/10'} to-transparent text-center">
                            
                            ${state.draftStarted ? `
                                <div class="flex items-center justify-center gap-2 mb-4">
                                    <span class="w-4 h-4 bg-red-500 rounded-full animate-pulse"></span>
                                    <span class="text-red-400 font-bold text-lg">AO VIVO</span>
                                </div>
                            ` : `
                                <div class="text-6xl mb-4">üéØ</div>
                            `}
                            
                            <h2 class="font-display text-3xl text-white mb-2">SALA DO DRAFT</h2>
                            
                            ${isTeamComplete ? `
                                <div class="inline-flex items-center gap-2 px-4 py-2 bg-green-500/20 text-green-400 rounded-full text-sm font-medium mb-4">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Seu time est√° completo!
                                </div>
                                <p class="text-zinc-400 text-sm">Aguarde a confirma√ß√£o do administrador para encerrar o Draft.</p>
                            ` : state.draftStarted ? `
                                <div class="inline-flex items-center gap-2 px-4 py-2 bg-green-500/20 text-green-400 rounded-full text-sm font-medium mb-4 animate-pulse">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    Draft em andamento!
                                </div>
                                <p class="text-zinc-400 text-sm mb-2">O administrador est√° montando os times ao vivo!</p>
                                <p class="text-green-400 text-xs font-medium">üî• Acompanhe pelo chat e veja as escolhas!</p>
                            ` : `
                                <div class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-500/20 text-yellow-400 rounded-full text-sm font-medium mb-4 animate-pulse">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Aguardando in√≠cio do Draft...
                                </div>
                                <p class="text-zinc-400 text-sm mb-2">O administrador ir√° montar seu time durante a transmiss√£o.</p>
                                <p class="text-zinc-500 text-xs">Fique atento ao chat e acompanhe pelo Discord!</p>
                            `}
                            
                            <!-- Status do Time -->
                            <div class="mt-6 flex items-center justify-center gap-6">
                                <div class="text-center">
                                    <p class="text-3xl font-bold ${totalPlayers === 18 ? 'text-green-400' : 'text-white'}">${totalPlayers}/18</p>
                                    <p class="text-zinc-500 text-xs">Jogadores</p>
                                </div>
                                <div class="w-px h-12 bg-zinc-700"></div>
                                <div class="text-center">
                                    <p class="text-3xl font-bold ${state.coach ? 'text-green-400' : 'text-zinc-600'}">${state.coach ? '‚úì' : '‚Äî'}</p>
                                    <p class="text-zinc-500 text-xs">T√©cnico</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Chat do Draft -->
                            <div class="card rounded-xl overflow-hidden flex flex-col" style="height: 450px;">
                                <div class="p-4 border-b border-purple-500/20 bg-purple-500/10 flex items-center gap-3">
                                    <span class="text-2xl">üí¨</span>
                                    <div>
                                        <h3 class="font-bold text-white">Chat do Draft</h3>
                                        <p class="text-purple-400 text-xs">Converse com os outros participantes</p>
                                    </div>
                                </div>
                                
                                <!-- Mensagens -->
                                <div id="userDraftChatFull" class="flex-1 overflow-y-auto p-4 space-y-3">
                                    ${(state.draftChatMessages || []).length === 0 ? 
                                        `<div class="text-center py-8">
                                            <p class="text-zinc-600 text-4xl mb-2">üí¨</p>
                                            <p class="text-zinc-500 text-sm">Nenhuma mensagem ainda</p>
                                            <p class="text-zinc-600 text-xs">Seja o primeiro a mandar um salve!</p>
                                        </div>` :
                                        (state.draftChatMessages || []).map(m => {
                                            const time = new Date(m.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                            const isAdmin = m.user === 'admin';
                                            const isMe = m.user === state.currentUser;
                                            return `
                                                <div class="flex gap-3 ${isMe ? 'flex-row-reverse' : ''}">
                                                    <div class="w-8 h-8 rounded-full ${isAdmin ? 'bg-red-500' : isMe ? 'bg-green-500' : 'bg-zinc-700'} flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                                                        ${isAdmin ? 'üëë' : (m.user || 'U')[0].toUpperCase()}
                                                    </div>
                                                    <div class="flex-1 min-w-0 ${isMe ? 'text-right' : ''}">
                                                        <div class="flex items-center gap-2 mb-1 ${isMe ? 'justify-end' : ''}">
                                                            <span class="text-xs font-medium ${isAdmin ? 'text-red-400' : isMe ? 'text-green-400' : 'text-zinc-400'}">
                                                                ${isAdmin ? 'üëë ADMIN' : '@' + m.user}
                                                            </span>
                                                            <span class="text-zinc-600 text-xs">${time}</span>
                                                        </div>
                                                        <div class="inline-block ${isMe ? 'bg-green-500/20 border-green-500/30' : isAdmin ? 'bg-red-500/10 border-red-500/20' : 'bg-zinc-800'} rounded-xl px-3 py-2 border border-transparent max-w-[85%]">
                                                            <p class="text-white text-sm break-words text-left">${escapeHtml(m.text)}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')
                                    }
                                </div>
                                
                                <!-- Input -->
                                <div class="p-3 border-t border-zinc-800 bg-zinc-900/50">
                                    <div class="flex gap-2">
                                        <input type="text" id="userDraftChatInputFull" 
                                            placeholder="Digite sua mensagem..." 
                                            class="flex-1 px-4 py-2.5 input-dark rounded-xl text-white text-sm"
                                            onkeypress="if(event.key === 'Enter') sendUserDraftMessageFull()"
                                            maxlength="200">
                                        <button onclick="sendUserDraftMessageFull()" 
                                            class="px-5 py-2.5 bg-purple-500 hover:bg-purple-400 text-white rounded-xl text-sm font-medium transition">
                                            Enviar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Info e Dicas -->
                            <div class="space-y-4">
                                <!-- Participantes e Picks -->
                                <div class="card rounded-xl overflow-hidden">
                                    <div class="p-4 border-b border-yellow-500/20 bg-yellow-500/10 flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">üë•</span>
                                            <div>
                                                <h3 class="font-bold text-white">Participantes</h3>
                                                <p class="text-yellow-400 text-xs">${(state.draftPicks || []).length} picks realizados</p>
                                            </div>
                                        </div>
                                        ${state.viewingDraftUser ? `
                                            <button onclick="state.viewingDraftUser=null;render()" class="px-3 py-1 bg-zinc-700 hover:bg-zinc-600 text-white text-xs rounded-lg transition">
                                                ‚Üê Voltar
                                            </button>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="max-h-72 overflow-y-auto">
                                        ${renderDraftParticipants()}
                                    </div>
                                </div>
                                
                                <!-- Como funciona -->
                                <div class="card rounded-xl p-5">
                                    <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                                        <span class="text-xl">üìã</span> Como funciona o Draft
                                    </h3>
                                    <div class="space-y-3 text-sm">
                                        <div class="flex gap-3">
                                            <span class="w-6 h-6 bg-purple-500/20 text-purple-400 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">1</span>
                                            <p class="text-zinc-400">O admin sorteia a ordem dos picks</p>
                                        </div>
                                        <div class="flex gap-3">
                                            <span class="w-6 h-6 bg-purple-500/20 text-purple-400 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">2</span>
                                            <p class="text-zinc-400">Na sua vez, escolha o jogador que deseja</p>
                                        </div>
                                        <div class="flex gap-3">
                                            <span class="w-6 h-6 bg-purple-500/20 text-purple-400 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">3</span>
                                            <p class="text-zinc-400">O admin adiciona o jogador no seu time</p>
                                        </div>
                                        <div class="flex gap-3">
                                            <span class="w-6 h-6 bg-purple-500/20 text-purple-400 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">4</span>
                                            <p class="text-zinc-400">Snake Draft: depois do √∫ltimo, volta do fim!</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Seu Time Atual -->
                                <div class="card rounded-xl p-5">
                                    <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                                        <span class="text-xl">‚öΩ</span> Seu Time Atual
                                    </h3>
                                    
                                    ${totalPlayers === 0 ? `
                                        <div class="text-center py-4">
                                            <p class="text-zinc-500 text-sm">Nenhum jogador ainda</p>
                                            <p class="text-zinc-600 text-xs">Aguarde o in√≠cio do Draft</p>
                                        </div>
                                    ` : `
                                        <div class="space-y-2 max-h-48 overflow-y-auto">
                                            ${safeStarters.filter(p => p).map(p => `
                                                <div class="flex items-center gap-2 bg-zinc-800/50 rounded-lg p-2">
                                                    <img src="${p.photo}" class="w-8 h-8 rounded-full object-cover" onerror="this.src='https://via.placeholder.com/32'">
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-white text-sm truncate">${p.name}</p>
                                                        <p class="text-zinc-500 text-xs">${p.team}</p>
                                                    </div>
                                                    <span class="text-xs px-2 py-0.5 bg-green-500/20 text-green-400 rounded">Titular</span>
                                                </div>
                                            `).join('')}
                                            ${safeReserves.filter(p => p).map(p => `
                                                <div class="flex items-center gap-2 bg-zinc-800/50 rounded-lg p-2">
                                                    <img src="${p.photo}" class="w-8 h-8 rounded-full object-cover" onerror="this.src='https://via.placeholder.com/32'">
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-white text-sm truncate">${p.name}</p>
                                                        <p class="text-zinc-500 text-xs">${p.team}</p>
                                                    </div>
                                                    <span class="text-xs px-2 py-0.5 bg-zinc-700 text-zinc-400 rounded">Reserva</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                                
                                <!-- Bot√£o Ver Escala√ß√£o -->
                                <button onclick="state.screen='lineup';render()" 
                                    class="w-full py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl text-sm font-medium transition flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    Ver Escala√ß√£o Completa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== DRAFT SYSTEM (ADMIN) ====================
        function renderDraft() {
            if (!state.isAdmin) {
                return `<div class="min-h-screen flex items-center justify-center"><p class="text-white">Acesso negado</p></div>`;
            }
            
            // Lista de usu√°rios cadastrados (exceto admin)
            const registeredUsers = Object.entries(state.users)
                .filter(([nick, _]) => nick !== 'admin')
                .map(([nick, data]) => ({
                    nick,
                    teamName: data.teamName || 'Sem time',
                    teamLogo: data.teamLogo,
                    starters: ensureArray(data.starters, 11),
                    reserves: ensureArray(data.reserves, 7),
                    coach: data.coach
                }));
            
            // Jogadores j√° draftados (de todos os usu√°rios)
            const allDraftedPlayerIds = new Set();
            registeredUsers.forEach(u => {
                const starters = ensureArray(u.starters, 11);
                const reserves = ensureArray(u.reserves, 7);
                starters.forEach(p => { if (p) allDraftedPlayerIds.add(p.id); });
                reserves.forEach(p => { if (p) allDraftedPlayerIds.add(p.id); });
            });
            
            // Jogadores dispon√≠veis para draft
            const availablePlayers = state.players.filter(p => !allDraftedPlayerIds.has(p.id));
            
            // Filtrar jogadores
            const filteredPlayers = availablePlayers.filter(p => {
                if (state.draftFilterPos && normalizePosition(p.position) !== state.draftFilterPos) return false;
                if (state.draftFilterTeam && p.team !== state.draftFilterTeam) return false;
                if (state.draftSearch && !p.name.toLowerCase().includes(state.draftSearch.toLowerCase())) return false;
                return true;
            });
            
            // Times √∫nicos
            const teams = [...new Set(state.players.map(p => p.team))].sort();

            return `
                <div class="min-h-screen bg-[#09090b]">
                    <!-- Header Admin -->
                    <nav class="border-b border-white/5 bg-[#0f0f10]">
                        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <h1 class="font-display text-2xl text-white tracking-wider">FANTASY</h1>
                                <span class="px-3 py-1 bg-red-500/20 text-red-400 text-xs font-bold rounded">ADMIN</span>
                            </div>
                            <button onclick="logout()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white rounded-lg text-sm">
                                Sair
                            </button>
                        </div>
                    </nav>

                    <div class="max-w-7xl mx-auto p-4">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                            <h2 class="font-display text-3xl text-white">üéØ DRAFT - MONTE OS TIMES</h2>
                            
                            <!-- Bot√£o Iniciar/Encerrar Draft -->
                            <div class="flex items-center gap-3">
                                ${state.draftStarted ? `
                                    <div class="flex items-center gap-2 px-4 py-2 bg-green-500/20 rounded-lg">
                                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                                        <span class="text-green-400 font-medium">AO VIVO</span>
                                    </div>
                                    <button onclick="toggleDraft()" 
                                        class="px-6 py-3 bg-red-500 hover:bg-red-400 text-white rounded-xl font-bold transition flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
                                        ENCERRAR DRAFT
                                    </button>
                                ` : `
                                    <button onclick="toggleDraft()" 
                                        class="px-6 py-3 bg-green-500 hover:bg-green-400 text-white rounded-xl font-bold transition flex items-center gap-2 animate-pulse">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        INICIAR DRAFT
                                    </button>
                                `}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                            <!-- Lista de Participantes -->
                            <div class="lg:col-span-1">
                                <div class="card rounded-xl p-4">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-white font-bold flex items-center gap-2">
                                            <span>üë• PARTICIPANTES</span>
                                            <span class="text-zinc-500 text-sm">(${registeredUsers.length})</span>
                                        </h3>
                                        <button onclick="window.listenToUsers();alert('Lista atualizada!')" class="p-2 text-zinc-400 hover:text-white transition" title="Atualizar lista">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                        </button>
                                    </div>
                                    
                                    <p class="text-zinc-500 text-xs mb-4">Usu√°rios cadastrados aparecem aqui automaticamente</p>
                                    
                                    <div class="space-y-2 max-h-[60vh] overflow-y-auto">
                                        ${registeredUsers.length === 0 ? `
                                            <p class="text-zinc-500 text-sm text-center py-4">Nenhum participante cadastrado ainda</p>
                                            <p class="text-zinc-600 text-xs text-center">Os participantes devem criar conta com o c√≥digo: <span class="text-green-400">season26</span></p>
                                        ` : registeredUsers.map(u => {
                                            const totalPlayers = (u.starters || []).filter(p => p).length + (u.reserves || []).filter(p => p).length;
                                            const isSelected = state.selectedDraftUser === u.nick;
                                            return `
                                                <button onclick="selectDraftUser('${u.nick}')"
                                                    class="w-full p-3 rounded-lg text-left transition ${isSelected ? 'bg-green-500/20 border-2 border-green-500' : 'bg-zinc-800 hover:bg-zinc-700 border border-zinc-700'}">
                                                    <div class="flex items-center gap-3">
                                                        ${u.teamLogo ? 
                                                            `<img src="${u.teamLogo}" class="w-10 h-10 rounded-full object-cover">` :
                                                            `<div class="w-10 h-10 rounded-full bg-zinc-700 flex items-center justify-center text-white font-bold">${u.nick[0].toUpperCase()}</div>`
                                                        }
                                                        <div class="flex-1 min-w-0">
                                                            <p class="text-white font-medium truncate">${u.teamName}</p>
                                                            <p class="text-zinc-500 text-xs">@${u.nick}</p>
                                                        </div>
                                                        <div class="text-right">
                                                            <span class="text-xs px-2 py-1 rounded ${totalPlayers === 18 ? 'bg-green-500/20 text-green-400' : 'bg-zinc-700 text-zinc-400'}">
                                                                ${totalPlayers}/18
                                                            </span>
                                                        </div>
                                                    </div>
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campo do Usu√°rio Selecionado -->
                            <div class="lg:col-span-2">
                                ${state.selectedDraftUser ? renderDraftField() : `
                                    <div class="card rounded-xl p-8 text-center h-full flex items-center justify-center">
                                        <div>
                                            <p class="text-zinc-500 text-lg mb-2">üëà Selecione um participante</p>
                                            <p class="text-zinc-600 text-sm">Clique em um nome na lista para montar o time dele</p>
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- Lista de Jogadores Dispon√≠veis -->
                            <div class="lg:col-span-1">
                                <div class="card rounded-xl p-4 h-full">
                                    <h3 class="text-white font-bold mb-3">‚öΩ DISPON√çVEIS (${availablePlayers.length})</h3>
                                    
                                    <!-- Filtros -->
                                    <div class="space-y-2 mb-3">
                                        <input type="text" placeholder="Buscar jogador..." 
                                            oninput="state.draftSearch=this.value;render()"
                                            value="${state.draftSearch || ''}"
                                            class="w-full px-3 py-2 input-dark rounded-lg text-white text-sm">
                                        
                                        <div class="flex gap-2">
                                            <select onchange="state.draftFilterPos=this.value;render()" 
                                                class="flex-1 px-2 py-1.5 input-dark rounded-lg text-white text-xs">
                                                <option value="">Posi√ß√£o</option>
                                                <option value="GOL" ${state.draftFilterPos === 'GOL' ? 'selected' : ''}>Goleiro</option>
                                                <option value="DEF" ${state.draftFilterPos === 'DEF' ? 'selected' : ''}>Defensor</option>
                                                <option value="MEI" ${state.draftFilterPos === 'MEI' ? 'selected' : ''}>Meia</option>
                                                <option value="ATA" ${state.draftFilterPos === 'ATA' ? 'selected' : ''}>Atacante</option>
                                            </select>
                                            <select onchange="state.draftFilterTeam=this.value;render()" 
                                                class="flex-1 px-2 py-1.5 input-dark rounded-lg text-white text-xs">
                                                <option value="">Time</option>
                                                ${teams.map(t => `<option value="${t}" ${state.draftFilterTeam === t ? 'selected' : ''}>${t}</option>`).join('')}
                                            </select>
                                        </div>
                                        
                                        <!-- Abas Jogadores / T√©cnicos -->
                                        <div class="flex gap-1 mt-2">
                                            <button onclick="state.draftTab='players';render()" 
                                                class="flex-1 py-1.5 text-xs font-medium rounded-lg transition ${(state.draftTab || 'players') === 'players' ? 'bg-green-500 text-white' : 'bg-zinc-800 text-zinc-400 hover:text-white'}">
                                                ‚öΩ Jogadores
                                            </button>
                                            <button onclick="state.draftTab='coaches';render()" 
                                                class="flex-1 py-1.5 text-xs font-medium rounded-lg transition ${state.draftTab === 'coaches' ? 'bg-orange-500 text-white' : 'bg-zinc-800 text-zinc-400 hover:text-white'}">
                                                üëî T√©cnicos
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Lista de jogadores / t√©cnicos -->
                                    <div class="space-y-1 max-h-[60vh] overflow-y-auto pr-1">
                                        ${(state.draftTab || 'players') === 'players' ? `
                                            ${filteredPlayers.slice(0, 100).map(p => {
                                                const posColor = normalizePosition(p.position) === 'GOL' ? 'bg-yellow-500' :
                                                                normalizePosition(p.position) === 'DEF' ? 'bg-blue-500' :
                                                                normalizePosition(p.position) === 'MEI' ? 'bg-green-500' : 'bg-red-500';
                                                return `
                                                    <button onclick="addPlayerToDraftUser(${p.id})"
                                                        ${!state.selectedDraftUser ? 'disabled' : ''}
                                                        class="w-full p-2 rounded-lg text-left transition flex items-center gap-2 ${!state.selectedDraftUser ? 'opacity-50 cursor-not-allowed bg-zinc-800/50' : 'bg-zinc-800 hover:bg-zinc-700 hover:bg-green-500/10'}">
                                                        <img src="${p.photo}" class="w-8 h-8 rounded-full object-cover flex-shrink-0"
                                                            onerror="this.src='https://via.placeholder.com/32/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                                        <div class="flex-1 min-w-0">
                                                            <p class="text-white text-sm truncate">${p.name}</p>
                                                            <p class="text-zinc-500 text-xs truncate">${p.team}</p>
                                                        </div>
                                                        <span class="w-3 h-3 rounded-full ${posColor} flex-shrink-0"></span>
                                                    </button>
                                                `;
                                            }).join('')}
                                            ${filteredPlayers.length > 100 ? `
                                                <p class="text-zinc-500 text-xs text-center py-2">+ ${filteredPlayers.length - 100} jogadores (use os filtros)</p>
                                            ` : ''}
                                            ${filteredPlayers.length === 0 ? `
                                                <p class="text-zinc-500 text-sm text-center py-4">Nenhum jogador encontrado</p>
                                            ` : ''}
                                        ` : renderDraftCoaches(registeredUsers)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat do Draft + Bot√£o Confirmar -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
                            <!-- Chat do Draft -->
                            <div class="card rounded-xl overflow-hidden flex flex-col" style="height: 300px;">
                                <div class="p-3 border-b border-zinc-800 flex items-center gap-2 bg-zinc-800/50">
                                    <span class="text-lg">üí¨</span>
                                    <h3 class="font-bold text-white text-sm">CHAT DO DRAFT</h3>
                                    <span class="text-zinc-500 text-xs ml-auto">${Object.keys(state.users).filter(n => n !== 'admin').length} participantes</span>
                                </div>
                                
                                <!-- Mensagens -->
                                <div id="draftChatMessages" class="flex-1 overflow-y-auto p-3 space-y-2">
                                    ${(state.draftChatMessages || []).length === 0 ? 
                                        `<p class="text-zinc-600 text-center text-xs py-4">Chat do Draft - Converse com os participantes! üéØ</p>` :
                                        (state.draftChatMessages || []).map(m => {
                                            const time = new Date(m.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                            const isAdmin = m.user === 'admin';
                                            return `
                                                <div class="flex gap-2">
                                                    <div class="w-6 h-6 rounded-full ${isAdmin ? 'bg-red-500' : 'bg-zinc-700'} flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                                        ${isAdmin ? 'üëë' : (m.user || 'U')[0].toUpperCase()}
                                                    </div>
                                                    <div class="flex-1 min-w-0">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-xs font-medium ${isAdmin ? 'text-red-400' : 'text-zinc-400'}">@${m.user}</span>
                                                            <span class="text-zinc-600 text-xs">${time}</span>
                                                        </div>
                                                        <p class="text-white text-sm break-words">${escapeHtml(m.text)}</p>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')
                                    }
                                </div>
                                
                                <!-- Input -->
                                <div class="p-2 border-t border-zinc-800 flex gap-2">
                                    <input type="text" id="draftChatInput" 
                                        placeholder="Digite uma mensagem..." 
                                        class="flex-1 px-3 py-2 input-dark rounded-lg text-white text-sm"
                                        onkeypress="if(event.key === 'Enter') sendDraftMessage()"
                                        maxlength="200">
                                    <button onclick="sendDraftMessage()" 
                                        class="px-4 py-2 bg-green-500 hover:bg-green-400 text-white rounded-lg text-sm font-medium transition">
                                        Enviar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- A√ß√µes do Admin -->
                            <div class="card rounded-xl p-4">
                                <h3 class="font-bold text-white mb-4">‚öôÔ∏è A√á√ïES DO ADMIN</h3>
                                
                                <!-- Status dos times -->
                                <div class="mb-4">
                                    <p class="text-zinc-400 text-xs mb-2">Status dos times:</p>
                                    <div class="grid grid-cols-3 gap-2 text-xs">
                                        <div class="bg-zinc-800 rounded-lg p-2 text-center">
                                            <p class="text-2xl font-bold text-green-400">${registeredUsers.filter(u => (u.starters || []).filter(p => p).length + (u.reserves || []).filter(p => p).length === 18).length}</p>
                                            <p class="text-zinc-500">Completos</p>
                                        </div>
                                        <div class="bg-zinc-800 rounded-lg p-2 text-center">
                                            <p class="text-2xl font-bold text-yellow-400">${registeredUsers.filter(u => (u.starters || []).filter(p => p).length + (u.reserves || []).filter(p => p).length < 18).length}</p>
                                            <p class="text-zinc-500">Incompletos</p>
                                        </div>
                                        <div class="bg-zinc-800 rounded-lg p-2 text-center">
                                            <p class="text-2xl font-bold text-purple-400">${(state.draftPicks || []).length}</p>
                                            <p class="text-zinc-500">Picks</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- √öltimos Picks -->
                                ${(state.draftPicks || []).length > 0 ? `
                                    <div class="mb-4">
                                        <p class="text-zinc-400 text-xs mb-2">√öltimos picks:</p>
                                        <div class="space-y-1 max-h-32 overflow-y-auto">
                                            ${(state.draftPicks || []).slice(-5).reverse().map(pick => `
                                                <div class="flex items-center gap-2 bg-zinc-800/50 rounded p-1.5 text-xs">
                                                    <span class="text-purple-400 font-bold">#${pick.number}</span>
                                                    <span class="text-zinc-500">@${pick.userName}</span>
                                                    <span class="text-zinc-600">‚Üí</span>
                                                    <span class="text-white truncate">${pick.player.name}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Bot√£o Confirmar Todas -->
                                <button onclick="confirmAllLineups()" 
                                    class="w-full py-3 bg-green-500 hover:bg-green-400 text-white font-bold rounded-lg text-sm transition flex items-center justify-center gap-2 mb-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    ‚úÖ CONFIRMAR TODAS
                                </button>
                                
                                <!-- Bot√£o Resetar Draft -->
                                <button onclick="resetDraft()" 
                                    class="w-full py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 rounded-lg text-xs transition flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    Resetar Draft
                                </button>
                                
                                <p class="text-zinc-600 text-xs text-center mt-2">Cuidado: resetar apaga todos os picks!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Renderizar lista de t√©cnicos no draft
        function renderDraftCoaches(registeredUsers) {
            // T√©cnicos j√° draftados
            const draftedCoachIds = new Set();
            registeredUsers.forEach(u => {
                if (u.coach) draftedCoachIds.add(u.coach.id);
            });
            
            // T√©cnicos dispon√≠veis
            const availableCoaches = TECNICOS_2026.filter(c => !draftedCoachIds.has(c.id));
            
            let html = '';
            
            if (availableCoaches.length === 0) {
                html = '<p class="text-zinc-500 text-sm text-center py-4">Todos os t√©cnicos foram escolhidos</p>';
            } else {
                availableCoaches.forEach(c => {
                    const disabled = !state.selectedDraftUser;
                    const initials = c.name.split(' ').map(n => n[0]).join('').slice(0,2);
                    html += `
                        <button onclick="addCoachToDraftUser(${c.id})"
                            ${disabled ? 'disabled' : ''}
                            class="w-full p-2 rounded-lg text-left transition flex items-center gap-2 ${disabled ? 'opacity-50 cursor-not-allowed bg-zinc-800/50' : 'bg-zinc-800 hover:bg-zinc-700 hover:bg-orange-500/10'}">
                            <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-400 font-bold text-sm flex-shrink-0 border-2 border-orange-500/50">
                                ${initials}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-white text-sm font-medium truncate">${c.name}</p>
                                <p class="text-zinc-500 text-xs truncate">${c.team}</p>
                            </div>
                            <span class="text-orange-400">${c.country}</span>
                        </button>
                    `;
                });
            }
            
            html += `
                <div class="mt-2 p-2 bg-orange-500/10 rounded-lg border border-orange-500/20">
                    <p class="text-orange-400 text-xs text-center">üëî ${availableCoaches.length} t√©cnicos dispon√≠veis</p>
                </div>
            `;
            
            return html;
        }
        
        function renderDraftField() {
            const user = state.users[state.selectedDraftUser];
            if (!user) return '';
            
            // Garantir que s√£o arrays (Firebase pode retornar objetos)
            const starters = ensureArray(user.starters, 11);
            const reserves = ensureArray(user.reserves, 7);
            
            // Posi√ß√µes mais centralizadas para n√£o cortar nas bordas
            const fieldPositions = [
                { top: '12%', left: '50%' },   // GOL
                { top: '32%', left: '20%' },   // LD
                { top: '32%', left: '40%' },   // ZAG
                { top: '32%', left: '60%' },   // ZAG
                { top: '32%', left: '80%' },   // LE
                { top: '55%', left: '28%' },   // VOL
                { top: '55%', left: '50%' },   // MEI
                { top: '55%', left: '72%' },   // VOL
                { top: '78%', left: '25%' },   // PE
                { top: '78%', left: '50%' },   // ATA
                { top: '78%', left: '75%' },   // PD
            ];
            
            const slotLabels = ['GOL', 'LD', 'ZAG', 'ZAG', 'LE', 'VOL', 'MEI', 'VOL', 'PE', 'ATA', 'PD'];
            const reserveLabels = ['GOL', 'DEF', 'DEF', 'MEI', 'MEI', 'ATA', 'ATA'];
            
            return `
                <div class="card rounded-xl p-4">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            ${user.teamLogo ? 
                                `<img src="${user.teamLogo}" class="w-12 h-12 rounded-full object-cover border-2 border-green-500">` :
                                `<div class="w-12 h-12 rounded-full bg-zinc-700 flex items-center justify-center text-white font-bold text-xl">${state.selectedDraftUser[0].toUpperCase()}</div>`
                            }
                            <div>
                                <h3 class="text-white font-bold">${user.teamName || 'Sem nome'}</h3>
                                <p class="text-zinc-500 text-sm">@${state.selectedDraftUser}</p>
                            </div>
                        </div>
                        <button onclick="state.selectedDraftUser=null;render()" class="text-zinc-500 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <!-- Campo com padding extra -->
                    <div class="campo-bg rounded-xl relative mb-4 p-4" style="min-height: 340px;">
                        <div class="campo-linhas"></div>
                        <div class="area-gol-topo"></div>
                        <div class="pequena-area-topo"></div>
                        <div class="meia-lua-topo"></div>
                        <div class="area-ataque"></div>
                        <div class="pequena-area-baixo"></div>
                        <div class="meia-lua-baixo"></div>
                        <div class="ponto-central"></div>
                        
                        ${fieldPositions.map((pos, i) => `
                            <div class="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer"
                                style="top: ${pos.top}; left: ${pos.left};"
                                onclick="selectDraftSlot('starter', ${i})">
                                ${starters[i] ? `
                                    <div class="text-center relative group">
                                        <img src="${starters[i].photo}" 
                                            class="w-11 h-11 rounded-full border-2 border-white/80 object-cover mx-auto"
                                            onerror="this.src='https://via.placeholder.com/44/1a1a1a/ffffff?text=${starters[i].name.charAt(0)}'">
                                        <p class="text-white text-xs mt-1 bg-black/70 rounded px-1 py-0.5 truncate max-w-[60px]">
                                            ${starters[i].name.split(' ').pop()}
                                        </p>
                                        <button onclick="event.stopPropagation();removePlayerFromDraft('starter', ${i})" 
                                            class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs opacity-0 group-hover:opacity-100 transition">√ó</button>
                                    </div>
                                ` : `
                                    <div class="text-center">
                                        <div class="w-11 h-11 mx-auto rounded-full border-2 border-dashed border-white/30 flex items-center justify-center bg-black/20 hover:bg-black/40 transition ${state.draftSlotType === 'starter' && state.draftSlotIndex === i ? 'border-green-500 bg-green-500/20' : ''}">
                                            <svg class="w-4 h-4 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        </div>
                                        <p class="text-white/50 text-xs mt-1">${slotLabels[i]}</p>
                                    </div>
                                `}
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Reservas -->
                    <div class="bg-zinc-800/50 rounded-lg p-3">
                        <p class="text-zinc-400 text-xs mb-2">RESERVAS (${reserves.filter(r => r).length}/7)</p>
                        <div class="flex flex-wrap gap-2">
                            ${reserves.map((p, i) => `
                                <div class="cursor-pointer relative group" onclick="selectDraftSlot('reserve', ${i})">
                                    ${p ? `
                                        <div class="flex items-center gap-2 bg-zinc-700 rounded-lg p-2">
                                            <img src="${p.photo}" class="w-8 h-8 rounded-full object-cover">
                                            <div>
                                                <p class="text-white text-xs">${p.name.split(' ').pop()}</p>
                                                <p class="text-zinc-500 text-xs">${reserveLabels[i]}</p>
                                            </div>
                                            <button onclick="event.stopPropagation();removePlayerFromDraft('reserve', ${i})" 
                                                class="w-4 h-4 bg-red-500 rounded-full text-white text-xs opacity-0 group-hover:opacity-100 transition">√ó</button>
                                        </div>
                                    ` : `
                                        <div class="w-16 h-12 rounded-lg border-2 border-dashed border-zinc-600 flex items-center justify-center ${state.draftSlotType === 'reserve' && state.draftSlotIndex === i ? 'border-green-500 bg-green-500/20' : ''}">
                                            <span class="text-zinc-500 text-xs">${reserveLabels[i]}</span>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- T√©cnico -->
                    <div class="bg-orange-500/10 rounded-lg p-3 border border-orange-500/20">
                        <p class="text-orange-400 text-xs mb-2 font-medium">üëî T√âCNICO</p>
                        ${user.coach ? `
                            <div class="flex items-center gap-3 bg-zinc-800 rounded-lg p-2 relative group">
                                <div class="w-12 h-12 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-400 font-bold border-2 border-orange-500">
                                    ${user.coach.name.split(' ').map(n => n[0]).join('').slice(0,2)}
                                </div>
                                <div>
                                    <p class="text-white font-medium">${user.coach.name}</p>
                                    <p class="text-zinc-400 text-xs">${user.coach.team} ${user.coach.country}</p>
                                </div>
                                <button onclick="removeCoachFromDraft()" 
                                    class="absolute top-1 right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs opacity-0 group-hover:opacity-100 transition">√ó</button>
                            </div>
                        ` : `
                            <div class="flex items-center justify-center gap-2 bg-zinc-800/50 rounded-lg p-3 border-2 border-dashed border-orange-500/30">
                                <svg class="w-5 h-5 text-orange-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span class="text-orange-400/50 text-sm">Selecione na aba T√©cnicos</span>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // ==================== HELPERS ====================
        
        // Mapeia posi√ß√µes da API para posi√ß√µes do sistema
        // ==================== SISTEMA DE POSI√á√ïES ====================
        
        // A API retorna posi√ß√µes gen√©ricas:
        // - Goalkeeper ‚Üí GOL
        // - Defender ‚Üí DEF (zagueiros E laterais)
        // - Midfielder ‚Üí MEI (volantes, meias, MC)
        // - Attacker ‚Üí ATA (atacantes E pontas)
        
        // Normaliza posi√ß√£o para as 4 categorias principais
        function normalizePosition(pos) {
            if (!pos) return 'MEI';
            const upper = pos.toUpperCase();
            
            // Goleiro
            if (upper === 'GOL' || upper === 'G' || upper === 'GK' || upper === 'GOLEIRO' || upper === 'GOALKEEPER') {
                return 'GOL';
            }
            
            // Defensor (zagueiros E laterais - todos s√£o DEF)
            if (upper === 'ZAG' || upper === 'DEF' || upper === 'D' || upper === 'DEFENDER' ||
                upper === 'CB' || upper === 'LE' || upper === 'LD' || upper === 'LAT' || 
                upper === 'LB' || upper === 'RB' || upper === 'LWB' || upper === 'RWB') {
                return 'DEF';
            }
            
            // Meio-campo (volantes, meias, MC - todos s√£o MEI)
            if (upper === 'MEI' || upper === 'MC' || upper === 'VOL' || upper === 'M' || upper === 'MID' ||
                upper === 'MIDFIELDER' || upper === 'CM' || upper === 'CDM' || upper === 'CAM' || 
                upper === 'MEIA' || upper === 'VOLANTE') {
                return 'MEI';
            }
            
            // Atacante (atacantes E pontas - todos s√£o ATA)
            if (upper === 'ATA' || upper === 'A' || upper === 'F' || upper === 'ATTACKER' ||
                upper === 'PE' || upper === 'PD' || upper === 'SA' || upper === 'CF' || 
                upper === 'FW' || upper === 'ST' || upper === 'LW' || upper === 'RW' ||
                upper === 'ATACANTE' || upper === 'PONTA') {
                return 'ATA';
            }
            
            return 'MEI'; // Default
        }
        
        // Labels para exibi√ß√£o
        function getPositionLabel(pos) {
            const labels = {
                'GOL': 'Goleiro',
                'DEF': 'Defensor',
                'MEI': 'Meio-campo',
                'ATA': 'Atacante'
            };
            return labels[pos] || pos;
        }
        
        // Verifica se posi√ß√£o do jogador √© compat√≠vel com o slot
        function isPositionCompatible(playerPos, slotPos) {
            const normalizedPlayer = normalizePosition(playerPos);
            return normalizedPlayer === slotPos;
        }
        
        // Posi√ß√µes dos titulares por forma√ß√£o
        function getPositionForSlot(index) {
            if (state.formation === '4-4-2') {
                // 4-4-2: 1 GOL, 4 DEF, 4 MEI, 2 ATA
                const positions = ['GOL', 'DEF', 'DEF', 'DEF', 'DEF', 'MEI', 'MEI', 'MEI', 'MEI', 'ATA', 'ATA'];
                return positions[index];
            }
            // 4-3-3 (padr√£o): 1 GOL, 4 DEF, 3 MEI, 3 ATA
            const positions = ['GOL', 'DEF', 'DEF', 'DEF', 'DEF', 'MEI', 'MEI', 'MEI', 'ATA', 'ATA', 'ATA'];
            return positions[index];
        }
        
        // Labels para exibi√ß√£o dos slots titulares (indica√ß√£o visual)
        function getSlotLabel(index) {
            if (state.formation === '4-4-2') {
                const labels = ['GOL', 'LD', 'ZAG', 'ZAG', 'LE', 'MD', 'VOL', 'VOL', 'ME', 'ATA', 'ATA'];
                return labels[index];
            }
            // 4-3-3
            const labels = ['GOL', 'LD', 'ZAG', 'ZAG', 'LE', 'VOL', 'MEI', 'VOL', 'PD', 'ATA', 'PE'];
            return labels[index];
        }
        
        // Posi√ß√µes visuais no campo por forma√ß√£o
        function getFieldPositions() {
            if (state.formation === '4-4-2') {
                return [
                    { top: '8%', left: '50%' },   // 0: GOL
                    { top: '28%', left: '15%' },  // 1: LD
                    { top: '28%', left: '38%' },  // 2: ZAG
                    { top: '28%', left: '62%' },  // 3: ZAG
                    { top: '28%', left: '85%' },  // 4: LE
                    { top: '52%', left: '15%' },  // 5: MD
                    { top: '52%', left: '38%' },  // 6: VOL
                    { top: '52%', left: '62%' },  // 7: VOL
                    { top: '52%', left: '85%' },  // 8: ME
                    { top: '78%', left: '35%' },  // 9: ATA
                    { top: '78%', left: '65%' },  // 10: ATA
                ];
            }
            // 4-3-3 (padr√£o)
            return [
                { top: '8%', left: '50%' },   // 0: GOL
                { top: '28%', left: '15%' },  // 1: LD
                { top: '28%', left: '38%' },  // 2: ZAG
                { top: '28%', left: '62%' },  // 3: ZAG
                { top: '28%', left: '85%' },  // 4: LE
                { top: '52%', left: '25%' },  // 5: VOL
                { top: '52%', left: '50%' },  // 6: MEI
                { top: '52%', left: '75%' },  // 7: VOL
                { top: '78%', left: '20%' },  // 8: PD
                { top: '78%', left: '50%' },  // 9: ATA
                { top: '78%', left: '80%' },  // 10: PE
            ];
        }

        // Posi√ß√µes dos reservas
        // 0: GOL, 1-2: DEF, 3-4: MEI, 5-6: ATA
        function getReservePosition(index) {
            const positions = ['GOL', 'DEF', 'DEF', 'MEI', 'MEI', 'ATA', 'ATA'];
            return positions[index];
        }
        
        // Labels para exibi√ß√£o dos slots reservas
        function getReserveLabel(index) {
            const labels = ['GOL', 'DEF', 'DEF', 'MEI', 'MEI', 'ATA', 'ATA'];
            return labels[index];
        }

        function canConfirm() {
            return state.starters.every(p => p) && 
                   state.reserves.every(p => p) && 
                   state.coach;
        }

        function calculateUserScore(user) {
            let total = 0;
            Object.entries(user.scores || {}).forEach(([key, round]) => {
                if (key === 'market') {
                    // Somar transa√ß√µes de compra/venda
                    if (round.purchases) {
                        round.purchases.forEach(t => total += t.price);
                    }
                } else {
                    Object.values(round.players || {}).forEach(s => total += s);
                    total += round.coach || 0;
                }
            });
            return total;
        }

        // ==================== EVENT HANDLERS ====================
        function attachEventListeners() {
            const logoUpload = document.getElementById('logoUpload');
            const logoInput = document.getElementById('logoInput');
            
            if (logoUpload && logoInput) {
                logoUpload.onclick = () => logoInput.click();
                logoInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            state.teamLogo = ev.target.result;
                            render();
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }
        }

        window.setAuthMode = function(mode) {
            state.authMode = mode;
            render();
        };
        
        // Recuperar/Resetar senha
        window.recoverPassword = function() {
            const nickname = document.getElementById('nickname').value.trim();
            const password = document.getElementById('password').value;
            const recoverCode = document.getElementById('recoverCode').value.trim();
            const errorEl = document.getElementById('authError');
            
            if (!nickname || nickname.length < 3) {
                errorEl.textContent = '‚ùå Digite seu nickname';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (!password || password.length < 4) {
                errorEl.textContent = '‚ùå Digite uma nova senha (m√≠nimo 4 caracteres)';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (recoverCode !== 'season26') {
                errorEl.textContent = '‚ùå C√≥digo de acesso inv√°lido';
                errorEl.classList.remove('hidden');
                return;
            }
            
            errorEl.textContent = '‚è≥ Atualizando senha...';
            errorEl.classList.remove('hidden');
            
            // Verificar se usu√°rio existe no Firebase
            if (db) {
                db.ref('users/' + nickname).once('value').then(snapshot => {
                    const firebaseUser = snapshot.val();
                    
                    if (!firebaseUser && !state.users[nickname]) {
                        errorEl.textContent = '‚ùå Usu√°rio n√£o encontrado';
                        return;
                    }
                    
                    // Atualizar senha no Firebase
                    db.ref('users/' + nickname + '/password').set(password).then(() => {
                        // Atualizar localmente tamb√©m
                        if (!state.users[nickname]) {
                            state.users[nickname] = firebaseUser || {};
                        }
                        state.users[nickname].password = password;
                        saveState();
                        
                        alert('‚úÖ Senha atualizada com sucesso!\n\nAgora voc√™ pode fazer login.');
                        state.authMode = 'login';
                        render();
                    }).catch(err => {
                        console.error('Erro ao atualizar senha:', err);
                        errorEl.textContent = '‚ùå Erro ao atualizar. Tente novamente.';
                    });
                }).catch(err => {
                    console.error('Erro ao verificar usu√°rio:', err);
                    errorEl.textContent = '‚ùå Erro ao verificar. Tente novamente.';
                });
            } else {
                // Sem Firebase, verificar localmente
                if (!state.users[nickname]) {
                    errorEl.textContent = '‚ùå Usu√°rio n√£o encontrado';
                    return;
                }
                
                state.users[nickname].password = password;
                saveState();
                
                alert('‚úÖ Senha atualizada com sucesso!\n\nAgora voc√™ pode fazer login.');
                state.authMode = 'login';
                render();
            }
        };

        window.handleAuth = function() {
            const nickname = document.getElementById('nickname').value.trim();
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('authError');
            
            if (nickname.length < 3) {
                errorEl.textContent = '‚ùå Nickname deve ter pelo menos 3 caracteres';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (password.length < 4) {
                errorEl.textContent = '‚ùå Senha deve ter pelo menos 4 caracteres';
                errorEl.classList.remove('hidden');
                return;
            }
            
            // Verificar login do ADMIN
            if (nickname === 'admin' && password === 'Mariav2501') {
                state.currentUser = 'admin';
                state.isAdmin = true;
                state.teamName = 'ADMIN';
                state.screen = 'draft';
                
                // Limpar campos tempor√°rios do login
                state.tempNickname = '';
                state.tempPassword = '';
                state.tempAccessCode = '';
                
                saveState();
                render();
                
                // Carregar usu√°rios e jogadores do Firebase para o draft
                listenToUsers();
                listenToDraftChat();
                listenToDraftStatus();
                
                // Carregar jogadores se ainda n√£o carregou
                if (state.players.length === 0) {
                    syncPlayers();
                }
                return;
            }
            
            if (state.authMode === 'register') {
                const accessCode = document.getElementById('accessCode').value;
                if (accessCode !== 'season26') {
                    errorEl.textContent = '‚ùå C√≥digo de acesso inv√°lido';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                if (state.users[nickname]) {
                    errorEl.textContent = '‚ùå Nickname j√° existe';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                // Bloquear cria√ß√£o de conta "admin" por usu√°rios normais
                if (nickname.toLowerCase() === 'admin') {
                    errorEl.textContent = '‚ùå Este nome n√£o est√° dispon√≠vel';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                state.users[nickname] = { password, teamName: '', scores: {} };
                state.currentUser = nickname;
                state.screen = 'createTeam';
                
                // Salvar senha no Firebase imediatamente
                if (db) {
                    db.ref('users/' + nickname + '/password').set(password);
                }
                
                // Limpar campos tempor√°rios do login
                state.tempNickname = '';
                state.tempPassword = '';
                state.tempAccessCode = '';
                
                saveState();
                render();
            } else {
                // Verificar se o usu√°rio existe localmente
                const localUser = state.users[nickname];
                
                // Se o usu√°rio n√£o existe localmente, tentar buscar do Firebase
                if (!localUser && db) {
                    errorEl.textContent = '‚è≥ Verificando...';
                    errorEl.classList.remove('hidden');
                    
                    // Buscar usu√°rio do Firebase
                    db.ref('users/' + nickname).once('value').then(snapshot => {
                        const firebaseUser = snapshot.val();
                        
                        if (!firebaseUser) {
                            errorEl.textContent = '‚ùå Usu√°rio n√£o encontrado';
                            return;
                        }
                        
                        // Verificar senha do Firebase
                        if (firebaseUser.password !== password) {
                            errorEl.textContent = '‚ùå Senha incorreta';
                            return;
                        }
                        
                        // Login bem sucedido - salvar usu√°rio localmente
                        state.users[nickname] = firebaseUser;
                        state.users[nickname].starters = ensureArray(firebaseUser.starters, 11);
                        state.users[nickname].reserves = ensureArray(firebaseUser.reserves, 7);
                        
                        completeLogin(nickname, state.users[nickname]);
                    }).catch(err => {
                        console.error('Erro ao buscar usu√°rio:', err);
                        errorEl.textContent = '‚ùå Erro ao verificar. Tente novamente.';
                    });
                    return;
                }
                
                if (!localUser) {
                    errorEl.textContent = '‚ùå Usu√°rio n√£o encontrado';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                // Verificar senha local ou do Firebase
                const storedPassword = localUser.password;
                if (storedPassword !== password) {
                    // Tentar verificar no Firebase se a senha local n√£o bate
                    if (db) {
                        db.ref('users/' + nickname + '/password').once('value').then(snapshot => {
                            const firebasePassword = snapshot.val();
                            if (firebasePassword === password) {
                                // Atualizar senha local
                                state.users[nickname].password = password;
                                completeLogin(nickname, state.users[nickname]);
                            } else {
                                errorEl.textContent = '‚ùå Senha incorreta';
                                errorEl.classList.remove('hidden');
                            }
                        });
                        return;
                    }
                    
                    errorEl.textContent = '‚ùå Senha incorreta';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                completeLogin(nickname, localUser);
            }
        };
        
        // Fun√ß√£o para completar o login
        function completeLogin(nickname, userData) {
            state.currentUser = nickname;
            state.isAdmin = false;
            state.teamName = userData.teamName || '';
            state.teamLogo = userData.teamLogo || null;
            state.formation = userData.formation || '4-3-3';
            state.starters = ensureArray(userData.starters, 11);
            state.reserves = ensureArray(userData.reserves, 7);
            state.coach = userData.coach || null;
            state.isConfirmed = userData.isConfirmed || false;
            state.scores = userData.scores || {};
            state.screen = userData.teamName ? 'lineup' : 'createTeam';
            
            // Limpar campos tempor√°rios do login
            state.tempNickname = '';
            state.tempPassword = '';
            state.tempAccessCode = '';
            
            saveState();
            render();
            
            // Se foi para lineup, detectar rodada atual
            if (state.screen === 'lineup') {
                setTimeout(async () => {
                    await detectCurrentRound();
                    render();
                    fetchLiveFixtures();
                }, 500);
            }
            
            // Escutar chat do draft
            listenToDraftChat();
            listenToDraftStatus();
            
            // Escutar mensagens privadas
            listenToPrivateMessages();
        }

        window.createTeam = function() {
            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Digite o nome do time!');
                return;
            }
            state.teamName = teamName;
            state.screen = 'lineup';
            saveState();
            render();
            
            // Detectar rodada atual e carregar jogos
            setTimeout(async () => {
                await detectCurrentRound();
                render();
                fetchLiveFixtures();
            }, 500);
        };

        window.openPlayerModal = function(index, type) {
            // Se j√° confirmou, N√ÉO pode mais editar escala√ß√£o - s√≥ substituir
            if (state.isConfirmed) {
                alert('Escala√ß√£o confirmada! Use o bot√£o "Fazer Substitui√ß√£o" para trocar titular por reserva.');
                return;
            }
            state.scrollY = window.scrollY;
            state.modal = 'player';
            state.slotIndex = index;
            state.slotType = type;
            state.filterTeam = '';
            state.searchName = '';
            // Inicializa com a posi√ß√£o sugerida para o slot (apenas para titulares)
            state.filterPosition = type === 'starter' ? getPositionForSlot(index) : '';
            document.body.classList.add('modal-open');
            document.body.style.top = `-${state.scrollY}px`;
            render();
        };

        window.openCoachModal = function() {
            // Se j√° confirmou, n√£o pode mais alterar t√©cnico
            if (state.isConfirmed) {
                alert('Escala√ß√£o confirmada! N√£o √© poss√≠vel alterar o t√©cnico.');
                return;
            }
            state.scrollY = window.scrollY;
            state.modal = 'coach';
            document.body.classList.add('modal-open');
            document.body.style.top = `-${state.scrollY}px`;
            render();
        };

        window.openOffersModal = function() {
            state.scrollY = window.scrollY;
            state.modal = 'offers';
            document.body.classList.add('modal-open');
            document.body.style.top = `-${state.scrollY}px`;
            render();
        };

        // ==================== CONFIGURA√á√ïES ====================
        
        window.openSettingsModal = function() {
            state.scrollY = window.scrollY;
            state.modal = 'settings';
            document.body.classList.add('modal-open');
            document.body.style.top = `-${state.scrollY}px`;
            render();
        };
        
        window.handleSettingsLogoUpload = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    state.teamLogo = ev.target.result;
                    render();
                };
                reader.readAsDataURL(file);
            }
        };
        
        window.removeTeamLogo = function() {
            state.teamLogo = null;
            render();
        };
        
        window.saveSettings = function() {
            const newName = document.getElementById('settingsTeamName').value.trim();
            const newFavoriteTeam = document.getElementById('settingsFavoriteTeam').value;
            const newBio = document.getElementById('settingsBio').value.trim();
            
            if (newName) {
                state.teamName = newName;
            }
            state.favoriteTeam = newFavoriteTeam || null;
            state.userBio = newBio || '';
            
            saveState();
            
            // Salvar no Firebase
            if (db && state.currentUser) {
                db.ref('users/' + state.currentUser).update({
                    favoriteTeam: state.favoriteTeam,
                    userBio: state.userBio
                });
            }
            
            closeModalDirect();
            render();
        };
        
        // ==================== PERFIL E MENSAGENS PRIVADAS ====================
        
        // Contar mensagens n√£o lidas
        function getUnreadMessagesCount() {
            if (!state.privateMessages || !state.currentUser) return 0;
            return state.privateMessages.filter(m => 
                m.to === state.currentUser && !m.read
            ).length;
        }
        
        // Abrir modal de mensagens (lista de conversas)
        window.openMessagesModal = function() {
            console.log('üì¨ Abrindo lista de mensagens');
            
            // Iniciar listener se n√£o estiver ativo
            if (!state.privateMessagesListenerActive) {
                listenToPrivateMessages();
                state.privateMessagesListenerActive = true;
            }
            
            state.modal = 'messagesList';
            render();
        };
        
        // Abrir perfil de usu√°rio
        window.viewProfile = function(nick) {
            state.viewingProfile = nick;
            state.modal = 'profile';
            render();
        };
        
        // Abrir chat privado
        window.openPrivateChat = function(nick) {
            if (!nick) return;
            
            console.log('üí¨ Abrindo chat com:', nick);
            state.selectedChatUser = nick;
            state.modal = 'privateChat';
            
            // Marcar mensagens como lidas
            if (db && state.currentUser) {
                const chatKey = [state.currentUser, nick].sort().join('_');
                state.privateMessages.forEach(m => {
                    if (m.chatKey === chatKey && m.to === state.currentUser && !m.read) {
                        // Marcar como lida no Firebase
                        db.ref('privateMessages').orderByChild('timestamp').equalTo(m.timestamp).once('value', snapshot => {
                            snapshot.forEach(child => {
                                child.ref.update({ read: true });
                            });
                        });
                        m.read = true;
                    }
                });
            }
            
            // Iniciar listener se n√£o estiver ativo
            if (!state.privateMessagesListenerActive) {
                listenToPrivateMessages();
                state.privateMessagesListenerActive = true;
            }
            
            render();
            
            // Scroll para o final e focar no input
            setTimeout(() => {
                const el = document.getElementById('privateChatMessages');
                if (el) el.scrollTop = el.scrollHeight;
                
                const input = document.getElementById('privateMsgInput');
                if (input) input.focus();
            }, 100);
        };
        
        // Enviar mensagem privada
        window.sendPrivateMessage = function() {
            const input = document.getElementById('privateMsgInput');
            if (!input) return;
            
            const text = input.value.trim();
            if (!text || !state.selectedChatUser || !state.currentUser) return;
            
            const chatKey = [state.currentUser, state.selectedChatUser].sort().join('_');
            
            const message = {
                chatKey: chatKey,
                from: state.currentUser,
                to: state.selectedChatUser,
                text: text,
                timestamp: Date.now(),
                read: false
            };
            
            console.log('üì® Enviando mensagem privada:', message);
            
            // Salvar no Firebase
            if (db) {
                db.ref('privateMessages').push(message).then(() => {
                    console.log('‚úÖ Mensagem enviada com sucesso!');
                }).catch(err => {
                    console.error('‚ùå Erro ao enviar mensagem:', err);
                    alert('Erro ao enviar mensagem. Tente novamente.');
                });
            }
            
            input.value = '';
            input.focus();
        };
        
        // Escutar mensagens privadas
        function listenToPrivateMessages() {
            if (!db) {
                console.log('‚ö†Ô∏è Firebase n√£o conectado para mensagens privadas');
                return;
            }
            
            console.log('üëÇ Escutando mensagens privadas...');
            
            // Escutar todas as mensagens
            db.ref('privateMessages').orderByChild('timestamp').limitToLast(500).on('value', (snapshot) => {
                const messages = snapshot.val();
                console.log('üì¨ Mensagens recebidas:', messages ? Object.keys(messages).length : 0);
                
                if (messages && state.currentUser) {
                    // Filtrar apenas mensagens do usu√°rio atual
                    state.privateMessages = Object.values(messages)
                        .filter(m => m && (m.from === state.currentUser || m.to === state.currentUser))
                        .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    
                    console.log('üì© Mensagens do usu√°rio:', state.privateMessages.length);
                } else {
                    state.privateMessages = [];
                }
                
                // Re-render se estiver no chat privado ou lista de mensagens
                if (state.modal === 'privateChat' || state.modal === 'messagesList') {
                    render();
                    setTimeout(() => {
                        const el = document.getElementById('privateChatMessages');
                        if (el) el.scrollTop = el.scrollHeight;
                    }, 100);
                }
            });
        }
        
        // Zerar todas as pontua√ß√µes
        window.zerarPontuacoes = function() {
            if (!confirm('Tem certeza que deseja zerar TODAS as pontua√ß√µes?\n\nIsso vai remover:\n- Pontos de todas as rodadas\n- Transa√ß√µes do mercado\n\nEssa a√ß√£o n√£o pode ser desfeita!')) {
                return;
            }
            
            // Zerar pontua√ß√µes
            state.scores = {};
            
            // Salvar localmente
            saveState();
            
            // Salvar no Firebase
            if (db && state.currentUser) {
                db.ref('users/' + state.currentUser + '/scores').set({});
            }
            
            alert('‚úÖ Pontua√ß√µes zeradas!\n\nTotal: 0 pts');
            closeModalDirect();
            render();
        };

        // Fun√ß√£o para atualizar busca do mercado SEM re-renderizar tudo
        window.updateMarketSearch = function(value) {
            state.marketSearch = value;
            updateMarketList();
        };
        
        // Atualiza apenas a lista de jogadores do mercado
        window.updateMarketList = function() {
            const container = document.getElementById('marketListContainer');
            if (!container) {
                render();
                return;
            }
            
            const userTotal = getTotalScore();
            const marketPlayers = getMarketPlayers();
            
            // Filtrar jogadores do mercado
            let filteredPlayers = marketPlayers;
            if (state.marketFilter && state.marketFilter !== 'all') {
                filteredPlayers = marketPlayers.filter(p => p.position === state.marketFilter);
            }
            if (state.marketSearch) {
                const search = state.marketSearch.toLowerCase();
                filteredPlayers = filteredPlayers.filter(p => 
                    p.name.toLowerCase().includes(search) || 
                    p.team.toLowerCase().includes(search)
                );
            }
            
            // Ordenar por pre√ßo
            filteredPlayers = filteredPlayers.map(p => ({...p, price: getPlayerPrice(p.id)}))
                .sort((a, b) => b.price - a.price);
            
            // Gerar HTML da lista
            let html = '';
            if (filteredPlayers.length === 0) {
                html = `<p class="text-zinc-500 text-center py-8">Nenhum jogador encontrado</p>`;
            } else {
                html = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                        ${filteredPlayers.slice(0, 60).map(p => `
                            <div class="bg-zinc-800/50 rounded-lg p-3 flex items-center gap-3">
                                <img src="${p.photo}" class="w-12 h-12 rounded-lg object-cover"
                                    onerror="this.src='https://via.placeholder.com/48/1a1a1a/ffffff?text=${p.name.charAt(0)}'">
                                <div class="flex-1 min-w-0">
                                    <p class="text-white text-sm font-medium truncate">${p.name}</p>
                                    <p class="text-zinc-500 text-xs truncate">${p.team}</p>
                                    <span class="text-xs px-1.5 py-0.5 bg-zinc-700 text-zinc-400 rounded">${p.position}</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-green-400 font-bold">${p.price}</p>
                                    <p class="text-zinc-600 text-xs">pts</p>
                                    ${p.price <= userTotal ? `
                                        <button onclick="openBuyModal(${p.id})" 
                                            class="mt-1 px-2 py-1 bg-green-500 hover:bg-green-400 text-white text-xs rounded">
                                            Comprar
                                        </button>
                                    ` : `
                                        <span class="text-red-400 text-xs">Sem pts</span>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${filteredPlayers.length > 60 ? `
                        <p class="text-zinc-600 text-center text-sm mt-4">Mostrando 60 de ${filteredPlayers.length}. Use os filtros.</p>
                    ` : ''}
                `;
            }
            
            container.innerHTML = html;
        };

        window.openMarketModal = function() {
            state.scrollY = window.scrollY;
            state.modal = 'market';
            state.marketTab = 'buy';
            state.marketFilter = 'all';
            state.marketSearch = '';
            document.body.classList.add('modal-open');
            document.body.style.top = `-${state.scrollY}px`;
            render();
        };

        // Fun√ß√µes do sistema de compra/venda
        window.openBuyModal = function(playerId) {
            state.buyingPlayerId = playerId;
            state.swapPlayerId = null; // Resetar sele√ß√£o de troca
            state.modal = 'buy';
            render();
        };

        window.executeBuy = function(playerId, slotType, slotIndex) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;
            
            const price = getPlayerPrice(playerId);
            const userTotal = getTotalScore();
            
            if (price > userTotal) {
                alert(`Pontos insuficientes! Voc√™ tem ${userTotal} pts e o jogador custa ${price} pts.`);
                return;
            }
            
            // Deduzir pontos
            if (!state.scores['market']) {
                state.scores['market'] = { players: {}, coach: 0, purchases: [] };
            }
            state.scores['market'].purchases = state.scores['market'].purchases || [];
            state.scores['market'].purchases.push({
                type: 'buy',
                playerId: playerId,
                playerName: player.name,
                price: -price,
                date: new Date().toISOString()
            });
            
            // Adicionar jogador ao time
            if (slotType === 'starter') {
                state.starters[slotIndex] = player;
            } else {
                state.reserves[slotIndex] = player;
            }
            
            saveState();
            state.buyingPlayerId = null;
            state.modal = 'market';
            alert(`${player.name} comprado por ${price} pts!`);
            render();
        };
        
        // Contrata√ß√£o simples: paga o pre√ßo do novo, o antigo sai
        window.executeSwapSimple = function(newPlayerId, oldSlotType, oldSlotIndex) {
            const newPlayer = state.players.find(p => p.id === newPlayerId);
            const oldPlayer = oldSlotType === 'starter' ? state.starters[oldSlotIndex] : state.reserves[oldSlotIndex];
            
            if (!newPlayer || !oldPlayer) return;
            
            const price = getPlayerPrice(newPlayerId);
            const userTotal = getTotalScore();
            
            if (price > userTotal) {
                alert(`Pontos insuficientes! Voc√™ tem ${userTotal} pts e o jogador custa ${price} pts.`);
                return;
            }
            
            // Registrar compra (s√≥ paga pelo novo, n√£o ganha nada pelo antigo)
            if (!state.scores['market']) {
                state.scores['market'] = { players: {}, coach: 0, purchases: [] };
            }
            state.scores['market'].purchases = state.scores['market'].purchases || [];
            state.scores['market'].purchases.push({
                type: 'buy',
                playerId: newPlayerId,
                playerName: newPlayer.name,
                price: -price,
                date: new Date().toISOString()
            });
            
            // Substituir jogador (o novo entra no lugar do antigo)
            if (oldSlotType === 'starter') {
                state.starters[oldSlotIndex] = newPlayer;
            } else {
                state.reserves[oldSlotIndex] = newPlayer;
            }
            
            saveState();
            state.buyingPlayerId = null;
            state.swapPlayerId = null;
            state.modal = 'market';
            
            alert(`${oldPlayer.name} saiu ‚û°Ô∏è ${newPlayer.name} entrou!\nCusto: -${price} pts`);
            render();
        };

        window.confirmSellPlayer = function(slotType, slotIndex) {
            const player = slotType === 'starter' ? state.starters[slotIndex] : state.reserves[slotIndex];
            if (!player) return;
            
            const price = getPlayerPrice(player.id);
            
            if (!confirm(`Vender ${player.name} por ${price} pts?`)) return;
            
            // Adicionar pontos de volta
            if (!state.scores['market']) {
                state.scores['market'] = { players: {}, coach: 0, purchases: [] };
            }
            state.scores['market'].purchases = state.scores['market'].purchases || [];
            state.scores['market'].purchases.push({
                type: 'sell',
                playerId: player.id,
                playerName: player.name,
                price: price,
                date: new Date().toISOString()
            });
            
            // Remover jogador do time
            if (slotType === 'starter') {
                state.starters[slotIndex] = null;
            } else {
                state.reserves[slotIndex] = null;
            }
            
            // Se estava confirmado, desconfirmar pois time est√° incompleto
            if (state.isConfirmed) {
                state.isConfirmed = false;
            }
            
            saveState();
            alert(`${player.name} vendido por ${price} pts!`);
            render();
        };

        window.openMakeOfferModal = function(player) {
            state.selectedPlayerForOffer = player;
            state.modal = 'makeOffer';
            render();
        };

        window.sendOfferToUser = function(targetUser, wantedPlayerId) {
            if (!state.selectedPlayerForOffer) return;
            const wantedPlayer = state.players.find(p => p.id === wantedPlayerId);
            sendOffer(state.currentUser, targetUser, state.selectedPlayerForOffer, wantedPlayer);
            state.modal = null;
            state.selectedPlayerForOffer = null;
            alert('Oferta enviada com sucesso!');
            render();
        };

        window.acceptOffer = function(offerId) {
            acceptOffer(offerId);
            render();
        };

        window.rejectOffer = function(offerId) {
            rejectOffer(offerId);
            render();
        };

        // Fun√ß√µes para visualiza√ß√£o de times
        window.openTeamsModal = function() {
            state.scrollY = window.scrollY;
            state.modal = 'teams';
            document.body.classList.add('modal-open');
            document.body.style.top = `-${state.scrollY}px`;
            render();
        };

        window.viewUserTeam = function(nick) {
            state.viewingUser = nick;
            state.modal = 'viewTeam';
            render();
        };

        // Fun√ß√µes para substitui√ß√µes
        window.openSubstitutionModal = function() {
            state.scrollY = window.scrollY;
            state.modal = 'substitution';
            state.selectedForSubstitution = null;
            state.secondSelection = null;
            state.substitutionMode = false;
            document.body.classList.add('modal-open');
            document.body.style.top = `-${state.scrollY}px`;
            render();
        };

        // Drag and drop handlers
        let dragData = null;
        
        window.handleDragStart = function(event, type, index) {
            dragData = { type, index };
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.5';
        };
        
        window.handleDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        };
        
        window.handleDrop = function(event, targetType, targetIndex) {
            event.preventDefault();
            event.target.style.opacity = '1';
            
            if (!dragData) return;
            
            // Se arrastou de titular para reserva ou vice-versa, fazer a troca
            if (dragData.type !== targetType) {
                let starterIndex, reserveIndex;
                
                if (dragData.type === 'starter') {
                    starterIndex = dragData.index;
                    reserveIndex = targetIndex;
                } else {
                    starterIndex = targetIndex;
                    reserveIndex = dragData.index;
                }
                
                // Trocar
                const temp = state.starters[starterIndex];
                state.starters[starterIndex] = state.reserves[reserveIndex];
                state.reserves[reserveIndex] = temp;
                
                saveState();
                dragData = null;
                alert('Substitui√ß√£o realizada!');
                render();
            }
            
            dragData = null;
        };

        window.selectForSubstitution = function(type, index) {
            // Se n√£o tem primeira sele√ß√£o, esta √© a primeira
            if (!state.selectedForSubstitution) {
                state.selectedForSubstitution = { type, index };
                state.secondSelection = null;
                state.substitutionMode = false;
            } 
            // Se clicou no mesmo que j√° estava selecionado, desselecionar
            else if (state.selectedForSubstitution.type === type && state.selectedForSubstitution.index === index) {
                state.selectedForSubstitution = null;
                state.secondSelection = null;
                state.substitutionMode = false;
            }
            // Se √© da mesma categoria (titular-titular ou reserva-reserva), muda a primeira sele√ß√£o
            else if (state.selectedForSubstitution.type === type) {
                state.selectedForSubstitution = { type, index };
                state.secondSelection = null;
                state.substitutionMode = false;
            }
            // Categorias diferentes (titular-reserva ou reserva-titular), esta √© a segunda sele√ß√£o
            else {
                state.secondSelection = { type, index };
                state.substitutionMode = true;
            }
            render();
        };

        window.confirmSubstitution = function() {
            if (!state.selectedForSubstitution || !state.secondSelection) {
                alert('Selecione um titular E um reserva para trocar.');
                return;
            }
            
            let starterIndex, reserveIndex;
            
            // Determinar qual √© o titular e qual √© o reserva
            if (state.selectedForSubstitution.type === 'starter') {
                starterIndex = state.selectedForSubstitution.index;
                reserveIndex = state.secondSelection.index;
            } else {
                starterIndex = state.secondSelection.index;
                reserveIndex = state.selectedForSubstitution.index;
            }
            
            // Trocar titular e reserva
            const temp = state.starters[starterIndex];
            state.starters[starterIndex] = state.reserves[reserveIndex];
            state.reserves[reserveIndex] = temp;
            
            // Limpar sele√ß√£o
            state.selectedForSubstitution = null;
            state.secondSelection = null;
            state.substitutionMode = false;
            
            // Salvar e fechar modal
            saveState();
            closeModalDirect();
            
            alert('Substitui√ß√£o realizada com sucesso!');
        };

        window.closeModal = function(e) {
            if (e.target === e.currentTarget) {
                document.body.classList.remove('modal-open');
                document.body.style.top = '';
                window.scrollTo(0, state.scrollY || 0);
                state.modal = null;
                state.filterTeam = '';
                state.filterPosition = '';
                state.searchName = '';
                state.viewingUser = null;
                state.selectedForSubstitution = null;
                state.secondSelection = null;
                state.substitutionMode = false;
                render();
            }
        };

        window.selectPlayer = function(playerId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;
            
            if (state.slotType === 'starter') {
                state.starters[state.slotIndex] = player;
            } else {
                state.reserves[state.slotIndex] = player;
            }
            
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, state.scrollY || 0);
            state.modal = null;
            state.filterTeam = '';
            state.filterPosition = '';
            state.searchName = '';
            saveState();
            render();
        };

        window.selectCoach = function(coachId) {
            state.coach = state.coaches.find(c => c.id === coachId);
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, state.scrollY || 0);
            state.modal = null;
            saveState();
            render();
        };

        window.closeModalDirect = function() {
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, state.scrollY || 0);
            state.modal = null;
            state.filterTeam = '';
            state.filterPosition = '';
            state.searchName = '';
            state.viewingUser = null;
            state.selectedForSubstitution = null;
            state.secondSelection = null;
            state.substitutionMode = false;
            render();
        };

        window.confirmLineup = function() {
            if (!canConfirm()) return;
            if (confirm('Confirmar escala√ß√£o? N√£o poder√° mais alterar!')) {
                state.isConfirmed = true;
                saveState();
                render();
            }
        };

        window.changeRound = function(round) {
            state.selectedRound = parseInt(round);
            state.liveFixtures = []; // Limpar jogos antigos
            render();
            fetchLiveFixtures(); // Buscar jogos da nova rodada
        };
        
        window.changeFormation = function(formation) {
            const oldFormation = state.formation;
            state.formation = formation;
            
            // Pegar posi√ß√µes da nova forma√ß√£o
            const newPositions = [];
            for (let i = 0; i < 11; i++) {
                if (formation === '4-4-2') {
                    newPositions.push(['GOL', 'DEF', 'DEF', 'DEF', 'DEF', 'MEI', 'MEI', 'MEI', 'MEI', 'ATA', 'ATA'][i]);
                } else {
                    newPositions.push(['GOL', 'DEF', 'DEF', 'DEF', 'DEF', 'MEI', 'MEI', 'MEI', 'ATA', 'ATA', 'ATA'][i]);
                }
            }
            
            // Separar jogadores atuais por posi√ß√£o
            const safeStarters = ensureArray(state.starters, 11);
            const safeReserves = ensureArray(state.reserves, 7);
            const allPlayers = [...safeStarters.filter(p => p), ...safeReserves.filter(p => p)];
            const playersByPos = {
                'GOL': allPlayers.filter(p => normalizePosition(p.position) === 'GOL'),
                'DEF': allPlayers.filter(p => normalizePosition(p.position) === 'DEF'),
                'MEI': allPlayers.filter(p => normalizePosition(p.position) === 'MEI'),
                'ATA': allPlayers.filter(p => normalizePosition(p.position) === 'ATA')
            };
            
            // Montar novo time titular baseado nas posi√ß√µes da forma√ß√£o
            const newStarters = Array(11).fill(null);
            const usedPlayerIds = new Set();
            
            newPositions.forEach((pos, i) => {
                // Procurar jogador dispon√≠vel para esta posi√ß√£o
                const available = playersByPos[pos].find(p => !usedPlayerIds.has(p.id));
                if (available) {
                    newStarters[i] = available;
                    usedPlayerIds.add(available.id);
                }
            });
            
            // Jogadores restantes v√£o pro banco
            const newReserves = Array(7).fill(null);
            const reservePositions = ['GOL', 'DEF', 'DEF', 'MEI', 'MEI', 'ATA', 'ATA'];
            
            reservePositions.forEach((pos, i) => {
                const available = playersByPos[pos].find(p => !usedPlayerIds.has(p.id));
                if (available) {
                    newReserves[i] = available;
                    usedPlayerIds.add(available.id);
                }
            });
            
            state.starters = newStarters;
            state.reserves = newReserves;
            
            saveState();
            render();
            
            console.log(`‚úÖ Forma√ß√£o alterada: ${oldFormation} ‚Üí ${formation}`);
        };

        window.syncScores = syncRoundScores;
        window.fetchLiveFixtures = fetchLiveFixtures;
        window.detectCurrentRound = detectCurrentRound;
        window.listenToUsers = listenToUsers;

        window.goToRanking = function() {
            state.screen = 'ranking';
            render();
            // Scroll para o final do chat
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }, 100);
        };
        
        // ==================== DRAFT FUNCTIONS ====================
        
        // Adicionar participante ao draft
        window.addDraftParticipant = function() {
            const input = document.getElementById('newParticipantName');
            const name = input.value.trim();
            
            if (!name) {
                alert('Digite o nome do participante!');
                return;
            }
            
            if (name.toLowerCase() === 'admin') {
                alert('Este nome n√£o est√° dispon√≠vel!');
                return;
            }
            
            if (state.users[name]) {
                alert('Este participante j√° existe!');
                return;
            }
            
            // Criar usu√°rio
            state.users[name] = {
                password: 'draft2026',
                teamName: name + ' FC',
                teamLogo: null,
                starters: Array(11).fill(null),
                reserves: Array(7).fill(null),
                coach: null,
                isConfirmed: false,
                scores: {},
                formation: '4-3-3'
            };
            
            // Salvar no Firebase
            saveUserToCloud();
            saveState();
            
            input.value = '';
            alert(`‚úÖ Participante "${name}" adicionado!\nSenha tempor√°ria: draft2026`);
            render();
        };
        
        // Selecionar usu√°rio para adicionar jogadores
        window.selectDraftUser = function(nick) {
            state.selectedDraftUser = nick;
            state.draftSlotType = null;
            state.draftSlotIndex = null;
            render();
        };
        
        // Selecionar slot para adicionar jogador
        window.selectDraftSlot = function(type, index) {
            state.draftSlotType = type;
            state.draftSlotIndex = index;
            render();
        };
        
        // Adicionar jogador ao time do usu√°rio selecionado
        window.addPlayerToDraftUser = function(playerId) {
            if (!state.selectedDraftUser) {
                alert('Selecione um participante primeiro!');
                return;
            }
            
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;
            
            const user = state.users[state.selectedDraftUser];
            if (!user) return;
            
            // Inicializar arrays se necess√°rio (usando ensureArray para garantir que s√£o arrays)
            user.starters = ensureArray(user.starters, 11);
            user.reserves = ensureArray(user.reserves, 7);
            
            const playerPos = normalizePosition(player.position);
            
            // Se tem slot selecionado, usar ele
            if (state.draftSlotType && state.draftSlotIndex !== null) {
                const slotPos = state.draftSlotType === 'starter' 
                    ? getPositionForSlot(state.draftSlotIndex)
                    : getReservePosition(state.draftSlotIndex);
                    
                if (playerPos !== slotPos) {
                    alert(`Posi√ß√£o incompat√≠vel!\nJogador: ${playerPos}\nSlot: ${slotPos}`);
                    return;
                }
                
                if (state.draftSlotType === 'starter') {
                    user.starters[state.draftSlotIndex] = player;
                } else {
                    user.reserves[state.draftSlotIndex] = player;
                }
                
                state.draftSlotType = null;
                state.draftSlotIndex = null;
            } else {
                // Encontrar primeiro slot vazio da posi√ß√£o
                let added = false;
                
                // Tentar titulares primeiro
                for (let i = 0; i < 11; i++) {
                    if (!user.starters[i] && getPositionForSlot(i) === playerPos) {
                        user.starters[i] = player;
                        added = true;
                        break;
                    }
                }
                
                // Se n√£o achou, tentar reservas
                if (!added) {
                    for (let i = 0; i < 7; i++) {
                        if (!user.reserves[i] && getReservePosition(i) === playerPos) {
                            user.reserves[i] = player;
                            added = true;
                            break;
                        }
                    }
                }
                
                if (!added) {
                    alert(`N√£o h√° vagas para ${playerPos} no time!`);
                    return;
                }
            }
            
            // Salvar no Firebase o usu√°rio espec√≠fico
            saveState();
            if (db) {
                db.ref('users/' + state.selectedDraftUser).update({
                    starters: user.starters,
                    reserves: user.reserves
                });
                
                // Registrar o pick no hist√≥rico do draft
                const pickNumber = (state.draftPicks || []).length + 1;
                const pick = {
                    number: pickNumber,
                    userName: state.selectedDraftUser,
                    userTeam: user.teamName || state.selectedDraftUser,
                    userLogo: user.teamLogo || null,
                    player: {
                        id: player.id,
                        name: player.name,
                        photo: player.photo,
                        team: player.team,
                        position: normalizePosition(player.position)
                    },
                    timestamp: Date.now()
                };
                
                db.ref('draftPicks').push(pick);
                console.log('‚úÖ Pick #' + pickNumber + ':', player.name, 'para', state.selectedDraftUser);
            }
            render();
        };
        
        // Adicionar t√©cnico ao time do usu√°rio no draft
        window.addCoachToDraftUser = function(coachId) {
            if (!state.selectedDraftUser) {
                alert('Selecione um participante primeiro!');
                return;
            }
            
            const user = state.users[state.selectedDraftUser];
            if (!user) return;
            
            // Verificar se j√° tem t√©cnico
            if (user.coach) {
                if (!confirm(`${state.selectedDraftUser} j√° tem o t√©cnico ${user.coach.name}.\n\nDeseja substituir?`)) {
                    return;
                }
            }
            
            // Encontrar o t√©cnico
            const coach = TECNICOS_2026.find(c => c.id === coachId);
            if (!coach) {
                alert('T√©cnico n√£o encontrado!');
                return;
            }
            
            // Verificar se t√©cnico j√° foi escolhido por outro usu√°rio
            const otherUserWithCoach = Object.entries(state.users).find(([nick, u]) => 
                nick !== state.selectedDraftUser && u.coach && u.coach.id === coachId
            );
            if (otherUserWithCoach) {
                alert(`Este t√©cnico j√° foi escolhido por @${otherUserWithCoach[0]}!`);
                return;
            }
            
            // Adicionar t√©cnico
            user.coach = coach;
            
            // Salvar no Firebase
            saveState();
            if (db) {
                db.ref('users/' + state.selectedDraftUser).update({
                    coach: coach
                });
                
                // Registrar o pick no hist√≥rico do draft
                const pickNumber = (state.draftPicks || []).length + 1;
                const pick = {
                    number: pickNumber,
                    userName: state.selectedDraftUser,
                    userTeam: user.teamName || state.selectedDraftUser,
                    userLogo: user.teamLogo || null,
                    player: {
                        id: coach.id,
                        name: coach.name,
                        photo: null, // Sem foto para t√©cnicos
                        team: coach.team,
                        position: 'TEC'
                    },
                    isCoach: true,
                    timestamp: Date.now()
                };
                
                db.ref('draftPicks').push(pick);
                console.log('‚úÖ Pick #' + pickNumber + ': üëî', coach.name, 'para', state.selectedDraftUser);
            }
            render();
        };
        
        // Remover jogador do draft
        window.removePlayerFromDraft = function(type, index) {
            if (!state.selectedDraftUser) return;
            
            const user = state.users[state.selectedDraftUser];
            if (!user) return;
            
            // Garantir que s√£o arrays
            user.starters = ensureArray(user.starters, 11);
            user.reserves = ensureArray(user.reserves, 7);
            
            if (type === 'starter') {
                user.starters[index] = null;
            } else {
                user.reserves[index] = null;
            }
            
            // Salvar no Firebase o usu√°rio espec√≠fico
            saveState();
            if (db) {
                db.ref('users/' + state.selectedDraftUser).update({
                    starters: user.starters,
                    reserves: user.reserves
                });
                console.log('üóëÔ∏è Jogador removido do time de', state.selectedDraftUser);
            }
            render();
        };
        
        // Remover t√©cnico do draft
        window.removeCoachFromDraft = function() {
            if (!state.selectedDraftUser) return;
            
            const user = state.users[state.selectedDraftUser];
            if (!user || !user.coach) return;
            
            const coachName = user.coach.name;
            user.coach = null;
            
            // Salvar no Firebase
            saveState();
            if (db) {
                db.ref('users/' + state.selectedDraftUser).update({
                    coach: null
                });
                console.log('üóëÔ∏è T√©cnico', coachName, 'removido do time de', state.selectedDraftUser);
            }
            render();
        };
        
        // ==================== CHAT DO DRAFT ====================
        
        // Enviar mensagem no chat do draft
        window.sendDraftMessage = function() {
            const input = document.getElementById('draftChatInput');
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            if (!db) {
                alert('Erro: Firebase n√£o conectado');
                return;
            }
            
            const message = {
                user: state.currentUser,
                text: text,
                timestamp: Date.now()
            };
            
            db.ref('draftChat').push(message);
            input.value = '';
            console.log('üí¨ Mensagem do draft enviada');
        };
        
        // Escutar mensagens do chat do draft
        function listenToDraftChat() {
            if (!db) return;
            
            db.ref('draftChat').orderByChild('timestamp').limitToLast(200).on('value', (snapshot) => {
                const messages = [];
                snapshot.forEach(child => {
                    messages.push(child.val());
                });
                state.draftChatMessages = messages;
                
                // Re-render se estiver na tela de draft (admin ou usu√°rio)
                if (state.screen === 'draft' || state.screen === 'userDraft' || state.isAdmin) {
                    render();
                    // Scroll para o final em todos os chats poss√≠veis
                    setTimeout(() => {
                        const chatEls = ['draftChatMessages', 'userDraftChatFull'];
                        chatEls.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.scrollTop = el.scrollHeight;
                        });
                    }, 100);
                }
            });
            
            // Escutar picks do draft
            db.ref('draftPicks').orderByChild('timestamp').on('value', (snapshot) => {
                const picks = [];
                snapshot.forEach(child => {
                    picks.push(child.val());
                });
                state.draftPicks = picks;
                
                // Re-render se estiver na tela de draft
                if (state.screen === 'draft' || state.screen === 'userDraft') {
                    render();
                    // Scroll para o √∫ltimo pick
                    setTimeout(() => {
                        const picksEl = document.getElementById('draftPicksList');
                        if (picksEl) picksEl.scrollTop = picksEl.scrollHeight;
                    }, 100);
                }
            });
            
            // Limpar mensagens do draft com mais de 30 dias
            cleanOldDraftChatMessages();
        }
        
        // Limpar mensagens do chat do draft com mais de 30 dias
        function cleanOldDraftChatMessages() {
            if (!db) return;
            
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            
            db.ref('draftChat').orderByChild('timestamp').endAt(thirtyDaysAgo).once('value', (snapshot) => {
                const oldMessages = snapshot.val();
                if (oldMessages) {
                    const updates = {};
                    Object.keys(oldMessages).forEach(key => {
                        updates[key] = null;
                    });
                    db.ref('draftChat').update(updates);
                    console.log('üßπ Limpeza do chat do draft: ' + Object.keys(oldMessages).length + ' mensagens antigas removidas');
                }
            });
        }
        
        // Iniciar/Encerrar Draft
        window.toggleDraft = function() {
            if (!db) {
                alert('Erro: Firebase n√£o conectado');
                return;
            }
            
            if (state.draftStarted) {
                // Encerrar draft
                if (!confirm('üõë Tem certeza que deseja ENCERRAR o Draft?\n\nIsso ir√° notificar todos os participantes.')) {
                    return;
                }
                
                state.draftStarted = false;
                db.ref('draftStatus').set({
                    started: false,
                    endedAt: new Date().toISOString()
                });
                
                // Enviar mensagem no chat
                db.ref('draftChat').push({
                    user: 'ü§ñ Sistema',
                    text: 'üèÅ O DRAFT FOI ENCERRADO! Obrigado a todos pela participa√ß√£o!',
                    timestamp: Date.now(),
                    isSystem: true
                });
                
            } else {
                // Iniciar draft
                if (!confirm('üöÄ Tem certeza que deseja INICIAR o Draft?\n\nTodos os participantes ser√£o notificados!')) {
                    return;
                }
                
                state.draftStarted = true;
                db.ref('draftStatus').set({
                    started: true,
                    startedAt: new Date().toISOString()
                });
                
                // Enviar mensagem no chat
                db.ref('draftChat').push({
                    user: 'ü§ñ Sistema',
                    text: 'üéØ O DRAFT COME√áOU! Boa sorte a todos! üî•',
                    timestamp: Date.now(),
                    isSystem: true
                });
            }
            
            render();
        };
        
        // Escutar status do draft
        function listenToDraftStatus() {
            if (!db) return;
            
            db.ref('draftStatus').on('value', (snapshot) => {
                const status = snapshot.val();
                if (status) {
                    state.draftStarted = status.started || false;
                    
                    // Re-render se estiver na tela de draft
                    if (state.screen === 'draft' || state.screen === 'userDraft') {
                        render();
                    }
                }
            });
        }
        
        // Confirmar todas as escala√ß√µes
        window.confirmAllLineups = function() {
            const users = Object.entries(state.users).filter(([nick, _]) => nick !== 'admin');
            const incompleteUsers = users.filter(([nick, u]) => {
                const starters = ensureArray(u.starters, 11);
                const reserves = ensureArray(u.reserves, 7);
                const totalPlayers = starters.filter(p => p).length + reserves.filter(p => p).length;
                return totalPlayers < 18;
            });
            
            if (incompleteUsers.length > 0) {
                const names = incompleteUsers.map(([nick, _]) => '@' + nick).join(', ');
                if (!confirm(`‚ö†Ô∏è Aten√ß√£o!\n\nOs seguintes times est√£o incompletos:\n${names}\n\nDeseja confirmar mesmo assim?`)) {
                    return;
                }
            }
            
            if (!confirm('‚úÖ Confirmar TODAS as escala√ß√µes?\n\nIsso ir√° marcar todos os times como confirmados e encerrar o Draft.')) {
                return;
            }
            
            // Confirmar todos os usu√°rios
            users.forEach(([nick, user]) => {
                user.isConfirmed = true;
                if (db) {
                    db.ref('users/' + nick).update({ isConfirmed: true });
                }
            });
            
            saveState();
            alert('‚úÖ Todas as escala√ß√µes foram confirmadas!\n\nO Draft foi encerrado com sucesso.');
            render();
        };
        
        // Resetar Draft - apaga todos os picks e times
        window.resetDraft = function() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso vai APAGAR:\n‚Ä¢ Todos os picks realizados\n‚Ä¢ Todos os jogadores dos times\n‚Ä¢ O hist√≥rico do draft\n\nTem certeza?')) {
                return;
            }
            
            if (!confirm('üö® √öLTIMA CONFIRMA√á√ÉO!\n\nEssa a√ß√£o N√ÉO pode ser desfeita.\nDigite "RESETAR" para confirmar.') || prompt('Digite RESETAR para confirmar:') !== 'RESETAR') {
                alert('Opera√ß√£o cancelada.');
                return;
            }
            
            // Limpar picks do Firebase
            if (db) {
                db.ref('draftPicks').remove();
                
                // Limpar times de todos os usu√°rios
                Object.entries(state.users).forEach(([nick, user]) => {
                    if (nick !== 'admin') {
                        db.ref('users/' + nick).update({
                            starters: Array(11).fill(null),
                            reserves: Array(7).fill(null),
                            isConfirmed: false
                        });
                    }
                });
            }
            
            // Limpar state local
            state.draftPicks = [];
            Object.entries(state.users).forEach(([nick, user]) => {
                if (nick !== 'admin') {
                    user.starters = Array(11).fill(null);
                    user.reserves = Array(7).fill(null);
                    user.isConfirmed = false;
                }
            });
            
            saveState();
            alert('‚úÖ Draft resetado com sucesso!\n\nTodos os picks e times foram apagados.');
            render();
        };
        
        // Enviar mensagem no chat do draft (usu√°rios normais)
        window.sendUserDraftMessage = function() {
            const input = document.getElementById('userDraftChatInput');
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            if (!db) {
                alert('Erro: Firebase n√£o conectado');
                return;
            }
            
            const message = {
                user: state.currentUser,
                text: text,
                timestamp: Date.now()
            };
            
            db.ref('draftChat').push(message);
            input.value = '';
            console.log('üí¨ Mensagem do draft enviada pelo usu√°rio');
        };
        
        // Enviar mensagem no chat do draft (tela completa do draft)
        window.sendUserDraftMessageFull = function() {
            const input = document.getElementById('userDraftChatInputFull');
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            if (!db) {
                alert('Erro: Firebase n√£o conectado');
                return;
            }
            
            const message = {
                user: state.currentUser,
                text: text,
                timestamp: Date.now()
            };
            
            db.ref('draftChat').push(message);
            input.value = '';
            
            // Scroll para o final
            setTimeout(() => {
                const chatEl = document.getElementById('userDraftChatFull');
                if (chatEl) chatEl.scrollTop = chatEl.scrollHeight;
            }, 100);
        };

        // Fun√ß√£o para enviar mensagem
        window.sendMessage = function() {
            const input = document.getElementById('chatInput');
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            sendChatMessage(text);
            input.value = '';
            
            // Fechar picker de emojis
            const picker = document.getElementById('teamEmojiPicker');
            if (picker) picker.classList.add('hidden');
        };
        
        // Toggle do seletor de escudos
        window.toggleEmojiPicker = function() {
            const picker = document.getElementById('teamEmojiPicker');
            if (picker) {
                picker.classList.toggle('hidden');
            }
        };
        
        // Inserir escudo no input
        window.insertTeamEmoji = function(teamName, logo) {
            const input = document.getElementById('chatInput');
            if (input) {
                // Adiciona o nome do time com marcador especial
                input.value += `[${teamName}]`;
                input.focus();
            }
            // Fechar picker
            const picker = document.getElementById('teamEmojiPicker');
            if (picker) picker.classList.add('hidden');
        };
        
        // Lista de escudos dos times do Brasileir√£o 2026
        function getTeamEmojis() {
            return [
                { name: 'Flamengo', logo: 'https://media.api-sports.io/football/teams/127.png' },
                { name: 'Palmeiras', logo: 'https://media.api-sports.io/football/teams/121.png' },
                { name: 'S√£o Paulo', logo: 'https://media.api-sports.io/football/teams/126.png' },
                { name: 'Corinthians', logo: 'https://media.api-sports.io/football/teams/131.png' },
                { name: 'Fluminense', logo: 'https://media.api-sports.io/football/teams/124.png' },
                { name: 'Botafogo', logo: 'https://media.api-sports.io/football/teams/120.png' },
                { name: 'Vasco', logo: 'https://media.api-sports.io/football/teams/133.png' },
                { name: 'Gr√™mio', logo: 'https://media.api-sports.io/football/teams/130.png' },
                { name: 'Internacional', logo: 'https://media.api-sports.io/football/teams/119.png' },
                { name: 'Atl√©tico-MG', logo: 'https://media.api-sports.io/football/teams/1062.png' },
                { name: 'Cruzeiro', logo: 'https://media.api-sports.io/football/teams/129.png' },
                { name: 'Santos', logo: 'https://media.api-sports.io/football/teams/128.png' },
                { name: 'Bahia', logo: 'https://media.api-sports.io/football/teams/118.png' },
                { name: 'Vit√≥ria', logo: 'https://media.api-sports.io/football/teams/2129.png' },
                { name: 'Athletico-PR', logo: 'https://media.api-sports.io/football/teams/134.png' },
                { name: 'Coritiba', logo: 'https://media.api-sports.io/football/teams/123.png' },
                { name: 'Bragantino', logo: 'https://media.api-sports.io/football/teams/1193.png' },
                { name: 'Mirassol', logo: 'https://media.api-sports.io/football/teams/7848.png' },
                { name: 'Chapecoense', logo: 'https://media.api-sports.io/football/teams/1196.png' },
                { name: 'Remo', logo: 'https://media.api-sports.io/football/teams/1186.png' }
            ];
        }

        window.logout = function() {
            saveState();
            state.currentUser = null;
            state.teamName = '';
            state.teamLogo = null;
            state.starters = Array(11).fill(null);
            state.reserves = Array(7).fill(null);
            state.coach = null;
            state.isConfirmed = false;
            state.scores = {};
            state.screen = 'auth';
            render();
        };

        window.syncAllData = syncAllData;

        // ==================== INIT ====================
        try {
            loadState();
            if (!state.currentUser) {
                state.screen = 'auth';
            }
            render();
        } catch(e) {
            console.error('Erro na inicializa√ß√£o:', e);
            document.getElementById('root').innerHTML = '<div style="color:white;padding:20px;"><h1>Erro ao carregar</h1><p>' + e.message + '</p><button onclick="localStorage.clear();location.reload()">Limpar dados e recarregar</button></div>';
        }

        // Escutar ofertas do Firebase
        try {
            listenToOffers();
        } catch(e) {
            console.error('Erro ao escutar ofertas:', e);
        }

        // Iniciar contador do mercado (atualiza a cada segundo)
        startMarketCountdown();
        
        // ==================== AUTO-SYNC DI√ÅRIO ====================
        
        // Verifica se j√° sincronizou hoje
        function shouldAutoSync() {
            const lastSync = localStorage.getItem('fantasy_last_sync');
            if (!lastSync) return true;
            
            const lastDate = new Date(lastSync);
            const today = new Date();
            
            // Se √© um dia diferente, precisa sincronizar
            return lastDate.toDateString() !== today.toDateString();
        }
        
        // Sincroniza√ß√£o autom√°tica em background (sem modal)
        async function autoSyncPlayers() {
            console.log('üîÑ Verificando sincroniza√ß√£o autom√°tica...');
            
            if (!shouldAutoSync()) {
                console.log('‚úÖ J√° sincronizou hoje, pulando...');
                return;
            }
            
            console.log('üîÑ Iniciando sincroniza√ß√£o autom√°tica di√°ria...');
            
            try {
                // Buscar times
                let teamsData;
                let usedSeason = SEASON;
                
                try {
                    teamsData = await apiCall(`/teams?league=${LEAGUE_ID}&season=${SEASON}`);
                    if (!teamsData.response || teamsData.response.length === 0) {
                        teamsData = await apiCall(`/teams?league=${LEAGUE_ID}&season=${SEASON_FALLBACK}`);
                        usedSeason = SEASON_FALLBACK;
                    }
                } catch (e) {
                    teamsData = await apiCall(`/teams?league=${LEAGUE_ID}&season=${SEASON_FALLBACK}`);
                    usedSeason = SEASON_FALLBACK;
                }

                if (!teamsData.response || teamsData.response.length === 0) {
                    console.log('‚ùå Auto-sync: Nenhum time encontrado');
                    return;
                }

                state.teams = teamsData.response.map(t => ({
                    id: t.team.id,
                    name: t.team.name,
                    logo: t.team.logo
                }));

                console.log(`‚úÖ Auto-sync: ${state.teams.length} times encontrados`);

                // Buscar jogadores de cada time
                const allPlayers = [];
                
                for (let i = 0; i < state.teams.length; i++) {
                    const team = state.teams[i];
                    
                    try {
                        let squadData = await apiCall(`/players/squads?team=${team.id}`);
                        
                        if (squadData.response && squadData.response[0]?.players && squadData.response[0].players.length > 0) {
                            squadData.response[0].players.forEach(p => {
                                allPlayers.push({
                                    id: p.id,
                                    name: p.name,
                                    photo: p.photo || `https://media.api-sports.io/football/players/${p.id}.png`,
                                    position: translatePosition(p.position),
                                    team: team.name,
                                    teamId: team.id,
                                    teamLogo: team.logo,
                                    number: p.number
                                });
                            });
                        }
                        
                        // Delay para n√£o exceder rate limit
                        await new Promise(r => setTimeout(r, 500));
                        
                    } catch (e) {
                        console.log(`‚ö†Ô∏è Auto-sync: Erro ao carregar ${team.name}`);
                    }
                }

                if (allPlayers.length > 0) {
                    state.players = allPlayers;
                    savePlayers();
                    
                    // Salvar data da √∫ltima sincroniza√ß√£o
                    localStorage.setItem('fantasy_last_sync', new Date().toISOString());
                    
                    console.log(`üéâ Auto-sync completo! ${allPlayers.length} jogadores carregados`);
                    
                    // Notificar usu√°rio discretamente
                    if (state.screen === 'lineup') {
                        render(); // Atualiza a tela se estiver na escala√ß√£o
                    }
                }
                
            } catch (e) {
                console.log('‚ùå Auto-sync erro:', e.message);
            }
        }

        // Sincronizar jogadores automaticamente se n√£o tiver OU se precisa atualizar
        if (state.players.length === 0) {
            setTimeout(() => {
                syncAllData();
            }, 1000);
        } else {
            // Verificar se precisa atualizar (1x por dia)
            setTimeout(() => {
                autoSyncPlayers();
            }, 3000);
        }

        // Atualizar pontua√ß√£o automaticamente a cada 5 minutos se confirmado
        setInterval(() => {
            if (state.isConfirmed && !state.isUpdatingScores) {
                syncRoundScores();
            }
        }, 5 * 60 * 1000); // 5 minutos

        // Primeira atualiza√ß√£o de pontua√ß√£o ao carregar
        setTimeout(() => {
            if (state.isConfirmed) {
                syncRoundScores();
            }
        }, 3000);

        // Carregar jogos da rodada ao iniciar - AUTOM√ÅTICO
        setTimeout(async () => {
            // Primeiro detectar a rodada atual
            await detectCurrentRound();
            render();
            // Depois buscar os jogos SEMPRE
            await fetchLiveFixtures();
        }, 1500);

        // Atualizar PONTUA√á√ÉO a cada 5 MINUTOS (placar n√£o atualiza auto - economia de requisi√ß√µes)
        // Usu√°rio pode atualizar placar manualmente clicando no bot√£o
        setInterval(() => {
            if (state.screen === 'lineup' && state.isConfirmed && !state.isUpdatingScores) {
                // Verificar se tem jogos ao vivo para atualizar pontua√ß√£o
                const hasLive = state.liveFixtures && state.liveFixtures.some(f => {
                    if (!f || !f.fixture || !f.fixture.status) return false;
                    const status = f.fixture.status.short;
                    return ['1H', '2H', 'HT', 'ET', 'BT', 'P', 'INT', 'LIVE', 'FT'].includes(status);
                });
                
                if (hasLive) {
                    console.log('üìä Atualizando pontua√ß√£o...');
                    syncRoundScores();
                }
            }
        }, 5 * 60 * 1000); // 5 minutos
    </script>
</body>
</html>
